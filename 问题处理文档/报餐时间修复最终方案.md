# æŠ¥é¤æ—¶é—´ä¿®å¤æœ€ç»ˆæ–¹æ¡ˆ

## ðŸŽ¯ é—®é¢˜ç¡®è®¤

åŸºäºŽå‰ç«¯å¼€å‘äººå‘˜çš„ç²¾ç¡®åˆ†æžï¼Œæˆ‘ä»¬ç¡®è®¤äº†é—®é¢˜çš„æ ¹æœ¬åŽŸå› ï¼š

### å‰ç«¯å‘é€çš„æ•°æ®æ ¼å¼
```javascript
{
  "date": "2025-09-11",           // ç”¨é¤æ—¥æœŸï¼ˆå­—ç¬¦ä¸²ï¼‰
  "mealType": "dinner",           // é¤æ¬¡ç±»åž‹
  "memberIds": ["user1"],         // æˆå‘˜IDåˆ—è¡¨
  "remark": ""                    // å¤‡æ³¨
}
```

**å…³é”®å‘çŽ°**ï¼šå‰ç«¯åªå‘é€æ—¥æœŸå­—ç¬¦ä¸²ï¼Œæ²¡æœ‰å‘é€å…·ä½“çš„æ—¶é—´æˆ³ï¼

### åŽç«¯å¤„ç†é—®é¢˜
1. **æŽ¥æ”¶è¯·æ±‚**ï¼šèŽ·å– `date: "2025-09-11"`
2. **ç”Ÿæˆæ—¶é—´**ï¼šä½¿ç”¨æœåŠ¡å™¨å½“å‰æ—¶é—´ä½œä¸º `registerTime`
3. **å­˜å‚¨é”™è¯¯**ï¼šé”™è¯¯åœ°å°†æœåŠ¡å™¨æœ¬åœ°æ—¶é—´å­˜å‚¨ä¸ºUTCæ—¶é—´

### é—®é¢˜ç¤ºä¾‹
- **ç”¨æˆ·æŠ¥é¤æ—¶é—´**ï¼š17:18ï¼ˆåŒ—äº¬æ—¶é—´ï¼‰
- **æœåŠ¡å™¨æ—¶é—´**ï¼š17:18ï¼ˆæœ¬åœ°æ—¶é—´ï¼‰
- **é”™è¯¯å­˜å‚¨**ï¼š`2025-09-11T17:18:00.000Z`ï¼ˆå½“ä½œUTCæ—¶é—´ï¼‰
- **æ­£ç¡®å­˜å‚¨**ï¼š`2025-09-11T09:18:00.000Z`ï¼ˆçœŸæ­£çš„UTCæ—¶é—´ï¼‰

## âœ… ä¿®å¤éªŒè¯ç»“æžœ

### æµ‹è¯•ç»“æžœ
```
ðŸ“‹ æµ‹è¯•ç”¨ä¾‹1ï¼šç”¨æˆ·17:18æŠ¥é¤
ç”¨æˆ·å®žé™…æŠ¥é¤æ—¶é—´: 2025-09-11 17:18:00
ä¿®å¤å‰é”™è¯¯å­˜å‚¨: 2025-09-11T17:18:00.000Z
ä¿®å¤å‰å‰ç«¯æ˜¾ç¤º: 2025-09-12 01:18:00 (é”™è¯¯: ç›¸å·®16å°æ—¶)
ä¿®å¤åŽæ­£ç¡®å­˜å‚¨: 2025-09-11T09:18:00.000Z
ä¿®å¤åŽå‰ç«¯æ˜¾ç¤º: 2025-09-11 17:18:00 (æ­£ç¡®: å®Œå…¨ä¸€è‡´)
âœ… ç²¾ç¡®ä¿®å¤æˆåŠŸï¼æ—¶é—´æ˜¾ç¤ºæ­£ç¡®
```

## ðŸ› ï¸ å®Œæ•´ä¿®å¤æ–¹æ¡ˆ

### 1. åŽç«¯ä»£ç ä¿®å¤

#### 1.1 ä¿®å¤æŠ¥é¤æœåŠ¡
```javascript
// services/diningService.js
async submitDeptOrder(userId, date, mealType, memberIds, remark, db) {
  try {
    // 1. éªŒè¯æŠ¥é¤æ—¥æœŸ
    const today = moment().tz('Asia/Shanghai').format('YYYY-MM-DD');
    if (moment(date).isBefore(today)) {
      throw new Error('ä¸èƒ½ä¸ºè¿‡åŽ»çš„æ—¥æœŸæŠ¥é¤');
    }
    
    // 2. æ­£ç¡®å¤„ç†æŠ¥é¤æ—¶é—´
    const now = moment().tz('Asia/Shanghai'); // èŽ·å–å½“å‰åŒ—äº¬æ—¶é—´
    const utcNow = now.utc().toDate(); // è½¬æ¢ä¸ºUTCæ—¶é—´ç”¨äºŽå­˜å‚¨
    
    // 3. åˆ›å»ºè®¢å•æ—¶ä½¿ç”¨æ­£ç¡®çš„æ—¶é—´
    await db.execute(
      `INSERT INTO dining_orders 
       (_id, deptId, deptName, registrantId, userId, userName, memberIds, memberNames, memberCount, 
        diningDate, mealType, status, diningStatus, remark, registerTime, createTime, updateTime)
       VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, 'pending', 'ordered', ?, ?, ?, NOW())`,
      [
        orderId,
        registrant.departmentId,
        registrant.department,
        userId,
        userId,
        registrant.nickName,
        JSON.stringify(memberIds),
        JSON.stringify(memberNames),
        memberIds.length,
        date,
        mealType,
        remark || '',
        utcNow, // âœ… æ­£ç¡®çš„UTCæ—¶é—´
        utcNow, // âœ… æ­£ç¡®çš„UTCæ—¶é—´
        utcNow  // âœ… æ­£ç¡®çš„UTCæ—¶é—´
      ]
    );
  }
}
```

#### 1.2 ä¿®å¤ç¡®è®¤å°±é¤æœåŠ¡
```javascript
// services/diningConfirmationService.js
const moment = require('moment-timezone'); // âœ… ä½¿ç”¨æ”¯æŒæ—¶åŒºçš„moment

async confirmDiningManually(userId, orderId, confirmationType = 'manual', db) {
  // ...
  const now = moment().tz('Asia/Shanghai'); // âœ… åŒ—äº¬æ—¶é—´
  const utcNow = now.utc().toDate(); // âœ… è½¬æ¢ä¸ºUTCæ—¶é—´å­˜å‚¨
  
  await connection.execute(
    `UPDATE dining_orders 
     SET diningStatus = 'dined', 
         actualDiningTime = ?,
         updateTime = NOW()
     WHERE _id = ?`,
    [utcNow, orderId] // âœ… å­˜å‚¨UTCæ—¶é—´
  );
}
```

### 2. åŽ†å²æ•°æ®ä¿®å¤

#### 2.1 è¿è¡Œç²¾ç¡®ä¿®å¤è„šæœ¬
```bash
# è®¾ç½®çŽ¯å¢ƒå˜é‡
export DB_HOST=localhost
export DB_USER=root
export DB_PASSWORD=your_password
export DB_NAME=dining_system

# è¿è¡Œç²¾ç¡®ä¿®å¤è„šæœ¬
node fix_historical_time_data_precise.js
```

#### 2.2 ä¿®å¤é€»è¾‘
```javascript
// è¯†åˆ«éœ€è¦ä¿®å¤çš„æ•°æ®ï¼šUTCå°æ—¶åœ¨6-23ä¹‹é—´çš„è®°å½•
const wrongTime = new Date(record.registerTime);
const hour = wrongTime.getUTCHours();

if (hour >= 6 && hour <= 23) {
  // å°†é”™è¯¯çš„UTCæ—¶é—´å‡åŽ»8å°æ—¶ï¼ˆåŒ—äº¬æ—¶é—´æ¯”UTCå¿«8å°æ—¶ï¼‰
  const correctTime = moment(wrongTime).subtract(8, 'hours').utc().toDate();
  
  await connection.execute(
    `UPDATE dining_orders 
     SET registerTime = ? 
     WHERE _id = ?`,
    [correctTime.toISOString(), record._id]
  );
}
```

### 3. æ—¶é—´å¤„ç†å·¥å…·ç±»

#### 3.1 ä½¿ç”¨ç»Ÿä¸€çš„æ—¶é—´å·¥å…·
```javascript
// utils/timeUtils.js
class TimeUtils {
  // èŽ·å–å½“å‰åŒ—äº¬æ—¶é—´
  static getBeijingTime() {
    return moment().tz('Asia/Shanghai');
  }

  // å°†åŒ—äº¬æ—¶é—´è½¬æ¢ä¸ºUTCæ—¶é—´ç”¨äºŽå­˜å‚¨
  static toUTCForStorage(beijingTime) {
    if (typeof beijingTime === 'string') {
      return moment.tz(beijingTime, 'Asia/Shanghai').utc().toDate();
    }
    return moment(beijingTime).tz('Asia/Shanghai').utc().toDate();
  }

  // å°†UTCæ—¶é—´è½¬æ¢ä¸ºåŒ—äº¬æ—¶é—´ç”¨äºŽæ˜¾ç¤º
  static toBeijingForDisplay(utcTime) {
    return moment(utcTime).tz('Asia/Shanghai').format('YYYY-MM-DD HH:mm:ss');
  }
}
```

## ðŸ“‹ ä¿®å¤æ­¥éª¤

### ç¬¬ä¸€æ­¥ï¼šå®‰è£…ä¾èµ–
```bash
npm install moment-timezone
```

### ç¬¬äºŒæ­¥ï¼šä¿®å¤ä»£ç æ–‡ä»¶
1. **ä¿®å¤ `services/diningService.js`**
2. **ä¿®å¤ `services/diningServiceEnhanced.js`**
3. **ä¿®å¤ `services/diningConfirmationService.js`**
4. **ç¡®ä¿ `services/qrScanService.js` ä½¿ç”¨æ­£ç¡®çš„æ—¶åŒºå¤„ç†**

### ç¬¬ä¸‰æ­¥ï¼šè¿è¡ŒåŽ†å²æ•°æ®ä¿®å¤
```bash
node fix_historical_time_data_precise.js
```

### ç¬¬å››æ­¥ï¼šéªŒè¯ä¿®å¤æ•ˆæžœ
```bash
node test_time_fix_precise.js
```

## ðŸŽ¯ ä¿®å¤æ•ˆæžœ

### ä¿®å¤å‰
- ç”¨æˆ·17:18æŠ¥é¤
- å­˜å‚¨ä¸º `2025-09-11T17:18:00.000Z`ï¼ˆé”™è¯¯ï¼‰
- å‰ç«¯æ˜¾ç¤º09:18ï¼ˆé”™è¯¯ï¼‰

### ä¿®å¤åŽ
- ç”¨æˆ·17:18æŠ¥é¤
- å­˜å‚¨ä¸º `2025-09-11T09:18:00.000Z`ï¼ˆæ­£ç¡®ï¼‰
- å‰ç«¯æ˜¾ç¤º17:18ï¼ˆæ­£ç¡®ï¼‰

## âš ï¸ æ³¨æ„äº‹é¡¹

1. **å¤‡ä»½æ•°æ®**ï¼šä¿®å¤å‰å¿…é¡»å¤‡ä»½æ•°æ®åº“
2. **æµ‹è¯•çŽ¯å¢ƒ**ï¼šå»ºè®®å…ˆåœ¨æµ‹è¯•çŽ¯å¢ƒéªŒè¯
3. **é€æ­¥éƒ¨ç½²**ï¼šå¯ä»¥åˆ†æ­¥éª¤éƒ¨ç½²ä¿®å¤
4. **ç›‘æŽ§å‘Šè­¦**ï¼šä¿®å¤åŽéœ€è¦ç›‘æŽ§æ—¶é—´ç›¸å…³åŠŸèƒ½
5. **ç²¾ç¡®è¯†åˆ«**ï¼šä¿®å¤è„šæœ¬ä¼šç²¾ç¡®è¯†åˆ«éœ€è¦ä¿®å¤çš„è®°å½•ï¼Œé¿å…è¯¯ä¿®å¤

## ðŸ“ æ€»ç»“

è¿™ä¸ªæœ€ç»ˆä¿®å¤æ–¹æ¡ˆåŸºäºŽå‰ç«¯å¼€å‘äººå‘˜çš„ç²¾ç¡®åˆ†æžï¼Œè§£å†³äº†ä»¥ä¸‹æ ¸å¿ƒé—®é¢˜ï¼š

1. **é—®é¢˜è¯†åˆ«**ï¼šå‰ç«¯åªå‘é€æ—¥æœŸå­—ç¬¦ä¸²ï¼ŒåŽç«¯ä½¿ç”¨æœåŠ¡å™¨æ—¶é—´
2. **æ—¶åŒºå¤„ç†**ï¼šæ­£ç¡®å°†åŒ—äº¬æ—¶é—´è½¬æ¢ä¸ºUTCæ—¶é—´å­˜å‚¨
3. **åŽ†å²æ•°æ®**ï¼šç²¾ç¡®è¯†åˆ«å’Œä¿®å¤é”™è¯¯çš„æ—¶é—´è®°å½•
4. **éªŒè¯æœºåˆ¶**ï¼šæä¾›å®Œæ•´çš„æµ‹è¯•å’ŒéªŒè¯æ–¹æ¡ˆ

ä¿®å¤å®ŒæˆåŽï¼ŒæŠ¥é¤æ—¶é—´å°†æ­£ç¡®æ˜¾ç¤ºï¼Œå½»åº•è§£å†³æ—¶é—´ç›¸å·®8å°æ—¶çš„é—®é¢˜ã€‚

## ðŸ”§ æ–‡ä»¶æ¸…å•

- `åŽç«¯æ—¶é—´å­˜å‚¨ç²¾ç¡®ä¿®å¤æ–¹æ¡ˆ.md` - è¯¦ç»†ä¿®å¤æ–¹æ¡ˆ
- `fix_historical_time_data_precise.js` - ç²¾ç¡®æ•°æ®ä¿®å¤è„šæœ¬
- `test_time_fix_precise.js` - ç²¾ç¡®æµ‹è¯•è„šæœ¬
- `utils/timeUtils.js` - æ—¶é—´å¤„ç†å·¥å…·ç±»
- `æŠ¥é¤æ—¶é—´ä¿®å¤æœ€ç»ˆæ–¹æ¡ˆ.md` - æœ¬æ€»ç»“æ–‡æ¡£

æ‰€æœ‰æ–‡ä»¶éƒ½å·²å‡†å¤‡å°±ç»ªï¼Œå¯ä»¥ç›´æŽ¥ç”¨äºŽä¿®å¤ç”Ÿäº§çŽ¯å¢ƒçš„æ—¶é—´é—®é¢˜ã€‚
