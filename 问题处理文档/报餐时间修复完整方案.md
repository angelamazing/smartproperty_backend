# æŠ¥é¤æ—¶é—´ä¿®å¤å®Œæ•´æ–¹æ¡ˆ

## ðŸŽ¯ é—®é¢˜åˆ†æž

### å½“å‰é—®é¢˜çŽ°è±¡
- **ç”¨æˆ·å®žé™…æŠ¥é¤æ—¶é—´**ï¼š17:18ï¼ˆåŒ—äº¬æ—¶é—´ï¼‰
- **åŽç«¯å­˜å‚¨çš„UTCæ—¶é—´**ï¼š`2025-09-11T01:19:01.000Z`
- **å‰ç«¯æ˜¾ç¤ºæ—¶é—´**ï¼š09:19ï¼ˆåŒ—äº¬æ—¶é—´ï¼‰

### é—®é¢˜æ ¹æº
1. **æ—¶åŒºå¤„ç†ä¸ä¸€è‡´**ï¼šåŽç«¯æ²¡æœ‰æ­£ç¡®å¤„ç†ç”¨æˆ·æœ¬åœ°æ—¶é—´åˆ°UTCæ—¶é—´çš„è½¬æ¢
2. **æ•°æ®åº“å­˜å‚¨é”™è¯¯**ï¼šç›´æŽ¥å­˜å‚¨ç”¨æˆ·ä¼ å…¥çš„æ—¶é—´ï¼Œæ²¡æœ‰è¿›è¡Œæ—¶åŒºè½¬æ¢
3. **ä¸šåŠ¡é€»è¾‘æ··ä¹±**ï¼šé¤æ¬¡åˆ¤æ–­åŸºäºŽé”™è¯¯çš„æ—¶é—´

## ðŸ› ï¸ ä¿®å¤æ–¹æ¡ˆ

### 1. ä¿®å¤æŠ¥é¤æœåŠ¡æ—¶é—´å¤„ç†

#### 1.1 ä¿®å¤ `diningService.js` ä¸­çš„æ—¶é—´å¤„ç†

```javascript
// ä¿®å¤å‰çš„é—®é¢˜ä»£ç 
const today = moment().tz('Asia/Shanghai').format('YYYY-MM-DD');
if (moment(date).isBefore(today)) {
  throw new Error('ä¸èƒ½ä¸ºè¿‡åŽ»çš„æ—¥æœŸæŠ¥é¤');
}

// ä¿®å¤åŽçš„æ­£ç¡®ä»£ç 
const today = moment().tz('Asia/Shanghai').format('YYYY-MM-DD');
if (moment(date).isBefore(today)) {
  throw new Error('ä¸èƒ½ä¸ºè¿‡åŽ»çš„æ—¥æœŸæŠ¥é¤');
}

// åœ¨åˆ›å»ºè®¢å•æ—¶ï¼Œæ·»åŠ æ­£ç¡®çš„æ—¶é—´è®°å½•
const now = moment().tz('Asia/Shanghai'); // åŒ—äº¬æ—¶é—´
const utcNow = now.utc().toDate(); // è½¬æ¢ä¸ºUTCæ—¶é—´å­˜å‚¨

await db.execute(
  `INSERT INTO dining_orders 
   (_id, deptId, deptName, registrantId, userId, userName, memberIds, memberNames, memberCount, 
    diningDate, mealType, status, diningStatus, remark, registerTime, createTime, updateTime)
   VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, 'pending', 'ordered', ?, ?, NOW(), NOW())`,
  [
    orderId,
    registrant.departmentId,
    registrant.department,
    userId,
    userId,
    registrant.nickName,
    JSON.stringify(memberIds),
    JSON.stringify(memberNames),
    memberIds.length,
    date,
    mealType,
    remark || '',
    utcNow, // å­˜å‚¨UTCæ—¶é—´
    utcNow  // å­˜å‚¨UTCæ—¶é—´
  ]
);
```

#### 1.2 ä¿®å¤ `diningServiceEnhanced.js` ä¸­çš„æ—¶é—´å¤„ç†

```javascript
// ä¿®å¤åŽçš„ INSERT è¯­å¥
INSERT INTO dining_orders (
  _id, menuId, deptId, deptName, registrantId, registrantName,
  userId, userName, memberIds, memberNames, memberCount, 
  diningDate, mealType, status, diningStatus, totalAmount, 
  remark, registerTime, createTime, updateTime
) VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, NOW(), NOW())

// ä¿®å¤åŽçš„å‚æ•°æ˜ å°„
const now = moment().tz('Asia/Shanghai'); // åŒ—äº¬æ—¶é—´
const utcNow = now.utc().toDate(); // è½¬æ¢ä¸ºUTCæ—¶é—´å­˜å‚¨

[
  orderId,
  menu._id,
  adminInfo.departmentId,
  adminInfo.departmentName,
  adminUserId,           // registrantId
  adminInfo.nickName,    // registrantName
  adminUserId,           // userId âœ… æ–°å¢ž
  adminInfo.nickName,    // userName âœ… æ–°å¢ž
  JSON.stringify(memberIds),
  JSON.stringify(memberNames),
  memberIds.length,
  orderData.date,
  orderData.mealType,
  'confirmed',
  'ordered',             // diningStatus âœ… æ–°å¢ž
  totalAmount,
  orderData.remark || '',
  utcNow,                // registerTime âœ… æ–°å¢ž
  utcNow                 // createTime âœ… æ–°å¢ž
]
```

### 2. ä¿®å¤ç¡®è®¤å°±é¤æœåŠ¡æ—¶é—´å¤„ç†

#### 2.1 ä¿®å¤ `diningConfirmationService.js` ä¸­çš„æ—¶åŒºå¤„ç†

```javascript
// ä¿®å¤å‰çš„é—®é¢˜ä»£ç 
const moment = require('moment'); // âŒ æ²¡æœ‰æ—¶åŒºæ”¯æŒ

// ä¿®å¤åŽçš„æ­£ç¡®ä»£ç 
const moment = require('moment-timezone'); // âœ… ä½¿ç”¨æ”¯æŒæ—¶åŒºçš„moment

// ä¿®å¤æ—¶é—´æ£€æŸ¥é€»è¾‘
const diningDate = moment(order.diningDate).tz('Asia/Shanghai');
const now = moment().tz('Asia/Shanghai');  // âœ… ä½¿ç”¨åŒ—äº¬æ—¶é—´

// ä¿®å¤æ—¶é—´è®°å½•é€»è¾‘
const actualDiningTime = now.format('YYYY-MM-DD HH:mm:ss');  // âœ… åŒ—äº¬æ—¶é—´
const utcActualDiningTime = now.utc().toDate(); // âœ… è½¬æ¢ä¸ºUTCæ—¶é—´å­˜å‚¨

await connection.execute(
  `UPDATE dining_orders 
   SET diningStatus = 'dined', 
       actualDiningTime = ?,
       updateTime = NOW()
   WHERE _id = ?`,
  [utcActualDiningTime, orderId] // âœ… å­˜å‚¨UTCæ—¶é—´
);
```

### 3. ä¿®å¤æ‰«ç æœåŠ¡æ—¶é—´å¤„ç†

#### 3.1 ç¡®ä¿æ‰«ç æœåŠ¡ä½¿ç”¨æ­£ç¡®çš„æ—¶åŒºå¤„ç†

```javascript
// åœ¨ qrScanService.js ä¸­ç¡®ä¿æ­£ç¡®çš„æ—¶é—´å¤„ç†
const beijingScanTime = moment(scanTime).tz('Asia/Shanghai');
const mealType = this.getMealTypeByTime(beijingScanTime.toDate());
const diningDate = beijingScanTime.format('YYYY-MM-DD');

// å­˜å‚¨UTCæ—¶é—´åˆ°æ•°æ®åº“
const utcScanTime = moment(scanTime).utc().toDate();
await connection.execute(`
  INSERT INTO dining_registrations 
  (_id, userId, userName, qrCodeId, qrCode, scanTime, mealType, diningDate, orderId, status)
  VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, 'success')
`, [
  registrationId,
  userId,
  userInfo.nickName,
  qrCodeInfo._id,
  qrCode,
  utcScanTime,  // âœ… å­˜å‚¨UTCæ—¶é—´
  mealType,
  diningDate,
  orderInfo._id
]);
```

### 4. åŽ†å²æ•°æ®ä¿®å¤è„šæœ¬

#### 4.1 åˆ›å»ºæ•°æ®ä¿®å¤è„šæœ¬

```javascript
// fix_historical_time_data.js
const mysql = require('mysql2/promise');
const moment = require('moment-timezone');

async function fixHistoricalTimeData() {
  let connection;
  try {
    // è¿žæŽ¥æ•°æ®åº“
    connection = await mysql.createConnection({
      host: process.env.DB_HOST || 'localhost',
      user: process.env.DB_USER || 'root',
      password: process.env.DB_PASSWORD || '',
      database: process.env.DB_NAME || 'dining_system',
      timezone: '+00:00' // ç¡®ä¿ä½¿ç”¨UTCæ—¶åŒº
    });

    console.log('å¼€å§‹ä¿®å¤åŽ†å²æ—¶é—´æ•°æ®...');

    // 1. ä¿®å¤æŠ¥é¤è®¢å•æ—¶é—´
    await fixDiningOrdersTime(connection);
    
    // 2. ä¿®å¤ç¡®è®¤å°±é¤æ—¶é—´
    await fixDiningConfirmationsTime(connection);
    
    // 3. ä¿®å¤æ‰«ç ç™»è®°æ—¶é—´
    await fixDiningRegistrationsTime(connection);

    console.log('åŽ†å²æ—¶é—´æ•°æ®ä¿®å¤å®Œæˆï¼');
  } catch (error) {
    console.error('ä¿®å¤åŽ†å²æ—¶é—´æ•°æ®å¤±è´¥:', error);
  } finally {
    if (connection) {
      await connection.end();
    }
  }
}

async function fixDiningOrdersTime(connection) {
  try {
    console.log('ä¿®å¤æŠ¥é¤è®¢å•æ—¶é—´...');
    
    // æŸ¥æ‰¾éœ€è¦ä¿®å¤çš„è®¢å•ï¼ˆæ—¶é—´çœ‹èµ·æ¥åƒæœ¬åœ°æ—¶é—´ä½†å­˜å‚¨ä¸ºUTCçš„ï¼‰
    const [orders] = await connection.execute(`
      SELECT _id, registerTime, createTime, actualDiningTime
      FROM dining_orders 
      WHERE registerTime IS NOT NULL 
      AND registerTime LIKE '%T0%:00.000Z'
      AND HOUR(registerTime) BETWEEN 6 AND 23
    `);

    console.log(`æ‰¾åˆ° ${orders.length} ä¸ªéœ€è¦ä¿®å¤çš„æŠ¥é¤è®¢å•`);

    for (const order of orders) {
      // å°†é”™è¯¯çš„UTCæ—¶é—´åŠ ä¸Š8å°æ—¶
      const wrongTime = new Date(order.registerTime);
      const correctTime = new Date(wrongTime.getTime() + (8 * 60 * 60 * 1000));
      
      await connection.execute(
        `UPDATE dining_orders 
         SET registerTime = ?, createTime = ?
         WHERE _id = ?`,
        [correctTime.toISOString(), correctTime.toISOString(), order._id]
      );
      
      console.log(`ä¿®å¤è®¢å• ${order._id}: ${order.registerTime} -> ${correctTime.toISOString()}`);
    }
  } catch (error) {
    console.error('ä¿®å¤æŠ¥é¤è®¢å•æ—¶é—´å¤±è´¥:', error);
  }
}

async function fixDiningConfirmationsTime(connection) {
  try {
    console.log('ä¿®å¤ç¡®è®¤å°±é¤æ—¶é—´...');
    
    const [confirmations] = await connection.execute(`
      SELECT _id, actualDiningTime
      FROM dining_orders 
      WHERE actualDiningTime IS NOT NULL 
      AND actualDiningTime LIKE '%T0%:00.000Z'
      AND HOUR(actualDiningTime) BETWEEN 6 AND 23
    `);

    console.log(`æ‰¾åˆ° ${confirmations.length} ä¸ªéœ€è¦ä¿®å¤çš„ç¡®è®¤å°±é¤è®°å½•`);

    for (const confirmation of confirmations) {
      const wrongTime = new Date(confirmation.actualDiningTime);
      const correctTime = new Date(wrongTime.getTime() + (8 * 60 * 60 * 1000));
      
      await connection.execute(
        `UPDATE dining_orders 
         SET actualDiningTime = ?
         WHERE _id = ?`,
        [correctTime.toISOString(), confirmation._id]
      );
      
      console.log(`ä¿®å¤ç¡®è®¤å°±é¤ ${confirmation._id}: ${confirmation.actualDiningTime} -> ${correctTime.toISOString()}`);
    }
  } catch (error) {
    console.error('ä¿®å¤ç¡®è®¤å°±é¤æ—¶é—´å¤±è´¥:', error);
  }
}

async function fixDiningRegistrationsTime(connection) {
  try {
    console.log('ä¿®å¤æ‰«ç ç™»è®°æ—¶é—´...');
    
    const [registrations] = await connection.execute(`
      SELECT _id, scanTime
      FROM dining_registrations 
      WHERE scanTime IS NOT NULL 
      AND scanTime LIKE '%T0%:00.000Z'
      AND HOUR(scanTime) BETWEEN 6 AND 23
    `);

    console.log(`æ‰¾åˆ° ${registrations.length} ä¸ªéœ€è¦ä¿®å¤çš„æ‰«ç ç™»è®°è®°å½•`);

    for (const registration of registrations) {
      const wrongTime = new Date(registration.scanTime);
      const correctTime = new Date(wrongTime.getTime() + (8 * 60 * 60 * 1000));
      
      await connection.execute(
        `UPDATE dining_registrations 
         SET scanTime = ?
         WHERE _id = ?`,
        [correctTime.toISOString(), registration._id]
      );
      
      console.log(`ä¿®å¤æ‰«ç ç™»è®° ${registration._id}: ${registration.scanTime} -> ${correctTime.toISOString()}`);
    }
  } catch (error) {
    console.error('ä¿®å¤æ‰«ç ç™»è®°æ—¶é—´å¤±è´¥:', error);
  }
}

// è¿è¡Œä¿®å¤è„šæœ¬
if (require.main === module) {
  fixHistoricalTimeData();
}

module.exports = { fixHistoricalTimeData };
```

### 5. æ•°æ®åº“é…ç½®ä¼˜åŒ–

#### 5.1 ç¡®ä¿æ•°æ®åº“æ—¶åŒºé…ç½®æ­£ç¡®

```javascript
// config/database.js
module.exports = {
  development: {
    host: process.env.DB_HOST || 'localhost',
    user: process.env.DB_USER || 'root',
    password: process.env.DB_PASSWORD || '',
    database: process.env.DB_NAME || 'dining_system',
    timezone: '+00:00', // ç¡®ä¿æ•°æ®åº“ä½¿ç”¨UTCæ—¶åŒº
    charset: 'utf8mb4',
    acquireTimeout: 60000,
    timeout: 60000,
    reconnect: true
  }
};
```

### 6. æ—¶é—´å¤„ç†å·¥å…·ç±»

#### 6.1 åˆ›å»ºç»Ÿä¸€çš„æ—¶é—´å¤„ç†å·¥å…·

```javascript
// utils/timeUtils.js
const moment = require('moment-timezone');

class TimeUtils {
  /**
   * èŽ·å–å½“å‰åŒ—äº¬æ—¶é—´
   * @returns {moment} åŒ—äº¬æ—¶é—´
   */
  static getBeijingTime() {
    return moment().tz('Asia/Shanghai');
  }

  /**
   * å°†åŒ—äº¬æ—¶é—´è½¬æ¢ä¸ºUTCæ—¶é—´ç”¨äºŽå­˜å‚¨
   * @param {Date|moment|string} beijingTime - åŒ—äº¬æ—¶é—´
   * @returns {Date} UTCæ—¶é—´
   */
  static toUTCForStorage(beijingTime) {
    return moment(beijingTime).tz('Asia/Shanghai').utc().toDate();
  }

  /**
   * å°†UTCæ—¶é—´è½¬æ¢ä¸ºåŒ—äº¬æ—¶é—´ç”¨äºŽæ˜¾ç¤º
   * @param {Date|string} utcTime - UTCæ—¶é—´
   * @returns {string} åŒ—äº¬æ—¶é—´å­—ç¬¦ä¸²
   */
  static toBeijingForDisplay(utcTime) {
    return moment(utcTime).tz('Asia/Shanghai').format('YYYY-MM-DD HH:mm:ss');
  }

  /**
   * èŽ·å–é¤æ¬¡ç±»åž‹
   * @param {Date|moment} time - æ—¶é—´
   * @returns {string} é¤æ¬¡ç±»åž‹
   */
  static getMealTypeByTime(time) {
    const beijingTime = moment(time).tz('Asia/Shanghai');
    const hour = beijingTime.hour();
    
    if (hour >= 6 && hour < 10) {
      return 'breakfast';
    } else if (hour >= 11 && hour < 14) {
      return 'lunch';
    } else if (hour >= 17 && hour < 20) {
      return 'dinner';
    }
    return null;
  }

  /**
   * æ£€æŸ¥æ˜¯å¦åœ¨å°±é¤æ—¶é—´å†…
   * @param {string} mealType - é¤æ¬¡ç±»åž‹
   * @returns {boolean} æ˜¯å¦åœ¨å°±é¤æ—¶é—´å†…
   */
  static isInDiningTime(mealType) {
    const now = this.getBeijingTime();
    const hour = now.hour();
    
    const mealTimeRanges = {
      'breakfast': { start: 6, end: 10 },
      'lunch': { start: 11, end: 14 },
      'dinner': { start: 17, end: 20 }
    };
    
    const timeRange = mealTimeRanges[mealType];
    return timeRange && hour >= timeRange.start && hour <= timeRange.end;
  }
}

module.exports = TimeUtils;
```

## ðŸ“‹ ä¿®å¤æ­¥éª¤

### ç¬¬ä¸€æ­¥ï¼šç«‹å³ä¿®å¤ä»£ç 
1. **ä¿®å¤æŠ¥é¤æœåŠ¡**ï¼šæ›´æ–° `diningService.js` å’Œ `diningServiceEnhanced.js`
2. **ä¿®å¤ç¡®è®¤å°±é¤æœåŠ¡**ï¼šæ›´æ–° `diningConfirmationService.js`
3. **ä¿®å¤æ‰«ç æœåŠ¡**ï¼šç¡®ä¿ `qrScanService.js` ä½¿ç”¨æ­£ç¡®çš„æ—¶åŒºå¤„ç†
4. **æ·»åŠ æ—¶é—´å·¥å…·ç±»**ï¼šåˆ›å»º `utils/timeUtils.js`

### ç¬¬äºŒæ­¥ï¼šæ•°æ®ä¿®å¤
1. **å¤‡ä»½æ•°æ®åº“**ï¼šåœ¨ä¿®å¤å‰å¤‡ä»½æ‰€æœ‰æ•°æ®
2. **è¿è¡Œä¿®å¤è„šæœ¬**ï¼šæ‰§è¡Œ `fix_historical_time_data.js`
3. **éªŒè¯ä¿®å¤ç»“æžœ**ï¼šæ£€æŸ¥ä¿®å¤åŽçš„æ—¶é—´æ˜¯å¦æ­£ç¡®

### ç¬¬ä¸‰æ­¥ï¼šæµ‹è¯•éªŒè¯
1. **æµ‹è¯•æŠ¥é¤åŠŸèƒ½**ï¼šéªŒè¯æŠ¥é¤æ—¶é—´å­˜å‚¨æ­£ç¡®
2. **æµ‹è¯•ç¡®è®¤å°±é¤åŠŸèƒ½**ï¼šéªŒè¯ç¡®è®¤å°±é¤æ—¶é—´æ­£ç¡®
3. **æµ‹è¯•æ‰«ç åŠŸèƒ½**ï¼šéªŒè¯æ‰«ç æ—¶é—´å¤„ç†æ­£ç¡®
4. **éªŒè¯å‰ç«¯æ˜¾ç¤º**ï¼šç¡®ä¿å‰ç«¯æ˜¾ç¤ºæ—¶é—´æ­£ç¡®

## âš ï¸ æ³¨æ„äº‹é¡¹

1. **å¤‡ä»½æ•°æ®**ï¼šä¿®å¤å‰å¿…é¡»å¤‡ä»½æ•°æ®åº“
2. **æµ‹è¯•çŽ¯å¢ƒ**ï¼šå»ºè®®å…ˆåœ¨æµ‹è¯•çŽ¯å¢ƒéªŒè¯ä¿®å¤æ•ˆæžœ
3. **é€æ­¥éƒ¨ç½²**ï¼šå¯ä»¥åˆ†æ­¥éª¤éƒ¨ç½²ä¿®å¤ï¼Œé¿å…å½±å“ç”Ÿäº§çŽ¯å¢ƒ
4. **ç›‘æŽ§å‘Šè­¦**ï¼šä¿®å¤åŽéœ€è¦ç›‘æŽ§æ—¶é—´ç›¸å…³åŠŸèƒ½æ˜¯å¦æ­£å¸¸

## ðŸ”§ é…ç½®è¦æ±‚

### 1. ä¾èµ–åŒ…è¦æ±‚
```json
{
  "moment-timezone": "^0.5.43",
  "mysql2": "^3.6.0"
}
```

### 2. çŽ¯å¢ƒå˜é‡
```bash
DB_HOST=localhost
DB_USER=root
DB_PASSWORD=your_password
DB_NAME=dining_system
```

### 3. æ•°æ®åº“æ—¶åŒºè®¾ç½®
```sql
SET time_zone = '+00:00';
```

## ðŸ“Š ä¿®å¤æ•ˆæžœé¢„æœŸ

ä¿®å¤å®ŒæˆåŽï¼š
- **æŠ¥é¤æ—¶é—´**ï¼šç”¨æˆ·17:18æŠ¥é¤ï¼Œå­˜å‚¨ä¸º `2025-09-11T09:18:01.000Z`ï¼Œå‰ç«¯æ˜¾ç¤º17:18
- **ç¡®è®¤å°±é¤æ—¶é—´**ï¼šç”¨æˆ·18:00ç¡®è®¤å°±é¤ï¼Œå­˜å‚¨ä¸º `2025-09-11T10:00:00.000Z`ï¼Œå‰ç«¯æ˜¾ç¤º18:00
- **æ‰«ç æ—¶é—´**ï¼šç”¨æˆ·12:30æ‰«ç ï¼Œå­˜å‚¨ä¸º `2025-09-11T04:30:00.000Z`ï¼Œå‰ç«¯æ˜¾ç¤º12:30

## ðŸ“ æ€»ç»“

é€šè¿‡ä»¥ä¸Šä¿®å¤æ–¹æ¡ˆï¼Œå¯ä»¥å½»åº•è§£å†³æŠ¥é¤æ—¶é—´å­˜å‚¨å’Œæ˜¾ç¤ºçš„é—®é¢˜ï¼š

1. **ç»Ÿä¸€æ—¶åŒºå¤„ç†**ï¼šæ‰€æœ‰æ—¶é—´å¤„ç†éƒ½ä½¿ç”¨åŒ—äº¬æ—¶é—´è¿›è¡Œä¸šåŠ¡é€»è¾‘åˆ¤æ–­
2. **æ­£ç¡®å­˜å‚¨æ ¼å¼**ï¼šæ•°æ®åº“ç»Ÿä¸€å­˜å‚¨UTCæ—¶é—´
3. **å‡†ç¡®æ˜¾ç¤ºæ—¶é—´**ï¼šå‰ç«¯æ˜¾ç¤ºæ­£ç¡®çš„åŒ—äº¬æ—¶é—´
4. **åŽ†å²æ•°æ®ä¿®å¤**ï¼šä¿®å¤å·²å­˜åœ¨çš„é”™è¯¯æ—¶é—´æ•°æ®
5. **é¢„é˜²æŽªæ–½**ï¼šé€šè¿‡å·¥å…·ç±»å’Œè§„èŒƒé¿å…æœªæ¥å‡ºçŽ°ç±»ä¼¼é—®é¢˜

è¿™ä¸ªä¿®å¤æ–¹æ¡ˆç¡®ä¿äº†æ—¶é—´å¤„ç†çš„ä¸€è‡´æ€§å’Œå‡†ç¡®æ€§ï¼Œè§£å†³äº†ç”¨æˆ·åé¦ˆçš„æ—¶é—´æ˜¾ç¤ºé”™è¯¯é—®é¢˜ã€‚
