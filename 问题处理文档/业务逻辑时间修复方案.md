# ä¸šåŠ¡é€»è¾‘æ—¶é—´ä¿®å¤æ–¹æ¡ˆ

## ğŸ¯ ä¸šåŠ¡é€»è¾‘é—®é¢˜åˆ†æ

ç»è¿‡æ£€æŸ¥ï¼Œå‘ç°ä¸šåŠ¡é€»è¾‘æ–¹é¢ç¡®å®å­˜åœ¨æ—¶åŒºå¤„ç†ä¸ä¸€è‡´çš„é—®é¢˜ï¼š

### 1. é—®é¢˜å‘ç°

#### 1.1 `utils/common.js` ä¸­çš„é—®é¢˜
```javascript
// é—®é¢˜ä»£ç ï¼šä½¿ç”¨æ™®é€šmomentï¼Œæ²¡æœ‰æ—¶åŒºæ”¯æŒ
static validateDiningTime(diningDate, mealType, allowFlexible = false) {
  const diningMoment = moment(diningDate);  // âŒ æ²¡æœ‰æ—¶åŒºå¤„ç†
  const now = moment();                     // âŒ æœåŠ¡å™¨æœ¬åœ°æ—¶é—´
  
  // å¦‚æœæ˜¯å½“å¤©ï¼Œæ£€æŸ¥æ˜¯å¦åœ¨åˆç†æ—¶é—´èŒƒå›´å†…
  if (diningMoment.isSame(now, 'day')) {
    const currentHour = now.hour();  // âŒ åŸºäºæœåŠ¡å™¨æœ¬åœ°æ—¶é—´
    // ...
  }
}
```

#### 1.2 `services/diningConfirmationService.js` ä¸­çš„é—®é¢˜
```javascript
// é—®é¢˜ä»£ç ï¼šæ··åˆä½¿ç”¨æ—¶åŒºå¤„ç†
const diningDate = moment(order.diningDate).tz('Asia/Shanghai');  // âœ… æ­£ç¡®
const now = moment().tz('Asia/Shanghai');                          // âœ… æ­£ç¡®
const actualDiningTime = now.format('YYYY-MM-DD HH:mm:ss');       // âŒ å­˜å‚¨æœ¬åœ°æ—¶é—´æ ¼å¼
```

## ğŸ› ï¸ ä¸šåŠ¡é€»è¾‘ä¿®å¤æ–¹æ¡ˆ

### 1. ä¿®å¤ `utils/common.js`

#### 1.1 ä¿®å¤æ—¶é—´éªŒè¯é€»è¾‘
```javascript
// ä¿®å¤å‰çš„é—®é¢˜ä»£ç 
static validateDiningTime(diningDate, mealType, allowFlexible = false) {
  const diningMoment = moment(diningDate);  // âŒ æ²¡æœ‰æ—¶åŒºå¤„ç†
  const now = moment();                     // âŒ æœåŠ¡å™¨æœ¬åœ°æ—¶é—´
  
  // å¦‚æœæ˜¯å½“å¤©ï¼Œæ£€æŸ¥æ˜¯å¦åœ¨åˆç†æ—¶é—´èŒƒå›´å†…
  if (diningMoment.isSame(now, 'day')) {
    const currentHour = now.hour();  // âŒ åŸºäºæœåŠ¡å™¨æœ¬åœ°æ—¶é—´
    // ...
  }
}

// ä¿®å¤åçš„æ­£ç¡®ä»£ç 
static validateDiningTime(diningDate, mealType, allowFlexible = false) {
  const diningMoment = moment(diningDate).tz('Asia/Shanghai');  // âœ… ä½¿ç”¨åŒ—äº¬æ—¶é—´
  const now = moment().tz('Asia/Shanghai');                    // âœ… ä½¿ç”¨åŒ—äº¬æ—¶é—´
  
  // å¦‚æœæ˜¯å½“å¤©ï¼Œæ£€æŸ¥æ˜¯å¦åœ¨åˆç†æ—¶é—´èŒƒå›´å†…
  if (diningMoment.isSame(now, 'day')) {
    const mealTimeRanges = {
      'breakfast': { start: 6, end: 10 },
      'lunch': { start: 11, end: 14 },
      'dinner': { start: 17, end: 20 }
    };

    const range = mealTimeRanges[mealType];
    if (range) {
      const currentHour = now.hour();  // âœ… åŒ—äº¬æ—¶é—´çš„å°æ—¶æ•°
      
      if (!allowFlexible && (currentHour < range.start || currentHour > range.end)) {
        throw new BusinessError(
          `ä¸åœ¨${this.getMealTypeName(mealType)}æ—¶é—´èŒƒå›´å†…ï¼ˆ${range.start}:00-${range.end}:00ï¼‰`,
          ERROR_CODES.INVALID_DINING_TIME
        );
      }
    }
  }

  // ä¸èƒ½æå‰å¤ªå¤šç¡®è®¤ï¼ˆè¶…è¿‡1å¤©ï¼‰
  if (diningMoment.isAfter(now.add(1, 'day'))) {
    throw new BusinessError('ä¸èƒ½æå‰è¶…è¿‡1å¤©ç¡®è®¤å°±é¤', ERROR_CODES.INVALID_DINING_TIME);
  }
}
```

### 2. ä¿®å¤ `services/diningConfirmationService.js`

#### 2.1 ä¿®å¤ç¡®è®¤å°±é¤æ—¶é—´å¤„ç†
```javascript
// ä¿®å¤å‰çš„é—®é¢˜ä»£ç 
const actualDiningTime = now.format('YYYY-MM-DD HH:mm:ss');  // âŒ æœ¬åœ°æ—¶é—´æ ¼å¼

await connection.execute(
  `UPDATE dining_orders 
   SET diningStatus = 'dined', 
       actualDiningTime = ?,
       updateTime = NOW()
   WHERE _id = ?`,
  [actualDiningTime, orderId]  // âŒ å­˜å‚¨æœ¬åœ°æ—¶é—´æ ¼å¼
);

// ä¿®å¤åçš„æ­£ç¡®ä»£ç 
const utcActualDiningTime = now.utc().toDate();  // âœ… è½¬æ¢ä¸ºUTCæ—¶é—´å­˜å‚¨

await connection.execute(
  `UPDATE dining_orders 
   SET diningStatus = 'dined', 
       actualDiningTime = ?,
       updateTime = NOW()
   WHERE _id = ?`,
  [utcActualDiningTime, orderId]  // âœ… å­˜å‚¨UTCæ—¶é—´
);
```

### 3. ä¿®å¤ `services/diningService.js`

#### 3.1 ä¿®å¤æŠ¥é¤æ—¶é—´éªŒè¯
```javascript
// ä¿®å¤å‰çš„é—®é¢˜ä»£ç 
async submitDeptOrder(userId, date, mealType, memberIds, remark, db) {
  try {
    // 1. éªŒè¯æŠ¥é¤æ—¥æœŸï¼ˆä¸èƒ½æ˜¯è¿‡å»çš„æ—¥æœŸï¼‰
    const today = moment().tz('Asia/Shanghai').format('YYYY-MM-DD');  // âœ… æ­£ç¡®
    if (moment(date).isBefore(today)) {
      throw new Error('ä¸èƒ½ä¸ºè¿‡å»çš„æ—¥æœŸæŠ¥é¤');
    }
    
    // âŒ ç¼ºå°‘æ—¶é—´å­˜å‚¨é€»è¾‘
    await db.execute(
      `INSERT INTO dining_orders 
       (_id, deptId, deptName, registrantId, userId, userName, memberIds, memberNames, memberCount, 
        diningDate, mealType, status, diningStatus, remark, createTime, updateTime)
       VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, 'pending', 'ordered', ?, NOW(), NOW())`,
      [/* å‚æ•°åˆ—è¡¨ */]
    );
  }
}

// ä¿®å¤åçš„æ­£ç¡®ä»£ç 
async submitDeptOrder(userId, date, mealType, memberIds, remark, db) {
  try {
    // 1. éªŒè¯æŠ¥é¤æ—¥æœŸï¼ˆä¸èƒ½æ˜¯è¿‡å»çš„æ—¥æœŸï¼‰
    const today = moment().tz('Asia/Shanghai').format('YYYY-MM-DD');
    if (moment(date).isBefore(today)) {
      throw new Error('ä¸èƒ½ä¸ºè¿‡å»çš„æ—¥æœŸæŠ¥é¤');
    }
    
    // 2. æ­£ç¡®å¤„ç†æŠ¥é¤æ—¶é—´
    const now = moment().tz('Asia/Shanghai');  // âœ… è·å–å½“å‰åŒ—äº¬æ—¶é—´
    const utcNow = now.utc().toDate();         // âœ… è½¬æ¢ä¸ºUTCæ—¶é—´å­˜å‚¨
    
    // 3. åˆ›å»ºè®¢å•æ—¶ä½¿ç”¨æ­£ç¡®çš„æ—¶é—´
    await db.execute(
      `INSERT INTO dining_orders 
       (_id, deptId, deptName, registrantId, userId, userName, memberIds, memberNames, memberCount, 
        diningDate, mealType, status, diningStatus, remark, registerTime, createTime, updateTime)
       VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, 'pending', 'ordered', ?, ?, ?, NOW())`,
      [
        orderId,
        registrant.departmentId,
        registrant.department,
        userId,
        userId,
        registrant.nickName,
        JSON.stringify(memberIds),
        JSON.stringify(memberNames),
        memberIds.length,
        date,
        mealType,
        remark || '',
        utcNow,  // âœ… æ­£ç¡®çš„UTCæ—¶é—´
        utcNow,  // âœ… æ­£ç¡®çš„UTCæ—¶é—´
        utcNow   // âœ… æ­£ç¡®çš„UTCæ—¶é—´
      ]
    );
  }
}
```

### 4. ä¿®å¤ `services/qrScanService.js`

#### 4.1 ç¡®ä¿æ‰«ç æœåŠ¡ä½¿ç”¨æ­£ç¡®çš„æ—¶åŒºå¤„ç†
```javascript
// ç¡®ä¿æ‰«ç æœåŠ¡ä½¿ç”¨æ­£ç¡®çš„æ—¶åŒºå¤„ç†
async processQRScan(userId, qrCode, scanTime, db) {
  // ...
  
  // 2. æ ¹æ®æ‰«ç æ—¶é—´åˆ¤æ–­é¤æ¬¡ï¼ˆä½¿ç”¨åŒ—äº¬æ—¶é—´ï¼‰
  const beijingScanTime = moment(scanTime).tz('Asia/Shanghai');
  const mealType = this.getMealTypeByTime(beijingScanTime.toDate());
  if (!mealType) {
    throw new Error('å½“å‰æ—¶é—´ä¸åœ¨å°±é¤æ—¶é—´å†…');
  }
  
  // ä½¿ç”¨åŒ—äº¬æ—¶é—´çš„æ—¥æœŸ
  const diningDate = beijingScanTime.format('YYYY-MM-DD');
  
  // 6. åˆ›å»ºå°±é¤ç™»è®°è®°å½•
  const registrationId = uuidv4();
  // âœ… å­˜å‚¨UTCæ—¶é—´åˆ°æ•°æ®åº“
  const utcScanTime = moment(scanTime).utc().toDate();
  
  await connection.execute(`
    INSERT INTO dining_registrations 
    (_id, userId, userName, qrCodeId, qrCode, scanTime, mealType, diningDate, orderId, status)
    VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, 'success')
  `, [
    registrationId,
    userId,
    userInfo.nickName,
    qrCodeInfo._id,
    qrCode,
    utcScanTime,  // âœ… å­˜å‚¨UTCæ—¶é—´
    mealType,
    diningDate,
    orderInfo._id
  ]);
}
```

## ğŸ“‹ ä¸šåŠ¡é€»è¾‘ä¿®å¤æ­¥éª¤

### ç¬¬ä¸€æ­¥ï¼šä¿®å¤æ—¶é—´éªŒè¯å·¥å…·
1. **ä¿®å¤ `utils/common.js`**ï¼šä½¿ç”¨ `moment-timezone` è¿›è¡Œæ—¶åŒºå¤„ç†
2. **ä¿®å¤ `utils/timeUtils.js`**ï¼šç¡®ä¿æ—¶é—´å·¥å…·ç±»ä½¿ç”¨æ­£ç¡®çš„æ—¶åŒº

### ç¬¬äºŒæ­¥ï¼šä¿®å¤æœåŠ¡å±‚ä¸šåŠ¡é€»è¾‘
1. **ä¿®å¤ `services/diningService.js`**ï¼šæ­£ç¡®å¤„ç†æŠ¥é¤æ—¶é—´å­˜å‚¨
2. **ä¿®å¤ `services/diningServiceEnhanced.js`**ï¼šç¡®ä¿å¢å¼ºç‰ˆæœåŠ¡ä¹Ÿä½¿ç”¨æ­£ç¡®çš„æ—¶é—´å¤„ç†
3. **ä¿®å¤ `services/diningConfirmationService.js`**ï¼šä¿®å¤ç¡®è®¤å°±é¤æ—¶é—´å¤„ç†
4. **ç¡®ä¿ `services/qrScanService.js`**ï¼šä½¿ç”¨æ­£ç¡®çš„æ—¶åŒºå¤„ç†

### ç¬¬ä¸‰æ­¥ï¼šä¿®å¤æ§åˆ¶å™¨å±‚
1. **ä¿®å¤ `controllers/diningController.js`**ï¼šç¡®ä¿æ§åˆ¶å™¨ä½¿ç”¨æ­£ç¡®çš„æ—¶é—´å¤„ç†
2. **ä¿®å¤ `controllers/diningControllerEnhanced.js`**ï¼šç¡®ä¿å¢å¼ºç‰ˆæ§åˆ¶å™¨ä¹Ÿä½¿ç”¨æ­£ç¡®çš„æ—¶é—´å¤„ç†

### ç¬¬å››æ­¥ï¼šæµ‹è¯•éªŒè¯
1. **è¿è¡Œä¸šåŠ¡é€»è¾‘æµ‹è¯•**ï¼šç¡®ä¿æ‰€æœ‰ä¸šåŠ¡è§„åˆ™æ­£ç¡®æ‰§è¡Œ
2. **è¿è¡Œæ—¶é—´ä¿®å¤æµ‹è¯•**ï¼šç¡®ä¿æ—¶é—´å¤„ç†æ­£ç¡®
3. **è¿è¡Œé›†æˆæµ‹è¯•**ï¼šç¡®ä¿æ•´ä¸ªæµç¨‹æ­£ç¡®

## ğŸ”§ å…·ä½“ä¿®å¤ä»£ç 

### 1. ä¿®å¤ `utils/common.js`

```javascript
const moment = require('moment-timezone');  // âœ… ä½¿ç”¨æ”¯æŒæ—¶åŒºçš„moment

class CommonUtils {
  /**
   * éªŒè¯å°±é¤æ—¶é—´
   * @param {string} diningDate - å°±é¤æ—¥æœŸ
   * @param {string} mealType - é¤æ¬¡ç±»å‹
   * @param {boolean} allowFlexible - æ˜¯å¦å…è®¸çµæ´»æ—¶é—´
   */
  static validateDiningTime(diningDate, mealType, allowFlexible = false) {
    const diningMoment = moment(diningDate).tz('Asia/Shanghai');  // âœ… ä½¿ç”¨åŒ—äº¬æ—¶é—´
    const now = moment().tz('Asia/Shanghai');                    // âœ… ä½¿ç”¨åŒ—äº¬æ—¶é—´

    // å¦‚æœæ˜¯å½“å¤©ï¼Œæ£€æŸ¥æ˜¯å¦åœ¨åˆç†æ—¶é—´èŒƒå›´å†…
    if (diningMoment.isSame(now, 'day')) {
      const mealTimeRanges = {
        'breakfast': { start: 6, end: 10 },
        'lunch': { start: 11, end: 14 },
        'dinner': { start: 17, end: 20 }
      };

      const range = mealTimeRanges[mealType];
      if (range) {
        const currentHour = now.hour();  // âœ… åŒ—äº¬æ—¶é—´çš„å°æ—¶æ•°
        
        if (!allowFlexible && (currentHour < range.start || currentHour > range.end)) {
          throw new BusinessError(
            `ä¸åœ¨${this.getMealTypeName(mealType)}æ—¶é—´èŒƒå›´å†…ï¼ˆ${range.start}:00-${range.end}:00ï¼‰`,
            ERROR_CODES.INVALID_DINING_TIME
          );
        }
      }
    }

    // ä¸èƒ½æå‰å¤ªå¤šç¡®è®¤ï¼ˆè¶…è¿‡1å¤©ï¼‰
    if (diningMoment.isAfter(now.add(1, 'day'))) {
      throw new BusinessError('ä¸èƒ½æå‰è¶…è¿‡1å¤©ç¡®è®¤å°±é¤', ERROR_CODES.INVALID_DINING_TIME);
    }
  }
}
```

### 2. ä¿®å¤ `services/diningConfirmationService.js`

```javascript
const moment = require('moment-timezone');  // âœ… ä½¿ç”¨æ”¯æŒæ—¶åŒºçš„moment

class DiningConfirmationService {
  async confirmDiningManually(userId, orderId, confirmationType = 'manual', db) {
    // ...
    
    // 3. æ£€æŸ¥ç¡®è®¤æ—¶é—´æ˜¯å¦åˆç†ï¼ˆä¸èƒ½æå‰å¤ªå¤šç¡®è®¤ï¼‰
    const diningDate = moment(order.diningDate).tz('Asia/Shanghai');
    const now = moment().tz('Asia/Shanghai');  // âœ… ä½¿ç”¨åŒ—äº¬æ—¶é—´
    
    // å¦‚æœæ˜¯å½“å¤©ï¼Œæ£€æŸ¥æ˜¯å¦åœ¨åˆç†æ—¶é—´èŒƒå›´å†…
    if (diningDate.isSame(now, 'day')) {
      const mealType = order.mealType;
      const currentHour = now.hour();  // âœ… åŒ—äº¬æ—¶é—´çš„å°æ—¶æ•°
      
      // æ£€æŸ¥æ˜¯å¦åœ¨å°±é¤æ—¶é—´èŒƒå›´å†…
      const mealTimeRanges = {
        'breakfast': { start: 6, end: 10 },
        'lunch': { start: 11, end: 14 },
        'dinner': { start: 17, end: 20 }
      };
      
      const timeRange = mealTimeRanges[mealType];
      if (timeRange && (currentHour < timeRange.start || currentHour > timeRange.end)) {
        throw new Error(`å½“å‰æ—¶é—´ä¸åœ¨${this.getMealTypeName(mealType)}å°±é¤æ—¶é—´å†…`);
      }
    }

    // 4. æ›´æ–°è®¢å•çŠ¶æ€
    const utcActualDiningTime = now.utc().toDate();  // âœ… è½¬æ¢ä¸ºUTCæ—¶é—´å­˜å‚¨
    
    await connection.execute(
      `UPDATE dining_orders 
       SET diningStatus = 'dined', 
           actualDiningTime = ?,
           updateTime = NOW()
       WHERE _id = ?`,
      [utcActualDiningTime, orderId]  // âœ… å­˜å‚¨UTCæ—¶é—´
    );
  }
}
```

## ğŸ¯ ä¸šåŠ¡é€»è¾‘ä¿®å¤æ•ˆæœ

### ä¿®å¤å‰çš„é—®é¢˜
1. **æ—¶é—´éªŒè¯ä¸å‡†ç¡®**ï¼šä½¿ç”¨æœåŠ¡å™¨æœ¬åœ°æ—¶é—´è¿›è¡Œä¸šåŠ¡é€»è¾‘åˆ¤æ–­
2. **æ—¶é—´å­˜å‚¨ä¸ä¸€è‡´**ï¼šæ··åˆä½¿ç”¨æœ¬åœ°æ—¶é—´å’ŒUTCæ—¶é—´
3. **é¤æ¬¡åˆ¤æ–­é”™è¯¯**ï¼šåŸºäºé”™è¯¯çš„æ—¶é—´è¿›è¡Œé¤æ¬¡åˆ¤æ–­
4. **ç¡®è®¤å°±é¤æ—¶é—´é”™è¯¯**ï¼šå­˜å‚¨é”™è¯¯çš„ç¡®è®¤å°±é¤æ—¶é—´

### ä¿®å¤åçš„æ•ˆæœ
1. **æ—¶é—´éªŒè¯å‡†ç¡®**ï¼šç»Ÿä¸€ä½¿ç”¨åŒ—äº¬æ—¶é—´è¿›è¡Œä¸šåŠ¡é€»è¾‘åˆ¤æ–­
2. **æ—¶é—´å­˜å‚¨ä¸€è‡´**ï¼šç»Ÿä¸€å­˜å‚¨UTCæ—¶é—´åˆ°æ•°æ®åº“
3. **é¤æ¬¡åˆ¤æ–­æ­£ç¡®**ï¼šåŸºäºæ­£ç¡®çš„åŒ—äº¬æ—¶é—´è¿›è¡Œé¤æ¬¡åˆ¤æ–­
4. **ç¡®è®¤å°±é¤æ—¶é—´æ­£ç¡®**ï¼šå­˜å‚¨æ­£ç¡®çš„ç¡®è®¤å°±é¤æ—¶é—´

## âš ï¸ æ³¨æ„äº‹é¡¹

1. **ä¾èµ–æ›´æ–°**ï¼šç¡®ä¿æ‰€æœ‰ç›¸å…³æ–‡ä»¶éƒ½ä½¿ç”¨ `moment-timezone`
2. **ä¸šåŠ¡è§„åˆ™**ï¼šç¡®ä¿æ‰€æœ‰ä¸šåŠ¡è§„åˆ™éƒ½åŸºäºåŒ—äº¬æ—¶é—´è¿›è¡Œåˆ¤æ–­
3. **æ•°æ®ä¸€è‡´æ€§**ï¼šç¡®ä¿æ‰€æœ‰æ—¶é—´æ•°æ®éƒ½ç»Ÿä¸€å­˜å‚¨ä¸ºUTCæ—¶é—´
4. **æµ‹è¯•éªŒè¯**ï¼šä¿®å¤åéœ€è¦å…¨é¢æµ‹è¯•æ‰€æœ‰ä¸šåŠ¡é€»è¾‘

## ğŸ“ æ€»ç»“

ä¸šåŠ¡é€»è¾‘æ–¹é¢çš„ä¿®å¤æ˜¯æ—¶é—´ä¿®å¤æ–¹æ¡ˆçš„é‡è¦ç»„æˆéƒ¨åˆ†ï¼ŒåŒ…æ‹¬ï¼š

1. **æ—¶é—´éªŒè¯é€»è¾‘**ï¼šç»Ÿä¸€ä½¿ç”¨åŒ—äº¬æ—¶é—´è¿›è¡Œä¸šåŠ¡è§„åˆ™éªŒè¯
2. **æ—¶é—´å­˜å‚¨é€»è¾‘**ï¼šç»Ÿä¸€å­˜å‚¨UTCæ—¶é—´åˆ°æ•°æ®åº“
3. **é¤æ¬¡åˆ¤æ–­é€»è¾‘**ï¼šåŸºäºæ­£ç¡®çš„åŒ—äº¬æ—¶é—´è¿›è¡Œé¤æ¬¡åˆ¤æ–­
4. **ç¡®è®¤å°±é¤é€»è¾‘**ï¼šæ­£ç¡®å¤„ç†ç¡®è®¤å°±é¤æ—¶é—´

ä¿®å¤å®Œæˆåï¼Œæ•´ä¸ªæŠ¥é¤ç³»ç»Ÿçš„ä¸šåŠ¡é€»è¾‘å°†åŸºäºæ­£ç¡®çš„æ—¶é—´å¤„ç†ï¼Œç¡®ä¿æ‰€æœ‰åŠŸèƒ½éƒ½èƒ½æ­£å¸¸å·¥ä½œã€‚
