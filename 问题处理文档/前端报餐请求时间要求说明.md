# å‰ç«¯æŠ¥é¤è¯·æ±‚æ—¶é—´è¦æ±‚è¯´æ˜

## ğŸ“‹ æ¦‚è¿°

æœ¬æ–‡æ¡£è¯¦ç»†è¯´æ˜å‰ç«¯åœ¨å‘èµ·æŠ¥é¤è¯·æ±‚æ—¶éœ€è¦éµå¾ªçš„æ—¶é—´è¦æ±‚å’Œé™åˆ¶è§„åˆ™ã€‚

## ğŸ¯ æ ¸å¿ƒæ—¶é—´è¦æ±‚

### 1. æŠ¥é¤æ—¥æœŸé™åˆ¶

#### 1.1 åŸºæœ¬è§„åˆ™
- **ä¸èƒ½ä¸ºè¿‡å»çš„æ—¥æœŸæŠ¥é¤**
- **å¯ä»¥æŠ¥é¤çš„æ—¥æœŸ**ï¼šä»Šå¤©åŠæœªæ¥çš„æ—¥æœŸ
- **æ—¥æœŸæ ¼å¼**ï¼š`YYYY-MM-DD`ï¼ˆå¦‚ï¼š`2025-09-11`ï¼‰

#### 1.2 å…·ä½“å®ç°
```javascript
// åç«¯éªŒè¯é€»è¾‘
const today = moment().tz('Asia/Shanghai').format('YYYY-MM-DD');
if (moment(date).isBefore(today)) {
  throw new Error('ä¸èƒ½ä¸ºè¿‡å»çš„æ—¥æœŸæŠ¥é¤');
}
```

#### 1.3 å‰ç«¯å¤„ç†å»ºè®®
```javascript
// å‰ç«¯æ—¥æœŸé€‰æ‹©å™¨é™åˆ¶
const today = moment().format('YYYY-MM-DD');
const minDate = today; // æœ€å°å¯é€‰æ—¥æœŸä¸ºä»Šå¤©

// æ—¥æœŸé€‰æ‹©å™¨é…ç½®
<DatePicker 
  minDate={minDate}
  format="YYYY-MM-DD"
  placeholder="é€‰æ‹©ç”¨é¤æ—¥æœŸ"
/>
```

### 2. æŠ¥é¤æ—¶é—´é™åˆ¶

#### 2.1 é¤æ¬¡æ—¶é—´èŒƒå›´
| é¤æ¬¡ç±»å‹ | æ—¶é—´èŒƒå›´ | è¯´æ˜ |
|---------|---------|------|
| breakfast | 06:00-10:00 | æ—©é¤æ—¶é—´ |
| lunch | 11:00-14:00 | åˆé¤æ—¶é—´ |
| dinner | 17:00-20:00 | æ™šé¤æ—¶é—´ |

#### 2.2 æ—¶é—´éªŒè¯è§„åˆ™
```javascript
// åç«¯éªŒè¯é€»è¾‘
const mealTimeRanges = {
  'breakfast': { start: 6, end: 10 },
  'lunch': { start: 11, end: 14 },
  'dinner': { start: 17, end: 20 }
};

// å¦‚æœæ˜¯å½“å¤©æŠ¥é¤ï¼Œæ£€æŸ¥æ˜¯å¦åœ¨åˆç†æ—¶é—´èŒƒå›´å†…
if (diningMoment.isSame(now, 'day')) {
  const currentHour = now.hour();
  const range = mealTimeRanges[mealType];
  
  if (currentHour < range.start || currentHour > range.end) {
    throw new Error(`ä¸åœ¨${mealTypeName}æ—¶é—´èŒƒå›´å†…ï¼ˆ${range.start}:00-${range.end}:00ï¼‰`);
  }
}
```

### 3. å‰ç«¯è¯·æ±‚å‚æ•°è¦æ±‚

#### 3.1 è¯·æ±‚æ ¼å¼
```javascript
// POST /api/dining/dept-order
{
  "date": "2025-09-11",           // å¿…å¡«ï¼šç”¨é¤æ—¥æœŸ YYYY-MM-DD
  "mealType": "lunch",            // å¿…å¡«ï¼šé¤æ¬¡ç±»å‹
  "memberIds": ["user1", "user2"], // å¿…å¡«ï¼šæˆå‘˜IDåˆ—è¡¨
  "remark": "å¤‡æ³¨ä¿¡æ¯"             // å¯é€‰ï¼šå¤‡æ³¨ï¼Œæœ€å¤š500å­—ç¬¦
}
```

#### 3.2 å‚æ•°éªŒè¯
```javascript
// å‰ç«¯éªŒè¯é€»è¾‘
const validateMealOrder = (orderData) => {
  const errors = [];
  
  // éªŒè¯æ—¥æœŸ
  if (!orderData.date) {
    errors.push('ç”¨é¤æ—¥æœŸä¸èƒ½ä¸ºç©º');
  } else if (moment(orderData.date).isBefore(moment(), 'day')) {
    errors.push('ä¸èƒ½ä¸ºè¿‡å»çš„æ—¥æœŸæŠ¥é¤');
  }
  
  // éªŒè¯é¤æ¬¡ç±»å‹
  const validMealTypes = ['breakfast', 'lunch', 'dinner'];
  if (!validMealTypes.includes(orderData.mealType)) {
    errors.push('é¤æ¬¡ç±»å‹æ— æ•ˆ');
  }
  
  // éªŒè¯æˆå‘˜åˆ—è¡¨
  if (!orderData.memberIds || orderData.memberIds.length === 0) {
    errors.push('è‡³å°‘é€‰æ‹©ä¸€åæˆå‘˜');
  }
  
  // éªŒè¯å¤‡æ³¨é•¿åº¦
  if (orderData.remark && orderData.remark.length > 500) {
    errors.push('å¤‡æ³¨æœ€å¤š500ä¸ªå­—ç¬¦');
  }
  
  return errors;
};
```

## ğŸ• æ—¶é—´å¤„ç†æœ€ä½³å®è·µ

### 1. å‰ç«¯æ—¶é—´å¤„ç†

#### 1.1 ä½¿ç”¨moment-timezone
```javascript
import moment from 'moment-timezone';

// è·å–å½“å‰åŒ—äº¬æ—¶é—´
const now = moment().tz('Asia/Shanghai');

// æ ¼å¼åŒ–æ—¥æœŸ
const today = now.format('YYYY-MM-DD');

// æ£€æŸ¥æ˜¯å¦ä¸ºä»Šå¤©
const isToday = moment(date).isSame(now, 'day');
```

#### 1.2 æ—¶é—´éªŒè¯å·¥å…·å‡½æ•°
```javascript
// æ—¶é—´éªŒè¯å·¥å…·ç±»
class TimeValidator {
  // æ£€æŸ¥æ˜¯å¦å¯ä»¥æŠ¥é¤
  static canRegisterMeal(date) {
    const beijingDate = moment(date).tz('Asia/Shanghai');
    const today = moment().tz('Asia/Shanghai');
    
    // ä¸èƒ½ä¸ºè¿‡å»çš„æ—¥æœŸæŠ¥é¤
    return !beijingDate.isBefore(today, 'day');
  }
  
  // æ£€æŸ¥æ˜¯å¦åœ¨å°±é¤æ—¶é—´å†…
  static isInDiningTime(mealType, time = null) {
    const checkTime = time ? moment(time).tz('Asia/Shanghai') : moment().tz('Asia/Shanghai');
    const hour = checkTime.hour();
    
    const mealTimeRanges = {
      'breakfast': { start: 6, end: 10 },
      'lunch': { start: 11, end: 14 },
      'dinner': { start: 17, end: 20 }
    };
    
    const timeRange = mealTimeRanges[mealType];
    return timeRange && hour >= timeRange.start && hour <= timeRange.end;
  }
  
  // è·å–é¤æ¬¡æ—¶é—´èŒƒå›´æè¿°
  static getMealTimeRangeDescription(mealType) {
    const mealTimeRanges = {
      'breakfast': '06:00-10:00',
      'lunch': '11:00-14:00',
      'dinner': '17:00-20:00'
    };
    
    return mealTimeRanges[mealType] || 'æœªçŸ¥æ—¶é—´èŒƒå›´';
  }
}
```

### 2. ç”¨æˆ·ä½“éªŒä¼˜åŒ–

#### 2.1 æ™ºèƒ½æ—¥æœŸé€‰æ‹©
```javascript
// æ™ºèƒ½æ—¥æœŸé€‰æ‹©å™¨
const SmartDatePicker = () => {
  const [selectedDate, setSelectedDate] = useState(null);
  const [mealType, setMealType] = useState('lunch');
  
  // è·å–å¯é€‰æ—¥æœŸèŒƒå›´
  const getAvailableDates = () => {
    const dates = [];
    const today = moment().tz('Asia/Shanghai');
    
    // æä¾›æœªæ¥7å¤©çš„é€‰æ‹©
    for (let i = 0; i < 7; i++) {
      const date = today.clone().add(i, 'days');
      dates.push({
        value: date.format('YYYY-MM-DD'),
        label: date.format('MMæœˆDDæ—¥'),
        disabled: i === 0 && !TimeValidator.isInDiningTime(mealType) // ä»Šå¤©ä¸åœ¨å°±é¤æ—¶é—´å†…åˆ™ç¦ç”¨
      });
    }
    
    return dates;
  };
  
  return (
    <Select 
      options={getAvailableDates()}
      value={selectedDate}
      onChange={setSelectedDate}
      placeholder="é€‰æ‹©ç”¨é¤æ—¥æœŸ"
    />
  );
};
```

#### 2.2 å®æ—¶æ—¶é—´æç¤º
```javascript
// æ—¶é—´æç¤ºç»„ä»¶
const TimeHint = ({ mealType, date }) => {
  const now = moment().tz('Asia/Shanghai');
  const isToday = moment(date).isSame(now, 'day');
  
  if (!isToday) {
    return <div className="time-hint">âœ… å¯ä»¥æŠ¥é¤</div>;
  }
  
  const isInTime = TimeValidator.isInDiningTime(mealType);
  const timeRange = TimeValidator.getMealTimeRangeDescription(mealType);
  
  if (isInTime) {
    return <div className="time-hint success">âœ… å½“å‰æ—¶é—´å¯ä»¥æŠ¥é¤ ({timeRange})</div>;
  } else {
    return <div className="time-hint warning">âš ï¸ å½“å‰æ—¶é—´ä¸åœ¨å°±é¤æ—¶é—´å†… ({timeRange})</div>;
  }
};
```

## ğŸš« å¸¸è§é”™è¯¯å¤„ç†

### 1. é”™è¯¯ç å’Œæ¶ˆæ¯

| é”™è¯¯ç  | é”™è¯¯æ¶ˆæ¯ | è§£å†³æ–¹æ¡ˆ |
|-------|---------|---------|
| 400 | ä¸èƒ½ä¸ºè¿‡å»çš„æ—¥æœŸæŠ¥é¤ | é€‰æ‹©ä»Šå¤©æˆ–æœªæ¥çš„æ—¥æœŸ |
| 400 | ä¸åœ¨æ—©é¤æ—¶é—´èŒƒå›´å†…ï¼ˆ6:00-10:00ï¼‰ | åœ¨å°±é¤æ—¶é—´å†…æŠ¥é¤ |
| 400 | ä¸åœ¨åˆé¤æ—¶é—´èŒƒå›´å†…ï¼ˆ11:00-14:00ï¼‰ | åœ¨å°±é¤æ—¶é—´å†…æŠ¥é¤ |
| 400 | ä¸åœ¨æ™šé¤æ—¶é—´èŒƒå›´å†…ï¼ˆ17:00-20:00ï¼‰ | åœ¨å°±é¤æ—¶é—´å†…æŠ¥é¤ |
| 400 | è‡³å°‘é€‰æ‹©ä¸€åæˆå‘˜ | é€‰æ‹©æŠ¥é¤æˆå‘˜ |
| 400 | å¤‡æ³¨æœ€å¤š500ä¸ªå­—ç¬¦ | ç¼©çŸ­å¤‡æ³¨å†…å®¹ |

### 2. å‰ç«¯é”™è¯¯å¤„ç†
```javascript
// é”™è¯¯å¤„ç†ç¤ºä¾‹
const handleSubmitOrder = async (orderData) => {
  try {
    // å‰ç«¯éªŒè¯
    const errors = validateMealOrder(orderData);
    if (errors.length > 0) {
      showError(errors.join('; '));
      return;
    }
    
    // å‘é€è¯·æ±‚
    const response = await api.post('/api/dining/dept-order', orderData);
    
    if (response.data.success) {
      showSuccess('æŠ¥é¤æˆåŠŸï¼');
    }
  } catch (error) {
    if (error.response?.data?.message) {
      showError(error.response.data.message);
    } else {
      showError('æŠ¥é¤å¤±è´¥ï¼Œè¯·é‡è¯•');
    }
  }
};
```

## ğŸ“± ç§»åŠ¨ç«¯é€‚é…

### 1. æ—¶é—´é€‰æ‹©å™¨ä¼˜åŒ–
```javascript
// ç§»åŠ¨ç«¯å‹å¥½çš„æ—¶é—´é€‰æ‹©
const MobileTimePicker = () => {
  return (
    <div className="mobile-time-picker">
      <DatePicker
        mode="date"
        format="YYYY-MM-DD"
        minDate={moment().format('YYYY-MM-DD')}
        showToday={false}
        placeholder="é€‰æ‹©æ—¥æœŸ"
      />
      
      <TimePicker
        mode="time"
        format="HH:mm"
        minuteStep={30}
        placeholder="é€‰æ‹©æ—¶é—´"
      />
    </div>
  );
};
```

### 2. å“åº”å¼å¸ƒå±€
```css
/* ç§»åŠ¨ç«¯æ—¶é—´é€‰æ‹©å™¨æ ·å¼ */
.mobile-time-picker {
  display: flex;
  flex-direction: column;
  gap: 16px;
}

@media (min-width: 768px) {
  .mobile-time-picker {
    flex-direction: row;
    gap: 24px;
  }
}
```

## ğŸ”§ é…ç½®å»ºè®®

### 1. ç¯å¢ƒé…ç½®
```javascript
// æ—¶åŒºé…ç½®
const TIMEZONE = 'Asia/Shanghai';

// é¤æ¬¡æ—¶é—´é…ç½®
const MEAL_TIME_RANGES = {
  breakfast: { start: 6, end: 10 },
  lunch: { start: 11, end: 14 },
  dinner: { start: 17, end: 20 }
};

// æŠ¥é¤é™åˆ¶é…ç½®
const MEAL_ORDER_LIMITS = {
  maxAdvanceDays: 7,        // æœ€å¤šæå‰7å¤©æŠ¥é¤
  maxMembersPerOrder: 50,    // å•æ¬¡æœ€å¤š50äºº
  maxRemarkLength: 500       // å¤‡æ³¨æœ€å¤š500å­—ç¬¦
};
```

### 2. å›½é™…åŒ–æ”¯æŒ
```javascript
// å¤šè¯­è¨€æ—¶é—´æ ¼å¼
const TIME_FORMATS = {
  'zh-CN': 'YYYYå¹´MMæœˆDDæ—¥',
  'en-US': 'MM/DD/YYYY',
  'zh-TW': 'YYYYå¹´MMæœˆDDæ—¥'
};

// é¤æ¬¡åç§°å¤šè¯­è¨€
const MEAL_TYPE_NAMES = {
  'zh-CN': {
    breakfast: 'æ—©é¤',
    lunch: 'åˆé¤',
    dinner: 'æ™šé¤'
  },
  'en-US': {
    breakfast: 'Breakfast',
    lunch: 'Lunch',
    dinner: 'Dinner'
  }
};
```

## ğŸ“ æ€»ç»“

å‰ç«¯åœ¨å‘èµ·æŠ¥é¤è¯·æ±‚æ—¶éœ€è¦éµå¾ªä»¥ä¸‹æ—¶é—´è¦æ±‚ï¼š

1. **æ—¥æœŸé™åˆ¶**ï¼šä¸èƒ½ä¸ºè¿‡å»çš„æ—¥æœŸæŠ¥é¤ï¼Œåªèƒ½é€‰æ‹©ä»Šå¤©åŠæœªæ¥çš„æ—¥æœŸ
2. **æ—¶é—´èŒƒå›´**ï¼šå¦‚æœé€‰æ‹©ä»Šå¤©æŠ¥é¤ï¼Œéœ€è¦åœ¨å¯¹åº”é¤æ¬¡çš„å°±é¤æ—¶é—´å†…
3. **æ ¼å¼è¦æ±‚**ï¼šæ—¥æœŸæ ¼å¼å¿…é¡»ä¸º `YYYY-MM-DD`
4. **éªŒè¯æœºåˆ¶**ï¼šå‰ç«¯éœ€è¦å…ˆè¿›è¡Œå®¢æˆ·ç«¯éªŒè¯ï¼Œåç«¯ä¼šè¿›è¡ŒæœåŠ¡ç«¯éªŒè¯
5. **ç”¨æˆ·ä½“éªŒ**ï¼šæä¾›æ™ºèƒ½çš„æ—¶é—´é€‰æ‹©å™¨å’Œå®æ—¶çš„æ—¶é—´æç¤º

éµå¾ªè¿™äº›è¦æ±‚å¯ä»¥ç¡®ä¿æŠ¥é¤è¯·æ±‚çš„æˆåŠŸæäº¤ï¼Œé¿å…å› æ—¶é—´é—®é¢˜å¯¼è‡´çš„æŠ¥é¤å¤±è´¥ã€‚
