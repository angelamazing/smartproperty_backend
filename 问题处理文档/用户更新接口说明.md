# 用户更新接口说明

## 接口概述

**接口地址**: `PUT /api/admin/users/{userId}`  
**接口描述**: 更新指定用户的信息  
**权限要求**: 系统管理员权限 (`sys_admin`)  
**请求方式**: PUT  

## 请求参数

### 路径参数
| 参数名 | 类型 | 必填 | 说明 |
|--------|------|------|------|
| userId | string | 是 | 用户ID (UUID格式) |

### 请求头
| 参数名 | 类型 | 必填 | 说明 |
|--------|------|------|------|
| Authorization | string | 是 | Bearer token格式的认证令牌 |
| Content-Type | string | 是 | application/json |

### 请求体参数
| 参数名 | 类型 | 必填 | 说明 | 验证规则 |
|--------|------|------|------|----------|
| nickName | string | 否 | 用户昵称 | 最大50字符 |
| phoneNumber | string | 否 | 手机号码 | 中国大陆手机号格式 |
| email | string | 否 | 邮箱地址 | 有效邮箱格式 |
| gender | number | 否 | 性别 | 0-未知, 1-男, 2-女 |
| departmentId | string | 否 | 部门ID | UUID格式，必须存在于departments表 |
| department | string | 否 | 部门名称 | 最大100字符 |
| role | string | 否 | 用户角色 | user, admin, sys_admin等 |
| status | string | 否 | 用户状态 | active, inactive, pending, suspended |
| avatarUrl | string | 否 | 头像URL | 最大500字符 |
| password | string | 否 | 新密码 | 最少6位字符 |
| joinDate | string | 否 | 入职日期 | YYYY-MM-DD格式，可为空字符串 |
| position | string | 否 | 职位 | 最大100字符 |
| employeeId | string | 否 | 员工编号 | 最大20字符 |
| remark | string | 否 | 备注 | 最大200字符 |

## 响应格式

### 成功响应 (200)
```json
{
  "success": true,
  "message": "更新用户信息成功",
  "code": "200",
  "timestamp": "2025-09-11T05:10:53.123Z",
  "data": {
    "_id": "f65d2db8-3672-46fb-862f-9a7888ad3eb8",
    "openid": null,
    "unionid": null,
    "nickName": "更新后的用户昵称",
    "avatarUrl": null,
    "phoneNumber": "13900139000",
    "email": "user@example.com",
    "gender": 1,
    "country": null,
    "province": null,
    "city": null,
    "language": "zh_CN",
    "department": "技术部",
    "departmentId": "16adc085-6296-483b-93cb-6b06580f961f",
    "role": "user",
    "status": "active",
    "createTime": "2025-09-01T16:59:21.000Z",
    "updateTime": "2025-09-11T05:10:53.000Z",
    "lastLoginTime": "2025-09-10T16:33:35.000Z",
    "isTestUser": 0,
    "isAdminTest": 0,
    "isSysAdminTest": 0,
    "department_name": "技术部",
    "permissions": []
  }
}
```

### 错误响应

#### 参数验证失败 (400)
```json
{
  "success": false,
  "message": "参数验证失败",
  "code": "400",
  "timestamp": "2025-09-11T05:10:53.123Z",
  "error": {
    "errors": [
      {
        "field": "phoneNumber",
        "message": "手机号格式无效",
        "value": "123456789"
      },
      {
        "field": "joinDate",
        "message": "入职日期格式无效",
        "value": "2023/01/01"
      }
    ]
  }
}
```

#### 用户不存在 (404)
```json
{
  "success": false,
  "message": "用户不存在或已被删除",
  "code": "404",
  "timestamp": "2025-09-11T05:10:53.123Z"
}
```

#### 外键约束错误 (500)
```json
{
  "success": false,
  "message": "更新用户信息失败: 部门ID invalid-department-id 不存在",
  "code": "500",
  "timestamp": "2025-09-11T05:10:53.123Z"
}
```

#### 权限不足 (403)
```json
{
  "success": false,
  "message": "权限不足",
  "code": "403",
  "timestamp": "2025-09-11T05:10:53.123Z"
}
```

## 用户角色说明

### 系统角色类型
| 角色代码 | 角色名称 | 权限范围 | 说明 |
|----------|----------|----------|------|
| sys_admin | 系统管理员 | 全系统 | 拥有系统所有权限，可以管理所有用户和系统设置 |
| admin | 管理员 | 指定功能 | 可以管理指定功能模块和用户 |
| user | 普通用户 | 基础功能 | 只能使用基础功能，如查看菜单、报餐等 |
| dept_admin | 部门管理员 | 本部门 | 只能管理本部门用户和查看统计数据 |

### 角色权限等级
1. **系统管理员** (`sys_admin`) - 最高权限
   - 可以管理所有用户
   - 可以创建、修改、删除角色
   - 可以管理系统设置
   - 可以查看所有统计数据

2. **管理员** (`admin`) - 中等权限
   - 可以管理指定模块的用户
   - 可以查看相关统计数据
   - 不能修改系统级设置

3. **部门管理员** (`dept_admin`) - 部门级权限
   - 只能管理本部门用户
   - 可以查看本部门统计数据
   - 不能跨部门操作

4. **普通用户** (`user`) - 基础权限
   - 只能使用基础功能
   - 可以查看个人信息
   - 可以报餐、查看菜单等

## 使用示例

### JavaScript/Axios 示例
```javascript
const updateUser = async (userId, userData) => {
  try {
    const token = localStorage.getItem('adminToken');
    
    const response = await axios.put(
      `http://localhost:3000/api/admin/users/${userId}`,
      userData,
      {
        headers: {
          'Authorization': `Bearer ${token}`,
          'Content-Type': 'application/json'
        }
      }
    );
    
    console.log('用户更新成功:', response.data);
    return response.data;
  } catch (error) {
    console.error('用户更新失败:', error.response?.data || error.message);
    throw error;
  }
};

// 使用示例
const userData = {
  nickName: '张三',
  phoneNumber: '13900139000',
  email: 'zhangsan@example.com',
  gender: 1,
  departmentId: '16adc085-6296-483b-93cb-6b06580f961f',
  department: '技术部',
  role: 'user',
  status: 'active',
  joinDate: '2023-01-01'
};

updateUser('f65d2db8-3672-46fb-862f-9a7888ad3eb8', userData);
```

### cURL 示例
```bash
curl -X PUT "http://localhost:3000/api/admin/users/f65d2db8-3672-46fb-862f-9a7888ad3eb8" \
  -H "Authorization: Bearer YOUR_TOKEN" \
  -H "Content-Type: application/json" \
  -d '{
    "nickName": "张三",
    "phoneNumber": "13900139000",
    "email": "zhangsan@example.com",
    "gender": 1,
    "departmentId": "16adc085-6296-483b-93cb-6b06580f961f",
    "department": "技术部",
    "role": "user",
    "status": "active",
    "joinDate": "2023-01-01"
  }'
```

## 注意事项

### 1. 权限验证
- 只有系统管理员 (`sys_admin`) 可以调用此接口
- 请求必须携带有效的JWT token
- Token过期需要重新登录获取

### 2. 数据验证
- 所有字段都有相应的格式验证
- `departmentId` 必须存在于 `departments` 表中
- `joinDate` 支持空字符串，格式为 `YYYY-MM-DD`
- 手机号和邮箱格式必须正确

### 3. 外键约束
- `departmentId` 字段有外键约束，必须引用有效的部门ID
- 如果部门ID不存在，会返回友好的错误信息

### 4. 密码更新
- 如果提供 `password` 字段，密码会被加密存储
- 建议密码长度至少6位

### 5. 角色分配
- 角色必须是系统中已存在的角色
- 角色变更会影响用户的权限范围
- 系统管理员角色具有最高权限

### 6. 状态管理
- 用户状态包括：`active`(活跃)、`inactive`(非活跃)、`pending`(待审核)、`suspended`(暂停)
- 只有活跃用户可以正常使用系统功能

## 错误处理建议

1. **参数验证错误**: 检查请求参数格式是否正确
2. **权限不足**: 确认用户具有系统管理员权限
3. **用户不存在**: 检查用户ID是否正确
4. **外键约束错误**: 确认部门ID是否存在于系统中
5. **网络错误**: 检查网络连接和服务器状态

## 相关接口

- `GET /api/admin/users` - 获取用户列表
- `GET /api/admin/users/{userId}` - 获取用户详情
- `POST /api/admin/users` - 创建用户
- `DELETE /api/admin/users/{userId}` - 删除用户
- `GET /api/admin/roles` - 获取角色列表
- `GET /api/department/list` - 获取部门列表
