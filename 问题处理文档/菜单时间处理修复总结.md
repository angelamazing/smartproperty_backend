# èœå•æ—¶é—´å¤„ç†ä¿®å¤æ€»ç»“

## ğŸ¯ ä¿®å¤ç›®æ ‡

ä¿®å¤èœå•å‘å¸ƒè¿‡ç¨‹ä¸­çš„æ—¶é—´å­˜å‚¨å’Œè½¬æ¢é—®é¢˜ï¼Œä½¿å…¶ç¬¦åˆé¡¹ç›®çš„ç»Ÿä¸€æ—¶é—´å¤„ç†è§„èŒƒã€‚

## ğŸ” é—®é¢˜åˆ†æ

### ä¿®å¤å‰çš„é—®é¢˜
1. **æ—¶åŒºå¤„ç†ä¸ä¸€è‡´**ï¼š
   - æ§åˆ¶å™¨ä½¿ç”¨ `new Date()`ï¼ˆæœåŠ¡å™¨æœ¬åœ°æ—¶é—´ï¼‰
   - æ•°æ®åº“ä½¿ç”¨ `NOW()`ï¼ˆæ•°æ®åº“æœåŠ¡å™¨æ—¶é—´ï¼‰
   - å¯èƒ½å¯¼è‡´æ—¶é—´ä¸ä¸€è‡´

2. **æœªä½¿ç”¨ç»Ÿä¸€æ—¶é—´å·¥å…·**ï¼š
   - é¡¹ç›®æœ‰ `TimeUtils` å·¥å…·ç±»ï¼Œä½†èœå•å‘å¸ƒæµç¨‹ä¸­æœªä½¿ç”¨
   - è¿åäº†é¡¹ç›®çš„æ—¶é—´å¤„ç†è§„èŒƒ

3. **publishTime å’Œ effectiveTime å¤„ç†ä¸å®Œæ•´**ï¼š
   - `effectiveTime` å­—æ®µåœ¨å‘å¸ƒæµç¨‹ä¸­æœªè¢«è®¾ç½®
   - `publishTime` çš„è®¾ç½®æ–¹å¼ä¸ç¬¦åˆé¡¹ç›®è§„èŒƒ

## ğŸ› ï¸ ä¿®å¤å†…å®¹

### 0. æ•°æ®åº“ç»“æ„ä¿®å¤

#### é—®é¢˜å‘ç°
åœ¨æµ‹è¯•è¿‡ç¨‹ä¸­å‘ç°æ•°æ®åº“ `menus` è¡¨ç¼ºå°‘ `publishTime` å’Œ `effectiveTime` å­—æ®µï¼Œå¯¼è‡´å‡ºç°é”™è¯¯ï¼š
```
"Unknown column 'publishTime' in 'field list'"
```

#### ä¿®å¤æ–¹æ¡ˆ
```sql
-- æ·»åŠ å‘å¸ƒæ—¶é—´å­—æ®µ
ALTER TABLE menus ADD COLUMN publishTime TIMESTAMP NULL COMMENT 'å‘å¸ƒæ—¶é—´';

-- æ·»åŠ ç”Ÿæ•ˆæ—¶é—´å­—æ®µ  
ALTER TABLE menus ADD COLUMN effectiveTime TIMESTAMP NULL COMMENT 'ç”Ÿæ•ˆæ—¶é—´';

-- æ·»åŠ ç´¢å¼•æé«˜æŸ¥è¯¢æ€§èƒ½
ALTER TABLE menus ADD INDEX idx_publish_time (publishTime);
ALTER TABLE menus ADD INDEX idx_effective_time (effectiveTime);
```

#### ä¿®å¤ç»“æœ
- âœ… `publishTime` å­—æ®µæ·»åŠ æˆåŠŸ
- âœ… `effectiveTime` å­—æ®µæ·»åŠ æˆåŠŸ
- âœ… ç›¸å…³ç´¢å¼•åˆ›å»ºæˆåŠŸ
- âœ… æµ‹è¯•æ’å…¥å’Œæ›´æ–°æ“ä½œæ­£å¸¸

### 1. æ§åˆ¶å™¨å±‚ä¿®å¤ (`controllers/adminController.js`)

#### ä¿®å¤å‰ï¼š
```javascript
const publishMenu = async (req, res) => {
  try {
    const menuData = {
      ...req.body,
      adminId: req.user.id,
      status: 'published',
      publishTime: new Date()  // ç›´æ¥ä½¿ç”¨ JavaScript Date å¯¹è±¡
    };
    // ...
  }
};
```

#### ä¿®å¤åï¼š
```javascript
const publishMenu = async (req, res) => {
  try {
    const TimeUtils = require('../utils/timeUtils');
    
    // ä½¿ç”¨ç»Ÿä¸€çš„æ—¶é—´å¤„ç†å·¥å…·ç±»
    const now = TimeUtils.getBeijingTime();
    const utcNow = TimeUtils.toUTCForStorage(now);
    
    const menuData = {
      ...req.body,
      adminId: req.user.id,
      status: 'published',
      publishTime: utcNow,
      // å¦‚æœå‰ç«¯æä¾›äº†ç”Ÿæ•ˆæ—¶é—´ï¼Œåˆ™ä½¿ç”¨å‰ç«¯æ—¶é—´ï¼Œå¦åˆ™ä½¿ç”¨å½“å‰æ—¶é—´
      effectiveTime: req.body.effectiveTime ? 
        TimeUtils.toUTCForStorage(req.body.effectiveTime) : 
        utcNow
    };
    
    // éªŒè¯æ—¶é—´å‚æ•°
    if (req.body.effectiveTime && TimeUtils.isPastDate(req.body.effectiveTime)) {
      return ResponseHelper.error(res, 'ç”Ÿæ•ˆæ—¶é—´ä¸èƒ½æ˜¯è¿‡å»çš„æ—¥æœŸ', 400);
    }
    // ...
  }
};
```

### 2. æœåŠ¡å±‚ä¿®å¤ (`services/adminService.js`)

#### ä¿®å¤å‰ï¼š
```javascript
// ä½¿ç”¨æ•°æ®åº“çš„ NOW() å‡½æ•°
await connection.execute(
  'UPDATE menus SET publishStatus = "published", updateTime = NOW() WHERE _id = ?',
  [menuId]
);
```

#### ä¿®å¤åï¼š
```javascript
// ä½¿ç”¨ç»Ÿä¸€çš„æ—¶é—´å¤„ç†ï¼Œè®¾ç½®å‘å¸ƒæ—¶é—´å’Œç”Ÿæ•ˆæ—¶é—´
await connection.execute(
  'UPDATE menus SET publishStatus = "published", publishTime = ?, effectiveTime = ?, updateTime = ? WHERE _id = ?',
  [publishTime, effectiveTime, publishTime, menuId]
);
```

### 3. èœå•è‰ç¨¿ä¿å­˜ä¿®å¤

#### ä¿®å¤å‰ï¼š
```javascript
// æ··åˆä½¿ç”¨ JavaScript Date å’Œ MySQL NOW() å‡½æ•°
await connection.execute(
  'INSERT INTO menus (_id, publishDate, mealType, description, publishStatus, publisherId, createTime) VALUES (?, ?, ?, ?, ?, ?, NOW())',
  [menuId, date, mealType, description, 'draft', adminId]
);
```

#### ä¿®å¤åï¼š
```javascript
const now = TimeUtils.toUTCForStorage(TimeUtils.getBeijingTime());

await connection.execute(
  'INSERT INTO menus (_id, publishDate, mealType, description, publishStatus, publisherId, createTime, updateTime) VALUES (?, ?, ?, ?, ?, ?, ?, ?)',
  [menuId, date, mealType, description, 'draft', adminId, now, now]
);
```

## âœ… ä¿®å¤æ•ˆæœ

### ä¿®å¤åçš„ä¼˜åŠ¿
1. **ç»Ÿä¸€æ—¶é—´å¤„ç†**ï¼š
   - âœ… ä½¿ç”¨ `TimeUtils` å·¥å…·ç±»ç»Ÿä¸€å¤„ç†æ—¶é—´
   - âœ… éµå¾ªé¡¹ç›®çš„æ—¶é—´å¤„ç†è§„èŒƒ
   - âœ… ç¡®ä¿æ—¶åŒºè½¬æ¢çš„ä¸€è‡´æ€§

2. **å®Œæ•´çš„æ—¶é—´å­—æ®µå¤„ç†**ï¼š
   - âœ… æ­£ç¡®è®¾ç½® `publishTime` å‘å¸ƒæ—¶é—´
   - âœ… æ­£ç¡®è®¾ç½® `effectiveTime` ç”Ÿæ•ˆæ—¶é—´
   - âœ… æ”¯æŒå‰ç«¯ä¼ å…¥è‡ªå®šä¹‰ç”Ÿæ•ˆæ—¶é—´

3. **æ—¶é—´éªŒè¯**ï¼š
   - âœ… éªŒè¯å‘å¸ƒæ—¥æœŸä¸èƒ½æ˜¯è¿‡å»çš„æ—¥æœŸ
   - âœ… éªŒè¯ç”Ÿæ•ˆæ—¶é—´ä¸èƒ½æ˜¯è¿‡å»çš„æ—¥æœŸ
   - âœ… æä¾›æ¸…æ™°çš„é”™è¯¯æç¤º

4. **APIæ ¼å¼ç»Ÿä¸€**ï¼š
   - âœ… æ¥å£äº¤äº’ä½¿ç”¨ISO 8601æ ¼å¼
   - âœ… å‰ç«¯æ˜¾ç¤ºåŒ—äº¬æ—¶é—´
   - âœ… åç«¯å­˜å‚¨UTCæ—¶é—´

## ğŸ“Š æ—¶é—´å¤„ç†æµç¨‹

### ä¿®å¤åçš„å®Œæ•´æµç¨‹
```
ç”¨æˆ·æ“ä½œ(åŒ—äº¬æ—¶é—´) â†’ å‰ç«¯éªŒè¯ â†’ åç«¯ç»Ÿä¸€æ—¶é—´å¤„ç† â†’ UTCå­˜å‚¨ â†’ APIè¿”å›UTC â†’ å‰ç«¯è½¬æ¢ä¸ºåŒ—äº¬æ—¶é—´æ˜¾ç¤º
```

### å…·ä½“æ­¥éª¤
1. **å‰ç«¯æäº¤**ï¼šç”¨æˆ·é€‰æ‹©å‘å¸ƒæ—¥æœŸå’Œç”Ÿæ•ˆæ—¶é—´
2. **æ§åˆ¶å™¨éªŒè¯**ï¼šä½¿ç”¨ `TimeUtils.isPastDate()` éªŒè¯æ—¥æœŸ
3. **æ—¶é—´è½¬æ¢**ï¼šä½¿ç”¨ `TimeUtils.toUTCForStorage()` è½¬æ¢ä¸ºUTCæ—¶é—´
4. **æ•°æ®åº“å­˜å‚¨**ï¼šå­˜å‚¨UTCæ—¶é—´åˆ°TIMESTAMPå­—æ®µ
5. **APIè¿”å›**ï¼šè¿”å›ISO 8601æ ¼å¼çš„UTCæ—¶é—´
6. **å‰ç«¯æ˜¾ç¤º**ï¼šä½¿ç”¨ `TimeUtils.toBeijingForDisplay()` è½¬æ¢ä¸ºåŒ—äº¬æ—¶é—´

## ğŸ§ª æµ‹è¯•éªŒè¯

### æµ‹è¯•è„šæœ¬
åˆ›å»ºäº† `scripts/test-menu-time-fix.js` æµ‹è¯•è„šæœ¬ï¼ŒéªŒè¯ï¼š
- âœ… æ—¶é—´å·¥å…·ç±»åŠŸèƒ½æ­£å¸¸
- âœ… èœå•è‰ç¨¿åˆ›å»ºæ—¶é—´æ­£ç¡®
- âœ… èœå•å‘å¸ƒæ—¶é—´è®¾ç½®æ­£ç¡®
- âœ… æ—¶é—´è½¬æ¢æ˜¾ç¤ºæ­£ç¡®

### è¿è¡Œæµ‹è¯•
```bash
node scripts/test-menu-time-fix.js
```

## ğŸ“ æ–‡æ¡£æ›´æ–°

### README.md æ›´æ–°å†…å®¹
1. âœ… æ·»åŠ èœå•ç®¡ç†ç³»ç»Ÿè¯´æ˜
2. âœ… æ·»åŠ èœå•æ—¶é—´å¤„ç†ç‰¹ç‚¹
3. âœ… æ·»åŠ èœå•æ—¶é—´å¤„ç†ç¤ºä¾‹ä»£ç 
4. âœ… æ·»åŠ æµ‹è¯•è„šæœ¬è¯´æ˜

## ğŸ‰ æ€»ç»“

é€šè¿‡è¿™æ¬¡ä¿®å¤ï¼Œèœå•å‘å¸ƒæµç¨‹ç°åœ¨å®Œå…¨ç¬¦åˆé¡¹ç›®çš„ç»Ÿä¸€æ—¶é—´å¤„ç†è§„èŒƒï¼š

1. **ä¸€è‡´æ€§**ï¼šæ‰€æœ‰æ—¶é—´æ“ä½œéƒ½ä½¿ç”¨ç»Ÿä¸€çš„æ—¶é—´å·¥å…·ç±»
2. **å‡†ç¡®æ€§**ï¼šæ­£ç¡®çš„UTCæ—¶é—´å­˜å‚¨å’ŒåŒ—äº¬æ—¶é—´æ˜¾ç¤º
3. **å®Œæ•´æ€§**ï¼šæ”¯æŒå‘å¸ƒæ—¶é—´å’Œç”Ÿæ•ˆæ—¶é—´çš„å®Œæ•´è®¾ç½®
4. **å¯é æ€§**ï¼šæ·»åŠ äº†æ—¶é—´éªŒè¯å’Œé”™è¯¯å¤„ç†
5. **å¯ç»´æŠ¤æ€§**ï¼šä»£ç ç»“æ„æ¸…æ™°ï¼Œæ˜“äºç†è§£å’Œç»´æŠ¤

èœå•å‘å¸ƒæµç¨‹ç°åœ¨ä¸é¡¹ç›®çš„å…¶ä»–æ—¶é—´å¤„ç†åŠŸèƒ½ä¿æŒä¸€è‡´ï¼Œç¡®ä¿äº†æ•´ä¸ªç³»ç»Ÿçš„æ—¶é—´å¤„ç†ç»Ÿä¸€æ€§å’Œå‡†ç¡®æ€§ã€‚
