# 新建部门接口文档

## 概述
本文档描述了系统中新建部门的相关API接口，包括接口地址、请求参数、响应格式等详细信息。

## 接口列表

### 1. 创建部门（系统管理员权限）

**接口地址**: `POST /api/department`

**权限要求**: 需要系统管理员权限（sys_admin）

**请求头**:
```
Authorization: Bearer <token>
Content-Type: application/json
```

**请求体参数**:
```json
{
  "name": "新部门名称",
  "code": "NEW_DEPT",
  "description": "部门描述",
  "parentId": "parent-dept-id",
  "level": 1
}
```

**参数说明**:
| 参数名 | 类型 | 必填 | 说明 | 示例值 |
|--------|------|------|------|--------|
| name | string | 是 | 部门名称，2-100个字符 | "技术开发部" |
| code | string | 是 | 部门编码，2-20个字符，只能包含大写字母和下划线 | "TECH_DEV" |
| description | string | 否 | 部门描述，最多200个字符 | "负责技术开发工作" |
| parentId | string | 否 | 上级部门ID，36位UUID格式 | "dept-001" |
| level | number | 否 | 部门级别，默认为1 | 1 |

**成功响应**:
```json
{
  "success": true,
  "data": {
    "_id": "new-dept-id",
    "name": "技术开发部",
    "code": "TECH_DEV",
    "description": "负责技术开发工作",
    "parentId": "dept-001",
    "level": 1,
    "status": "active"
  },
  "message": "创建部门成功"
}
```

**错误响应**:
```json
{
  "success": false,
  "message": "部门编码已存在",
  "error": "Validation Error",
  "validationErrors": [
    {
      "field": "code",
      "message": "部门编码已存在",
      "value": "TECH_DEV"
    }
  ]
}
```

### 2. 创建部门（管理员权限）

**接口地址**: `POST /api/admin/departments`

**权限要求**: 需要管理员权限（admin）

**请求头**:
```
Authorization: Bearer <token>
Content-Type: application/json
```

**请求体参数**:
```json
{
  "name": "新部门名称",
  "description": "部门描述",
  "parentId": "parent-dept-id",
  "managerId": "manager-user-id",
  "sort": 0,
  "status": "active"
}
```

**参数说明**:
| 参数名 | 类型 | 必填 | 说明 | 示例值 |
|--------|------|------|------|--------|
| name | string | 是 | 部门名称，最多100个字符 | "市场营销部" |
| description | string | 否 | 部门描述，最多200个字符 | "负责市场推广工作" |
| parentId | string | 否 | 上级部门ID，最多36个字符 | "dept-001" |
| managerId | string | 否 | 部门管理员ID，最多36个字符 | "user-001" |
| sort | number | 否 | 排序值，非负整数，默认为0 | 0 |
| status | string | 否 | 部门状态，可选值：active/inactive，默认为active | "active" |

**成功响应**:
```json
{
  "success": true,
  "data": {
    "id": "new-dept-id",
    "name": "市场营销部",
    "description": "负责市场推广工作",
    "status": "active"
  },
  "message": "创建部门成功"
}
```

## 验证规则

### 系统管理员接口验证规则
- **name**: 必填，2-100个字符
- **code**: 必填，2-20个字符，只能包含大写字母和下划线
- **description**: 可选，最多200个字符
- **parentId**: 可选，36位UUID格式
- **level**: 可选，数字类型，默认为1

### 管理员接口验证规则
- **name**: 必填，最多100个字符
- **description**: 可选，最多200个字符
- **parentId**: 可选，最多36个字符
- **managerId**: 可选，最多36个字符
- **sort**: 可选，非负整数
- **status**: 可选，枚举值：active/inactive

## 错误处理

### 常见错误码

| 错误码 | 错误信息 | 说明 | 解决方案 |
|--------|----------|------|----------|
| 400 | 部门名称和编码不能为空 | 必填字段缺失 | 检查name和code字段 |
| 400 | 部门编码已存在 | 编码重复 | 使用唯一的部门编码 |
| 401 | 请先登录 | 未提供有效的认证token | 重新登录获取token |
| 403 | 权限不足，需要系统管理员权限 | 权限不足 | 使用系统管理员账号 |
| 422 | 参数验证失败 | 请求参数格式错误 | 检查参数格式和类型 |
| 500 | 创建部门失败 | 服务器内部错误 | 联系技术支持 |

### 错误响应示例

**参数验证失败**:
```json
{
  "success": false,
  "message": "参数验证失败",
  "error": "Validation Error",
  "validationErrors": [
    {
      "field": "name",
      "message": "部门名称至少2个字符",
      "value": "A"
    },
    {
      "field": "code",
      "message": "部门编码只能包含大写字母和下划线",
      "value": "tech-dev"
    }
  ]
}
```

**权限不足**:
```json
{
  "success": false,
  "message": "权限不足，需要系统管理员权限",
  "error": "Forbidden",
  "statusCode": 403
}
```

## 前端集成示例

### 1. 创建部门表单组件

```javascript
// 创建部门表单组件
const CreateDepartmentForm = ({ onSubmit, onCancel }) => {
  const [formData, setFormData] = useState({
    name: '',
    code: '',
    description: '',
    parentId: '',
    level: 1
  });
  
  const [loading, setLoading] = useState(false);
  const [errors, setErrors] = useState({});
  
  const handleSubmit = async (e) => {
    e.preventDefault();
    setLoading(true);
    setErrors({});
    
    try {
      await onSubmit(formData);
      // 重置表单
      setFormData({
        name: '',
        code: '',
        description: '',
        parentId: '',
        level: 1
      });
    } catch (error) {
      if (error.validationErrors) {
        const errorMap = {};
        error.validationErrors.forEach(err => {
          errorMap[err.field] = err.message;
        });
        setErrors(errorMap);
      }
    } finally {
      setLoading(false);
    }
  };
  
  return (
    <form onSubmit={handleSubmit}>
      <div>
        <label>部门名称 *</label>
        <input
          type="text"
          value={formData.name}
          onChange={(e) => setFormData({...formData, name: e.target.value})}
          placeholder="请输入部门名称"
          maxLength={100}
        />
        {errors.name && <span className="error">{errors.name}</span>}
      </div>
      
      <div>
        <label>部门编码 *</label>
        <input
          type="text"
          value={formData.code}
          onChange={(e) => setFormData({...formData, code: e.target.value.toUpperCase()})}
          placeholder="请输入部门编码（大写字母和下划线）"
          maxLength={20}
          pattern="[A-Z_]+"
        />
        {errors.code && <span className="error">{errors.code}</span>}
      </div>
      
      <div>
        <label>部门描述</label>
        <textarea
          value={formData.description}
          onChange={(e) => setFormData({...formData, description: e.target.value})}
          placeholder="请输入部门描述"
          maxLength={200}
          rows={3}
        />
        {errors.description && <span className="error">{errors.description}</span>}
      </div>
      
      <div>
        <label>上级部门</label>
        <select
          value={formData.parentId}
          onChange={(e) => setFormData({...formData, parentId: e.target.value})}
        >
          <option value="">无上级部门</option>
          {/* 这里应该从部门列表API获取 */}
        </select>
      </div>
      
      <div>
        <label>部门级别</label>
        <input
          type="number"
          value={formData.level}
          onChange={(e) => setFormData({...formData, level: parseInt(e.target.value)})}
          min={1}
          max={10}
        />
      </div>
      
      <div className="form-actions">
        <button type="button" onClick={onCancel}>取消</button>
        <button type="submit" disabled={loading}>
          {loading ? '创建中...' : '创建部门'}
        </button>
      </div>
    </form>
  );
};
```

### 2. 创建部门API调用

```javascript
// 创建部门API调用函数
const createDepartment = async (departmentData) => {
  try {
    const response = await fetch('/api/department', {
      method: 'POST',
      headers: {
        'Authorization': `Bearer ${token}`,
        'Content-Type': 'application/json'
      },
      body: JSON.stringify(departmentData)
    });
    
    const result = await response.json();
    
    if (result.success) {
      message.success('部门创建成功');
      return result.data;
    } else {
      throw new Error(result.message);
    }
  } catch (error) {
    console.error('创建部门失败:', error);
    throw error;
  }
};

// 使用示例
const handleCreateDepartment = async (formData) => {
  try {
    const newDepartment = await createDepartment(formData);
    console.log('新部门:', newDepartment);
    // 刷新部门列表
    refreshDepartmentList();
  } catch (error) {
    message.error(error.message);
  }
};
```

### 3. 部门编码验证

```javascript
// 部门编码验证函数
const validateDepartmentCode = (code) => {
  const pattern = /^[A-Z_]+$/;
  if (!pattern.test(code)) {
    return '部门编码只能包含大写字母和下划线';
  }
  if (code.length < 2 || code.length > 20) {
    return '部门编码长度必须在2-20个字符之间';
  }
  return null;
};

// 实时验证
const handleCodeChange = (value) => {
  const upperValue = value.toUpperCase();
  const error = validateDepartmentCode(upperValue);
  setErrors(prev => ({
    ...prev,
    code: error
  }));
  setFormData(prev => ({
    ...prev,
    code: upperValue
  }));
};
```

## 数据库表结构

### departments表字段说明

| 字段名 | 类型 | 说明 | 约束 |
|--------|------|------|------|
| _id | varchar(36) | 部门ID | 主键，UUID |
| name | varchar(100) | 部门名称 | 必填，唯一 |
| code | varchar(20) | 部门编码 | 必填，唯一 |
| description | text | 部门描述 | 可选 |
| parentId | varchar(36) | 上级部门ID | 外键，可选 |
| level | int | 部门级别 | 默认1 |
| managerId | varchar(36) | 部门管理员ID | 外键，可选 |
| status | enum | 部门状态 | active/inactive，默认active |
| createTime | timestamp | 创建时间 | 自动生成 |
| updateTime | timestamp | 更新时间 | 自动更新 |
| sort | int | 排序值 | 默认0 |

## 注意事项

1. **权限控制**: 只有系统管理员可以创建部门
2. **编码唯一性**: 部门编码必须唯一，不能重复
3. **编码格式**: 部门编码只能包含大写字母和下划线
4. **层级关系**: 支持多级部门结构，通过parentId建立层级关系
5. **软删除**: 删除部门时使用软删除，将状态设置为inactive
6. **数据完整性**: 创建部门时会自动设置创建时间和状态

## 更新日志

- **2024-01-15**: 初始版本，支持基本的部门创建功能
- **2024-01-15**: 添加详细的验证规则和错误处理
- **2024-01-15**: 完善前端集成示例和文档

---

**文档版本**: v1.0  
**最后更新**: 2024-01-15  
**维护人员**: 开发团队
