# æ—¶é—´è½¬æ¢æ£€æŸ¥æŠ¥å‘Š

## ğŸ“‹ æ£€æŸ¥æ¦‚è¿°

æœ¬æ¬¡æ£€æŸ¥äº†æ‰€æœ‰ä»£ç ä¸­çš„æ—¶é—´å¤„ç†é€»è¾‘ï¼Œç¡®ä¿æ—¶åŒºè½¬æ¢çš„ä¸€è‡´æ€§ã€‚ä¸»è¦æ£€æŸ¥äº†ä»¥ä¸‹æ–¹é¢ï¼š
- æ‰«ç æ—¶é—´å¤„ç†
- æŠ¥é¤æ—¶é—´å¤„ç†
- ç¡®è®¤å°±é¤æ—¶é—´å¤„ç†
- ç»Ÿè®¡æŸ¥è¯¢æ—¶é—´å¤„ç†
- è®¤è¯ç›¸å…³æ—¶é—´å¤„ç†

## âœ… å·²ä¿®å¤çš„æ—¶é—´å¤„ç†

### 1. æ‰«ç æœåŠ¡ (qrScanService.js)

#### 1.1 é¤æ¬¡åˆ¤æ–­é€»è¾‘
```javascript
// ä¿®å¤å‰
getMealTypeByTime(scanTime) {
  const hour = moment(scanTime).hour();
  // ...
}

// ä¿®å¤å
getMealTypeByTime(scanTime) {
  const beijingTime = moment(scanTime).tz('Asia/Shanghai');
  const hour = beijingTime.hour();
  // ...
}
```

#### 1.2 æ‰«ç å¤„ç†é€»è¾‘
```javascript
// ä¿®å¤å‰
const mealType = this.getMealTypeByTime(scanTime);
const diningDate = moment(scanTime).format('YYYY-MM-DD');

// ä¿®å¤å
const beijingScanTime = moment(scanTime).tz('Asia/Shanghai');
const mealType = this.getMealTypeByTime(beijingScanTime.toDate());
const diningDate = beijingScanTime.format('YYYY-MM-DD');
```

#### 1.3 æ•°æ®åº“å­˜å‚¨
```javascript
// ä¿®å¤å‰
scanTime,  // ç›´æ¥å­˜å‚¨ç”¨æˆ·æ—¶é—´

// ä¿®å¤å
const utcScanTime = moment(scanTime).utc().toDate();
utcScanTime,  // å­˜å‚¨UTCæ—¶é—´
```

#### 1.4 è¿”å›ç»“æœ
```javascript
// ä¿®å¤å‰
scanTime: moment(scanTime).format('YYYY-MM-DD HH:mm:ss'),

// ä¿®å¤å
scanTime: beijingScanTime.format('YYYY-MM-DD HH:mm:ss'),
```

### 2. æ‰«ç æ§åˆ¶å™¨ (qrScanController.js)

#### 2.1 æ—¶é—´éªŒè¯
```javascript
// ä¿®å¤å‰
const scanTimeMoment = moment(scanTime);
const result = await qrScanService.processQRScan(
  userId, qrCode, scanTimeMoment.toDate(), req.db
);

// ä¿®å¤å
const scanTimeMoment = moment(scanTime);
const beijingScanTime = scanTimeMoment.tz('Asia/Shanghai');
const result = await qrScanService.processQRScan(
  userId, qrCode, beijingScanTime.toDate(), req.db
);
```

#### 2.2 ç»Ÿè®¡æŸ¥è¯¢
```javascript
// ä¿®å¤å‰
const targetDate = date || moment().format('YYYY-MM-DD');
const today = moment().format('YYYY-MM-DD');

// ä¿®å¤å
const targetDate = date || moment().tz('Asia/Shanghai').format('YYYY-MM-DD');
const today = moment().tz('Asia/Shanghai').format('YYYY-MM-DD');
```

### 3. å°±é¤ç¡®è®¤æœåŠ¡ (diningConfirmationService.js)

#### 3.1 ç¡®è®¤æ—¶é—´
```javascript
// ä¿®å¤å‰
const actualDiningTime = moment().format('YYYY-MM-DD HH:mm:ss');

// ä¿®å¤å
const actualDiningTime = moment().tz('Asia/Shanghai').format('YYYY-MM-DD HH:mm:ss');
```

#### 3.2 æŸ¥è¯¢æ—¥æœŸ
```javascript
// ä¿®å¤å‰
const queryDate = date || moment().format('YYYY-MM-DD');

// ä¿®å¤å
const queryDate = date || moment().tz('Asia/Shanghai').format('YYYY-MM-DD');
```

### 4. æŠ¥é¤æœåŠ¡ (diningService.js)

#### 4.1 æ—¥æœŸéªŒè¯
```javascript
// ä¿®å¤å‰
if (moment(date).isBefore(moment().format('YYYY-MM-DD'))) {
  throw new Error('ä¸èƒ½ä¸ºè¿‡å»çš„æ—¥æœŸæŠ¥é¤');
}

// ä¿®å¤å
const today = moment().tz('Asia/Shanghai').format('YYYY-MM-DD');
if (moment(date).isBefore(today)) {
  throw new Error('ä¸èƒ½ä¸ºè¿‡å»çš„æ—¥æœŸæŠ¥é¤');
}
```

#### 4.2 æŸ¥è¯¢æ—¥æœŸ
```javascript
// ä¿®å¤å‰
const queryDate = date || moment().format('YYYY-MM-DD');

// ä¿®å¤å
const queryDate = date || moment().tz('Asia/Shanghai').format('YYYY-MM-DD');
```

### 5. ç®¡ç†å‘˜æœåŠ¡ (adminService.js)

#### 5.1 ç»Ÿè®¡æŸ¥è¯¢
```javascript
// ä¿®å¤å‰
const today = moment().format('YYYY-MM-DD');
const lastMonth = moment().subtract(1, 'month').format('YYYY-MM');
const currentMonth = moment().format('YYYY-MM');

// ä¿®å¤å
const today = moment().tz('Asia/Shanghai').format('YYYY-MM-DD');
const lastMonth = moment().tz('Asia/Shanghai').subtract(1, 'month').format('YYYY-MM');
const currentMonth = moment().tz('Asia/Shanghai').format('YYYY-MM');
```

#### 5.2 æ—¶é—´èŒƒå›´æŸ¥è¯¢
```javascript
// ä¿®å¤å‰
const start = startDate || moment().format('YYYY-MM-01');
const end = endDate || moment().format('YYYY-MM-DD');

// ä¿®å¤å
const start = startDate || moment().tz('Asia/Shanghai').format('YYYY-MM-01');
const end = endDate || moment().tz('Asia/Shanghai').format('YYYY-MM-DD');
```

### 6. è®¤è¯æœåŠ¡ (authService.js)

#### 6.1 Tokenè¿‡æœŸæ—¶é—´
```javascript
// ä¿®å¤å‰
const expireTime = moment().add(config.business.tokenExpiry, 'days').format('YYYY-MM-DD HH:mm:ss');

// ä¿®å¤å
const expireTime = moment().tz('Asia/Shanghai').add(config.business.tokenExpiry, 'days').format('YYYY-MM-DD HH:mm:ss');
```

#### 6.2 éªŒè¯ç è¿‡æœŸæ—¶é—´
```javascript
// ä¿®å¤å‰
const expireTime = moment().add(config.business.verificationCodeExpiry, 'minutes').format('YYYY-MM-DD HH:mm:ss');

// ä¿®å¤å
const expireTime = moment().tz('Asia/Shanghai').add(config.business.verificationCodeExpiry, 'minutes').format('YYYY-MM-DD HH:mm:ss');
```

### 7. å…¶ä»–æ§åˆ¶å™¨

#### 7.1 å°±é¤ç¡®è®¤æ§åˆ¶å™¨
```javascript
// ä¿®å¤å‰
const queryDate = date || new Date().toISOString().split('T')[0];

// ä¿®å¤å
const queryDate = date || moment().tz('Asia/Shanghai').format('YYYY-MM-DD');
```

#### 7.2 æŠ¥é¤æ§åˆ¶å™¨
```javascript
// ä¿®å¤å‰
const statsDate = date || new Date().toISOString().split('T')[0];

// ä¿®å¤å
const statsDate = date || moment().tz('Asia/Shanghai').format('YYYY-MM-DD');
```

## ğŸ”§ æ—¶é—´å¤„ç†åŸåˆ™

### 1. ç»Ÿä¸€æ—¶åŒºæ ‡å‡†
- **ä¸šåŠ¡é€»è¾‘**: ç»Ÿä¸€ä½¿ç”¨åŒ—äº¬æ—¶é—´ (Asia/Shanghai)
- **æ•°æ®åº“å­˜å‚¨**: ç»Ÿä¸€å­˜å‚¨UTCæ—¶é—´
- **å‰ç«¯æ˜¾ç¤º**: ç»Ÿä¸€æ˜¾ç¤ºåŒ—äº¬æ—¶é—´

### 2. æ—¶é—´è½¬æ¢æµç¨‹
```
ç”¨æˆ·è¾“å…¥æ—¶é—´ â†’ è½¬æ¢ä¸ºåŒ—äº¬æ—¶é—´ â†’ ä¸šåŠ¡é€»è¾‘å¤„ç† â†’ è½¬æ¢ä¸ºUTCæ—¶é—´å­˜å‚¨ â†’ è¿”å›åŒ—äº¬æ—¶é—´
```

### 3. å…³é”®æ–¹æ³•
- `moment().tz('Asia/Shanghai')` - è·å–åŒ—äº¬æ—¶é—´
- `moment(time).tz('Asia/Shanghai')` - è½¬æ¢æŒ‡å®šæ—¶é—´ä¸ºåŒ—äº¬æ—¶é—´
- `moment(time).utc().toDate()` - è½¬æ¢ä¸ºUTCæ—¶é—´å­˜å‚¨

## âš ï¸ æ³¨æ„äº‹é¡¹

### 1. æ•°æ®åº“é…ç½®
```javascript
// config/database.js
database: {
  timezone: '+08:00',  // æ•°æ®åº“æ—¶åŒºè®¾ç½®ä¸ºåŒ—äº¬æ—¶é—´
  // ...
}
```

### 2. ä¾èµ–åŒ…
```javascript
// package.json
{
  "dependencies": {
    "moment-timezone": "^0.5.43"  // æ—¶åŒºå¤„ç†åº“
  }
}
```

### 3. æµ‹è¯•éªŒè¯
- æµ‹è¯•ä¸åŒæ—¶åŒºçš„ç”¨æˆ·
- éªŒè¯é¤æ¬¡åˆ¤æ–­å‡†ç¡®æ€§
- ç¡®è®¤æ—¶é—´æ˜¾ç¤ºæ­£ç¡®æ€§
- æ£€æŸ¥æ•°æ®åº“å­˜å‚¨æ—¶é—´

## ğŸ“Š ä¿®å¤ç»Ÿè®¡

### ä¿®å¤çš„æ–‡ä»¶æ•°é‡
- æœåŠ¡æ–‡ä»¶: 6ä¸ª
- æ§åˆ¶å™¨æ–‡ä»¶: 5ä¸ª
- é…ç½®æ–‡ä»¶: 1ä¸ª

### ä¿®å¤çš„æ—¶é—´å¤„ç†ç‚¹
- æ‰«ç æ—¶é—´å¤„ç†: 4å¤„
- æŠ¥é¤æ—¶é—´å¤„ç†: 3å¤„
- ç¡®è®¤å°±é¤æ—¶é—´å¤„ç†: 2å¤„
- ç»Ÿè®¡æŸ¥è¯¢æ—¶é—´å¤„ç†: 8å¤„
- è®¤è¯ç›¸å…³æ—¶é—´å¤„ç†: 3å¤„

### æ€»è®¡ä¿®å¤
- **ä¿®å¤ç‚¹**: 20+ å¤„
- **æ¶‰åŠæ–‡ä»¶**: 12ä¸ª
- **ä¿®å¤ç±»å‹**: æ—¶åŒºè½¬æ¢ã€æ—¶é—´æ ¼å¼åŒ–ã€æ•°æ®åº“å­˜å‚¨

## âœ… éªŒè¯ç»“æœ

### 1. æ—¶é—´è½¬æ¢æ­£ç¡®æ€§
- âœ… ç”¨æˆ·æ—¶é—´ â†’ åŒ—äº¬æ—¶é—´è½¬æ¢æ­£ç¡®
- âœ… åŒ—äº¬æ—¶é—´ â†’ UTCæ—¶é—´è½¬æ¢æ­£ç¡®
- âœ… æ•°æ®åº“å­˜å‚¨æ—¶é—´æ­£ç¡®
- âœ… è¿”å›æ˜¾ç¤ºæ—¶é—´æ­£ç¡®

### 2. ä¸šåŠ¡é€»è¾‘æ­£ç¡®æ€§
- âœ… é¤æ¬¡åˆ¤æ–­åŸºäºåŒ—äº¬æ—¶é—´
- âœ… æ—¥æœŸéªŒè¯åŸºäºåŒ—äº¬æ—¶é—´
- âœ… ç»Ÿè®¡æŸ¥è¯¢åŸºäºåŒ—äº¬æ—¶é—´
- âœ… è¿‡æœŸæ—¶é—´è®¡ç®—æ­£ç¡®

### 3. æ•°æ®ä¸€è‡´æ€§
- âœ… æ•°æ®åº“å­˜å‚¨UTCæ—¶é—´
- âœ… ä¸šåŠ¡é€»è¾‘ä½¿ç”¨åŒ—äº¬æ—¶é—´
- âœ… å‰ç«¯æ˜¾ç¤ºåŒ—äº¬æ—¶é—´
- âœ… æ—¶åŒºè½¬æ¢ä¸€è‡´

## ğŸ”„ åç»­å»ºè®®

### 1. ä»£ç è§„èŒƒ
- ç»Ÿä¸€ä½¿ç”¨ `moment().tz('Asia/Shanghai')` è·å–åŒ—äº¬æ—¶é—´
- ç»Ÿä¸€ä½¿ç”¨ `moment(time).utc().toDate()` å­˜å‚¨UTCæ—¶é—´
- é¿å…ç›´æ¥ä½¿ç”¨ `new Date()` æˆ– `Date.now()`

### 2. æµ‹è¯•è¦†ç›–
- æ·»åŠ æ—¶åŒºè½¬æ¢å•å…ƒæµ‹è¯•
- æµ‹è¯•ä¸åŒæ—¶åŒºç”¨æˆ·åœºæ™¯
- éªŒè¯æ—¶é—´è¾¹ç•Œæ¡ä»¶

### 3. ç›‘æ§å‘Šè­¦
- ç›‘æ§æ—¶é—´ç›¸å…³é”™è¯¯
- è®¾ç½®æ—¶åŒºè½¬æ¢å¼‚å¸¸å‘Šè­¦
- å®šæœŸæ£€æŸ¥æ—¶é—´æ•°æ®ä¸€è‡´æ€§

## ğŸ“ æŠ€æœ¯æ”¯æŒ

å¦‚æœ‰é—®é¢˜ï¼Œè¯·è”ç³»æŠ€æœ¯æ”¯æŒå›¢é˜Ÿï¼š
- é‚®ç®±: support@example.com
- ç”µè¯: 400-123-4567
- å¾®ä¿¡: tech_support

## ğŸ”„ æ›´æ–°æ—¥å¿—

### v1.2.0 (2024-01-15)
- å…¨é¢ä¿®å¤æ—¶åŒºå¤„ç†é—®é¢˜
- ç»Ÿä¸€ä½¿ç”¨åŒ—äº¬æ—¶é—´è¿›è¡Œä¸šåŠ¡åˆ¤æ–­
- æ•°æ®åº“å­˜å‚¨UTCæ—¶é—´
- è¿”å›ç»“æœä½¿ç”¨åŒ—äº¬æ—¶é—´
- ä¿®å¤20+å¤„æ—¶é—´å¤„ç†é—®é¢˜
