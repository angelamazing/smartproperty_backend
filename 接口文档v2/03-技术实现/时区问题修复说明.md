# 时区问题修复说明

## 🎯 问题描述

### 问题现象
- **前端显示**: 用户白天15:48扫码，显示为23:48（晚上11点）
- **后端存储**: 将北京时间15:48错误存储为UTC时间15:48
- **正确存储**: 应该将北京时间15:48存储为UTC时间07:48

### 问题根源
1. **时区处理不一致**: 后端没有正确处理用户本地时间到UTC时间的转换
2. **数据库存储**: 直接存储用户传入的时间，没有进行时区转换
3. **业务逻辑**: 餐次判断基于错误的时间

## 🛠️ 修复方案

### 1. 修复扫码时间处理

#### 1.1 控制器层修复
```javascript
// 修复前
const scanTimeMoment = moment(scanTime);
const result = await qrScanService.processQRScan(
  userId, 
  qrCode, 
  scanTimeMoment.toDate(), 
  req.db
);

// 修复后
const scanTimeMoment = moment(scanTime);
const beijingScanTime = scanTimeMoment.tz('Asia/Shanghai');
const result = await qrScanService.processQRScan(
  userId, 
  qrCode, 
  beijingScanTime.toDate(), 
  req.db
);
```

#### 1.2 服务层修复
```javascript
// 修复前
const mealType = this.getMealTypeByTime(scanTime);
const diningDate = moment(scanTime).format('YYYY-MM-DD');

// 修复后
const beijingScanTime = moment(scanTime).tz('Asia/Shanghai');
const mealType = this.getMealTypeByTime(beijingScanTime.toDate());
const diningDate = beijingScanTime.format('YYYY-MM-DD');
```

### 2. 修复数据库存储

#### 2.1 存储UTC时间
```javascript
// 修复前
await connection.execute(`
  INSERT INTO dining_registrations 
  (_id, userId, userName, qrCodeId, qrCode, scanTime, mealType, diningDate, orderId, status)
  VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, 'success')
`, [
  registrationId,
  userId,
  userInfo.nickName,
  qrCodeInfo._id,
  qrCode,
  scanTime,  // 直接存储用户时间
  mealType,
  diningDate,
  orderInfo._id
]);

// 修复后
const utcScanTime = moment(scanTime).utc().toDate();
await connection.execute(`
  INSERT INTO dining_registrations 
  (_id, userId, userName, qrCodeId, qrCode, scanTime, mealType, diningDate, orderId, status)
  VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, 'success')
`, [
  registrationId,
  userId,
  userInfo.nickName,
  qrCodeInfo._id,
  qrCode,
  utcScanTime,  // 存储UTC时间
  mealType,
  diningDate,
  orderInfo._id
]);
```

### 3. 修复餐次判断逻辑

#### 3.1 使用北京时间判断
```javascript
// 修复前
getMealTypeByTime(scanTime) {
  const hour = moment(scanTime).hour();
  // ... 判断逻辑
}

// 修复后
getMealTypeByTime(scanTime) {
  const beijingTime = moment(scanTime).tz('Asia/Shanghai');
  const hour = beijingTime.hour();
  // ... 判断逻辑
}
```

### 4. 修复返回结果

#### 4.1 返回北京时间
```javascript
// 修复前
return {
  success: true,
  message: `登记成功！[${this.getMealTypeName(mealType)}] ${moment(scanTime).format('YYYY-MM-DD HH:mm')}`,
  data: {
    scanTime: moment(scanTime).format('YYYY-MM-DD HH:mm:ss'),
    // ...
  }
};

// 修复后
return {
  success: true,
  message: `登记成功！[${this.getMealTypeName(mealType)}] ${beijingScanTime.format('YYYY-MM-DD HH:mm')}`,
  data: {
    scanTime: beijingScanTime.format('YYYY-MM-DD HH:mm:ss'),
    // ...
  }
};
```

## 📋 修复内容总结

### 1. 已修复的文件
- `services/qrScanService.js` - 扫码服务核心逻辑
- `controllers/qrScanController.js` - 扫码控制器

### 2. 修复的关键点
- ✅ **时区转换**: 用户时间 → 北京时间 → UTC时间
- ✅ **数据库存储**: 统一存储UTC时间
- ✅ **业务逻辑**: 基于北京时间判断餐次
- ✅ **返回结果**: 返回北京时间给前端

### 3. 修复流程
```
用户扫码时间 → 转换为北京时间 → 判断餐次 → 转换为UTC时间存储 → 返回北京时间
```

## 🔧 配置说明

### 1. 数据库配置
```javascript
// config/database.js
database: {
  timezone: '+08:00',  // 数据库时区设置为北京时间
  // ...
}
```

### 2. 依赖包
```javascript
// package.json
{
  "dependencies": {
    "moment-timezone": "^0.5.43"  // 时区处理库
  }
}
```

## ⚠️ 注意事项

### 1. 数据一致性
- 新数据会正确存储UTC时间
- 历史数据可能需要数据迁移
- 建议在维护窗口期进行数据修复

### 2. 前端适配
- 前端需要正确处理时区显示
- 建议前端统一使用北京时间显示
- 避免前端进行时区转换

### 3. 测试验证
- 测试不同时区的用户
- 验证餐次判断准确性
- 确认时间显示正确性

## 🧪 测试用例

### 1. 正常扫码测试
```javascript
// 测试数据
const testData = {
  scanTime: '2024-01-15T15:48:00+08:00',  // 北京时间15:48
  expectedMealType: 'lunch',              // 应该是午餐
  expectedStorage: '2024-01-15T07:48:00Z' // 应该存储为UTC时间07:48
};

// 验证结果
assert.equal(result.data.mealType, 'lunch');
assert.equal(result.data.scanTime, '2024-01-15 15:48:00');
```

### 2. 边界时间测试
```javascript
// 早餐边界测试
const breakfastTest = {
  scanTime: '2024-01-15T09:59:00+08:00',  // 9:59
  expectedMealType: 'breakfast'
};

// 午餐边界测试
const lunchTest = {
  scanTime: '2024-01-15T10:01:00+08:00',  // 10:01
  expectedMealType: null  // 不在就餐时间内
};
```

## 📞 技术支持

如有问题，请联系技术支持团队：
- 邮箱: support@example.com
- 电话: 400-123-4567
- 微信: tech_support

## 🔄 更新日志

### v1.1.0 (2024-01-15)
- 修复时区处理问题
- 统一使用北京时间进行业务判断
- 数据库存储UTC时间
- 返回结果使用北京时间
