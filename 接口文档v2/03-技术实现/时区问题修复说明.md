# æ—¶åŒºé—®é¢˜ä¿®å¤è¯´æ˜

## ğŸ¯ é—®é¢˜æè¿°

### é—®é¢˜ç°è±¡
- **å‰ç«¯æ˜¾ç¤º**: ç”¨æˆ·ç™½å¤©15:48æ‰«ç ï¼Œæ˜¾ç¤ºä¸º23:48ï¼ˆæ™šä¸Š11ç‚¹ï¼‰
- **åç«¯å­˜å‚¨**: å°†åŒ—äº¬æ—¶é—´15:48é”™è¯¯å­˜å‚¨ä¸ºUTCæ—¶é—´15:48
- **æ­£ç¡®å­˜å‚¨**: åº”è¯¥å°†åŒ—äº¬æ—¶é—´15:48å­˜å‚¨ä¸ºUTCæ—¶é—´07:48

### é—®é¢˜æ ¹æº
1. **æ—¶åŒºå¤„ç†ä¸ä¸€è‡´**: åç«¯æ²¡æœ‰æ­£ç¡®å¤„ç†ç”¨æˆ·æœ¬åœ°æ—¶é—´åˆ°UTCæ—¶é—´çš„è½¬æ¢
2. **æ•°æ®åº“å­˜å‚¨**: ç›´æ¥å­˜å‚¨ç”¨æˆ·ä¼ å…¥çš„æ—¶é—´ï¼Œæ²¡æœ‰è¿›è¡Œæ—¶åŒºè½¬æ¢
3. **ä¸šåŠ¡é€»è¾‘**: é¤æ¬¡åˆ¤æ–­åŸºäºé”™è¯¯çš„æ—¶é—´

## ğŸ› ï¸ ä¿®å¤æ–¹æ¡ˆ

### 1. ä¿®å¤æ‰«ç æ—¶é—´å¤„ç†

#### 1.1 æ§åˆ¶å™¨å±‚ä¿®å¤
```javascript
// ä¿®å¤å‰
const scanTimeMoment = moment(scanTime);
const result = await qrScanService.processQRScan(
  userId, 
  qrCode, 
  scanTimeMoment.toDate(), 
  req.db
);

// ä¿®å¤å
const scanTimeMoment = moment(scanTime);
const beijingScanTime = scanTimeMoment.tz('Asia/Shanghai');
const result = await qrScanService.processQRScan(
  userId, 
  qrCode, 
  beijingScanTime.toDate(), 
  req.db
);
```

#### 1.2 æœåŠ¡å±‚ä¿®å¤
```javascript
// ä¿®å¤å‰
const mealType = this.getMealTypeByTime(scanTime);
const diningDate = moment(scanTime).format('YYYY-MM-DD');

// ä¿®å¤å
const beijingScanTime = moment(scanTime).tz('Asia/Shanghai');
const mealType = this.getMealTypeByTime(beijingScanTime.toDate());
const diningDate = beijingScanTime.format('YYYY-MM-DD');
```

### 2. ä¿®å¤æ•°æ®åº“å­˜å‚¨

#### 2.1 å­˜å‚¨UTCæ—¶é—´
```javascript
// ä¿®å¤å‰
await connection.execute(`
  INSERT INTO dining_registrations 
  (_id, userId, userName, qrCodeId, qrCode, scanTime, mealType, diningDate, orderId, status)
  VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, 'success')
`, [
  registrationId,
  userId,
  userInfo.nickName,
  qrCodeInfo._id,
  qrCode,
  scanTime,  // ç›´æ¥å­˜å‚¨ç”¨æˆ·æ—¶é—´
  mealType,
  diningDate,
  orderInfo._id
]);

// ä¿®å¤å
const utcScanTime = moment(scanTime).utc().toDate();
await connection.execute(`
  INSERT INTO dining_registrations 
  (_id, userId, userName, qrCodeId, qrCode, scanTime, mealType, diningDate, orderId, status)
  VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, 'success')
`, [
  registrationId,
  userId,
  userInfo.nickName,
  qrCodeInfo._id,
  qrCode,
  utcScanTime,  // å­˜å‚¨UTCæ—¶é—´
  mealType,
  diningDate,
  orderInfo._id
]);
```

### 3. ä¿®å¤é¤æ¬¡åˆ¤æ–­é€»è¾‘

#### 3.1 ä½¿ç”¨åŒ—äº¬æ—¶é—´åˆ¤æ–­
```javascript
// ä¿®å¤å‰
getMealTypeByTime(scanTime) {
  const hour = moment(scanTime).hour();
  // ... åˆ¤æ–­é€»è¾‘
}

// ä¿®å¤å
getMealTypeByTime(scanTime) {
  const beijingTime = moment(scanTime).tz('Asia/Shanghai');
  const hour = beijingTime.hour();
  // ... åˆ¤æ–­é€»è¾‘
}
```

### 4. ä¿®å¤è¿”å›ç»“æœ

#### 4.1 è¿”å›åŒ—äº¬æ—¶é—´
```javascript
// ä¿®å¤å‰
return {
  success: true,
  message: `ç™»è®°æˆåŠŸï¼[${this.getMealTypeName(mealType)}] ${moment(scanTime).format('YYYY-MM-DD HH:mm')}`,
  data: {
    scanTime: moment(scanTime).format('YYYY-MM-DD HH:mm:ss'),
    // ...
  }
};

// ä¿®å¤å
return {
  success: true,
  message: `ç™»è®°æˆåŠŸï¼[${this.getMealTypeName(mealType)}] ${beijingScanTime.format('YYYY-MM-DD HH:mm')}`,
  data: {
    scanTime: beijingScanTime.format('YYYY-MM-DD HH:mm:ss'),
    // ...
  }
};
```

## ğŸ“‹ ä¿®å¤å†…å®¹æ€»ç»“

### 1. å·²ä¿®å¤çš„æ–‡ä»¶
- `services/qrScanService.js` - æ‰«ç æœåŠ¡æ ¸å¿ƒé€»è¾‘
- `controllers/qrScanController.js` - æ‰«ç æ§åˆ¶å™¨

### 2. ä¿®å¤çš„å…³é”®ç‚¹
- âœ… **æ—¶åŒºè½¬æ¢**: ç”¨æˆ·æ—¶é—´ â†’ åŒ—äº¬æ—¶é—´ â†’ UTCæ—¶é—´
- âœ… **æ•°æ®åº“å­˜å‚¨**: ç»Ÿä¸€å­˜å‚¨UTCæ—¶é—´
- âœ… **ä¸šåŠ¡é€»è¾‘**: åŸºäºåŒ—äº¬æ—¶é—´åˆ¤æ–­é¤æ¬¡
- âœ… **è¿”å›ç»“æœ**: è¿”å›åŒ—äº¬æ—¶é—´ç»™å‰ç«¯

### 3. ä¿®å¤æµç¨‹
```
ç”¨æˆ·æ‰«ç æ—¶é—´ â†’ è½¬æ¢ä¸ºåŒ—äº¬æ—¶é—´ â†’ åˆ¤æ–­é¤æ¬¡ â†’ è½¬æ¢ä¸ºUTCæ—¶é—´å­˜å‚¨ â†’ è¿”å›åŒ—äº¬æ—¶é—´
```

## ğŸ”§ é…ç½®è¯´æ˜

### 1. æ•°æ®åº“é…ç½®
```javascript
// config/database.js
database: {
  timezone: '+08:00',  // æ•°æ®åº“æ—¶åŒºè®¾ç½®ä¸ºåŒ—äº¬æ—¶é—´
  // ...
}
```

### 2. ä¾èµ–åŒ…
```javascript
// package.json
{
  "dependencies": {
    "moment-timezone": "^0.5.43"  // æ—¶åŒºå¤„ç†åº“
  }
}
```

## âš ï¸ æ³¨æ„äº‹é¡¹

### 1. æ•°æ®ä¸€è‡´æ€§
- æ–°æ•°æ®ä¼šæ­£ç¡®å­˜å‚¨UTCæ—¶é—´
- å†å²æ•°æ®å¯èƒ½éœ€è¦æ•°æ®è¿ç§»
- å»ºè®®åœ¨ç»´æŠ¤çª—å£æœŸè¿›è¡Œæ•°æ®ä¿®å¤

### 2. å‰ç«¯é€‚é…
- å‰ç«¯éœ€è¦æ­£ç¡®å¤„ç†æ—¶åŒºæ˜¾ç¤º
- å»ºè®®å‰ç«¯ç»Ÿä¸€ä½¿ç”¨åŒ—äº¬æ—¶é—´æ˜¾ç¤º
- é¿å…å‰ç«¯è¿›è¡Œæ—¶åŒºè½¬æ¢

### 3. æµ‹è¯•éªŒè¯
- æµ‹è¯•ä¸åŒæ—¶åŒºçš„ç”¨æˆ·
- éªŒè¯é¤æ¬¡åˆ¤æ–­å‡†ç¡®æ€§
- ç¡®è®¤æ—¶é—´æ˜¾ç¤ºæ­£ç¡®æ€§

## ğŸ§ª æµ‹è¯•ç”¨ä¾‹

### 1. æ­£å¸¸æ‰«ç æµ‹è¯•
```javascript
// æµ‹è¯•æ•°æ®
const testData = {
  scanTime: '2024-01-15T15:48:00+08:00',  // åŒ—äº¬æ—¶é—´15:48
  expectedMealType: 'lunch',              // åº”è¯¥æ˜¯åˆé¤
  expectedStorage: '2024-01-15T07:48:00Z' // åº”è¯¥å­˜å‚¨ä¸ºUTCæ—¶é—´07:48
};

// éªŒè¯ç»“æœ
assert.equal(result.data.mealType, 'lunch');
assert.equal(result.data.scanTime, '2024-01-15 15:48:00');
```

### 2. è¾¹ç•Œæ—¶é—´æµ‹è¯•
```javascript
// æ—©é¤è¾¹ç•Œæµ‹è¯•
const breakfastTest = {
  scanTime: '2024-01-15T09:59:00+08:00',  // 9:59
  expectedMealType: 'breakfast'
};

// åˆé¤è¾¹ç•Œæµ‹è¯•
const lunchTest = {
  scanTime: '2024-01-15T10:01:00+08:00',  // 10:01
  expectedMealType: null  // ä¸åœ¨å°±é¤æ—¶é—´å†…
};
```

## ğŸ“ æŠ€æœ¯æ”¯æŒ

å¦‚æœ‰é—®é¢˜ï¼Œè¯·è”ç³»æŠ€æœ¯æ”¯æŒå›¢é˜Ÿï¼š
- é‚®ç®±: support@example.com
- ç”µè¯: 400-123-4567
- å¾®ä¿¡: tech_support

## ğŸ”„ æ›´æ–°æ—¥å¿—

### v1.1.0 (2024-01-15)
- ä¿®å¤æ—¶åŒºå¤„ç†é—®é¢˜
- ç»Ÿä¸€ä½¿ç”¨åŒ—äº¬æ—¶é—´è¿›è¡Œä¸šåŠ¡åˆ¤æ–­
- æ•°æ®åº“å­˜å‚¨UTCæ—¶é—´
- è¿”å›ç»“æœä½¿ç”¨åŒ—äº¬æ—¶é—´
