# 📱 二维码接口详细文档

## 📖 文档概述

本文档详细描述了二维码管理相关的所有API接口，包括二维码的创建、查询、更新和扫码验证功能。

**基础路径**: `/api/qr-scan`  
**认证方式**: JWT Token  
**文档版本**: v2.0.0  
**最后更新**: 2025年1月

## 🔐 认证配置

### 请求头设置
```javascript
const headers = {
  'Authorization': `Bearer ${token}`,
  'Content-Type': 'application/json'
};
```

### Token获取
```javascript
// 登录后获取token
const loginResponse = await fetch('/api/auth/login', {
  method: 'POST',
  headers: { 'Content-Type': 'application/json' },
  body: JSON.stringify({ username, password })
});
const { data: { token } } = await loginResponse.json();
```

## 📱 用户端接口

### 1. 扫码就餐登记

**接口地址**: `POST /api/qr-scan/scan`

**功能描述**: 处理用户扫码就餐登记请求，根据扫码时间自动判断餐次

**权限要求**: 已登录用户

**请求头**:
```
Authorization: Bearer {your-jwt-token}
Content-Type: application/json
```

**请求参数**:
```json
{
  "qrCode": "DINING_QR_MAIN_001",
  "scanTime": "2025-09-09T12:30:00.000Z"
}
```

**参数说明**:
- `qrCode`: 二维码标识，必填，最大100字符
- `scanTime`: 扫码时间，必填，ISO 8601格式

**成功响应**:
```json
{
  "success": true,
  "message": "登记成功！[午餐] 2025-09-09 12:30",
  "data": {
    "userId": "user-uuid",
    "userName": "张三",
    "mealType": "lunch",
    "mealTypeName": "午餐",
    "diningDate": "2025-09-09",
    "scanTime": "2025-09-09 12:30:00",
    "qrCodeInfo": {
      "name": "餐厅主入口二维码",
      "location": "餐厅主入口"
    }
  },
  "code": "200",
  "timestamp": "2025-09-09T12:30:00.000Z"
}
```

**错误响应**:
```json
{
  "success": false,
  "message": "您尚未报餐，无法进行就餐登记",
  "error": "您尚未报餐，无法进行就餐登记",
  "code": "400",
  "timestamp": "2025-09-09T12:30:00.000Z"
}
```

**前端调用示例**:
```javascript
async function scanQRCode(qrCode) {
  try {
    const response = await fetch('/api/qr-scan/scan', {
      method: 'POST',
      headers: {
        'Authorization': `Bearer ${token}`,
        'Content-Type': 'application/json'
      },
      body: JSON.stringify({
        qrCode: qrCode,
        scanTime: new Date().toISOString()
      })
    });
    
    const result = await response.json();
    
    if (result.success) {
      console.log('扫码成功:', result.message);
      return result.data;
    } else {
      console.error('扫码失败:', result.message);
      throw new Error(result.message);
    }
  } catch (error) {
    console.error('扫码请求失败:', error);
    throw error;
  }
}
```

### 2. 获取用户就餐登记历史

**接口地址**: `GET /api/qr-scan/history`

**功能描述**: 获取用户的历史就餐登记记录

**权限要求**: 已登录用户

**请求头**:
```
Authorization: Bearer {your-jwt-token}
```

**请求参数**:
```
GET /api/qr-scan/history?date=2025-09-09&limit=20&offset=0
```

**参数说明**:
- `date`: 查询日期，可选，格式：YYYY-MM-DD，默认今日
- `limit`: 每页数量，可选，默认20，最大100
- `offset`: 偏移量，可选，默认0

**成功响应**:
```json
{
  "success": true,
  "message": "获取就餐登记历史成功",
  "data": [
    {
      "_id": "reg-uuid",
      "userId": "user-uuid",
      "userName": "张三",
      "qrCode": "DINING_QR_MAIN_001",
      "scanTime": "2025-09-09T12:30:00.000Z",
      "mealType": "lunch",
      "mealTypeName": "午餐",
      "diningDate": "2025-09-09",
      "status": "success",
      "qrCodeInfo": {
        "name": "餐厅主入口二维码",
        "location": "餐厅主入口"
      }
    }
  ],
  "pagination": {
    "total": 1,
    "limit": 20,
    "offset": 0,
    "hasMore": false
  },
  "code": "200",
  "timestamp": "2025-09-09T12:30:00.000Z"
}
```

**前端调用示例**:
```javascript
async function getUserDiningHistory(date = null, limit = 20, offset = 0) {
  try {
    const params = new URLSearchParams();
    if (date) params.append('date', date);
    params.append('limit', limit);
    params.append('offset', offset);
    
    const response = await fetch(`/api/qr-scan/history?${params}`, {
      headers: {
        'Authorization': `Bearer ${token}`
      }
    });
    
    const result = await response.json();
    
    if (result.success) {
      return result.data;
    } else {
      throw new Error(result.message);
    }
  } catch (error) {
    console.error('获取历史记录失败:', error);
    throw error;
  }
}
```

### 3. 获取就餐统计

**接口地址**: `GET /api/qr-scan/statistics`

**功能描述**: 获取指定日期的就餐统计数据

**权限要求**: 已登录用户

**请求头**:
```
Authorization: Bearer {your-jwt-token}
```

**请求参数**:
```
GET /api/qr-scan/statistics?date=2025-09-09
```

**参数说明**:
- `date`: 统计日期，可选，格式：YYYY-MM-DD，默认今日

**成功响应**:
```json
{
  "success": true,
  "message": "获取就餐统计成功",
  "data": {
    "date": "2025-09-09",
    "statistics": {
      "breakfast": {
        "totalScans": 45,
        "uniqueUsers": 42,
        "successfulScans": 44,
        "failedScans": 1
      },
      "lunch": {
        "totalScans": 78,
        "uniqueUsers": 75,
        "successfulScans": 76,
        "failedScans": 2
      },
      "dinner": {
        "totalScans": 52,
        "uniqueUsers": 50,
        "successfulScans": 51,
        "failedScans": 1
      }
    },
    "summary": {
      "totalScans": 175,
      "uniqueUsers": 167,
      "successfulScans": 171,
      "failedScans": 4
    }
  },
  "code": "200",
  "timestamp": "2025-09-09T12:30:00.000Z"
}
```

## 🔧 管理员接口

### 4. 创建二维码

**接口地址**: `POST /api/qr-scan/qr-codes`

**功能描述**: 创建新的二维码

**权限要求**: 部门管理员及以上

**请求头**:
```
Authorization: Bearer {your-jwt-token}
Content-Type: application/json
```

**请求参数**:
```json
{
  "name": "餐厅主入口二维码",
  "location": "餐厅主入口",
  "description": "餐厅主入口通用二维码，支持所有餐次登记"
}
```

**参数说明**:
- `name`: 二维码名称，必填，2-100字符
- `location`: 张贴位置，必填，2-200字符
- `description`: 描述信息，可选，最大500字符

**成功响应**:
```json
{
  "success": true,
  "message": "二维码创建成功",
  "data": {
    "qrId": "qr-uuid",
    "code": "DINING_QR_1705123456789_ABC123DEF",
    "message": "二维码创建成功"
  },
  "code": "200",
  "timestamp": "2025-09-09T12:30:00.000Z"
}
```

**前端调用示例**:
```javascript
async function createQRCode(name, location, description = '') {
  try {
    const response = await fetch('/api/qr-scan/qr-codes', {
      method: 'POST',
      headers: {
        'Authorization': `Bearer ${token}`,
        'Content-Type': 'application/json'
      },
      body: JSON.stringify({
        name,
        location,
        description
      })
    });
    
    const result = await response.json();
    
    if (result.success) {
      console.log('二维码创建成功:', result.data.code);
      return result.data;
    } else {
      throw new Error(result.message);
    }
  } catch (error) {
    console.error('创建二维码失败:', error);
    throw error;
  }
}
```

### 5. 获取二维码列表

**接口地址**: `GET /api/qr-scan/qr-codes`

**功能描述**: 获取二维码列表

**权限要求**: 部门管理员及以上

**请求头**:
```
Authorization: Bearer {your-jwt-token}
```

**请求参数**:
```
GET /api/qr-scan/qr-codes?status=active&limit=50&offset=0
```

**参数说明**:
- `status`: 状态筛选，可选，枚举值：active/inactive
- `limit`: 每页数量，可选，默认100，最大200
- `offset`: 偏移量，可选，默认0

**成功响应**:
```json
{
  "success": true,
  "message": "获取二维码列表成功",
  "data": [
    {
      "_id": "qr-uuid",
      "code": "DINING_QR_MAIN_001",
      "name": "餐厅主入口二维码",
      "location": "餐厅主入口",
      "description": "餐厅主入口通用二维码，支持所有餐次登记",
      "status": "active",
      "createTime": "2025-09-09T08:00:00.000Z",
      "updateTime": "2025-09-09T08:00:00.000Z"
    }
  ],
  "pagination": {
    "total": 1,
    "limit": 50,
    "offset": 0,
    "hasMore": false
  },
  "code": "200",
  "timestamp": "2025-09-09T12:30:00.000Z"
}
```

**前端调用示例**:
```javascript
async function getQRCodes(status = null, limit = 100, offset = 0) {
  try {
    const params = new URLSearchParams();
    if (status) params.append('status', status);
    params.append('limit', limit);
    params.append('offset', offset);
    
    const response = await fetch(`/api/qr-scan/qr-codes?${params}`, {
      headers: {
        'Authorization': `Bearer ${token}`
      }
    });
    
    const result = await response.json();
    
    if (result.success) {
      return result.data;
    } else {
      throw new Error(result.message);
    }
  } catch (error) {
    console.error('获取二维码列表失败:', error);
    throw error;
  }
}
```

### 6. 获取二维码详情

**接口地址**: `GET /api/qr-scan/qr-codes/:qrId`

**功能描述**: 获取指定二维码的详细信息和使用统计

**权限要求**: 部门管理员及以上

**请求头**:
```
Authorization: Bearer {your-jwt-token}
```

**请求参数**: 路径参数
- `qrId`: 二维码ID

**成功响应**:
```json
{
  "success": true,
  "message": "获取二维码详情成功",
  "data": {
    "_id": "qr-uuid",
    "code": "DINING_QR_MAIN_001",
    "name": "餐厅主入口二维码",
    "location": "餐厅主入口",
    "description": "餐厅主入口通用二维码，支持所有餐次登记",
    "status": "active",
    "createTime": "2025-09-09T08:00:00.000Z",
    "updateTime": "2025-09-09T08:00:00.000Z",
    "usageStats": {
      "totalScans": 150,
      "uniqueUsers": 120,
      "successfulScans": 145,
      "failedScans": 5
    }
  },
  "code": "200",
  "timestamp": "2025-09-09T12:30:00.000Z"
}
```

**前端调用示例**:
```javascript
async function getQRCodeDetail(qrId) {
  try {
    const response = await fetch(`/api/qr-scan/qr-codes/${qrId}`, {
      headers: {
        'Authorization': `Bearer ${token}`
      }
    });
    
    const result = await response.json();
    
    if (result.success) {
      return result.data;
    } else {
      throw new Error(result.message);
    }
  } catch (error) {
    console.error('获取二维码详情失败:', error);
    throw error;
  }
}
```

### 7. 生成二维码图片

**接口地址**: `GET /api/qr-scan/qr-codes/:qrCode/image`

**功能描述**: 生成指定二维码的图片

**权限要求**: 已登录用户

**请求头**:
```
Authorization: Bearer {your-jwt-token}
```

**请求参数**: 路径参数
- `qrCode`: 二维码标识

**查询参数**:
- `width`: 图片宽度，可选，默认200
- `margin`: 边距，可选，默认2

**成功响应**:
```json
{
  "success": true,
  "message": "二维码图片生成成功",
  "data": {
    "qrCode": "DINING_QR_MAIN_001",
    "imageDataURL": "data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAA...",
    "width": 200,
    "margin": 2
  },
  "code": "200",
  "timestamp": "2025-09-09T12:30:00.000Z"
}
```

**前端调用示例**:
```javascript
async function generateQRCodeImage(qrCode, width = 200, margin = 2) {
  try {
    const response = await fetch(`/api/qr-scan/qr-codes/${qrCode}/image?width=${width}&margin=${margin}`, {
      headers: {
        'Authorization': `Bearer ${token}`
      }
    });
    
    const result = await response.json();
    
    if (result.success) {
      return result.data.imageDataURL;
    } else {
      throw new Error(result.message);
    }
  } catch (error) {
    console.error('生成二维码图片失败:', error);
    throw error;
  }
}

// 使用示例
const qrImageDataURL = await generateQRCodeImage('DINING_QR_MAIN_001');
// 在页面上显示二维码图片
const img = document.createElement('img');
img.src = qrImageDataURL;
document.body.appendChild(img);
```

### 8. 更新二维码状态

**接口地址**: `PUT /api/qr-scan/qr-codes/:qrId/status`

**功能描述**: 更新二维码的启用/停用状态

**权限要求**: 部门管理员及以上

**请求头**:
```
Authorization: Bearer {your-jwt-token}
Content-Type: application/json
```

**请求参数**: 路径参数
- `qrId`: 二维码ID

**请求体**:
```json
{
  "status": "inactive"
}
```

**参数说明**:
- `status`: 状态，必填，枚举值：active/inactive

**成功响应**:
```json
{
  "success": true,
  "message": "二维码状态更新成功",
  "data": {
    "qrId": "qr-uuid",
    "status": "inactive"
  },
  "code": "200",
  "timestamp": "2025-09-09T12:30:00.000Z"
}
```

**前端调用示例**:
```javascript
async function updateQRCodeStatus(qrId, status) {
  try {
    const response = await fetch(`/api/qr-scan/qr-codes/${qrId}/status`, {
      method: 'PUT',
      headers: {
        'Authorization': `Bearer ${token}`,
        'Content-Type': 'application/json'
      },
      body: JSON.stringify({ status })
    });
    
    const result = await response.json();
    
    if (result.success) {
      console.log('二维码状态更新成功');
      return result.data;
    } else {
      throw new Error(result.message);
    }
  } catch (error) {
    console.error('更新二维码状态失败:', error);
    throw error;
  }
}
```

## 📋 业务规则

### 扫码登记规则

1. **时间限制**: 只有在就餐时间内扫码才能成功登记
   - 早餐时间: 6:00-10:00
   - 午餐时间: 11:00-14:00
   - 晚餐时间: 17:00-20:00

2. **报餐验证**: 用户必须先报餐才能进行就餐登记
   - ⚠️ **重要**: 只有部门管理员可以为部门成员报餐
   - 普通用户无法自行报餐，需要部门管理员代为报餐

3. **重复登记**: 同一用户同一餐次只能登记一次

4. **二维码有效性**: 只有状态为"active"的二维码才能使用

### 错误处理

| 错误信息 | 原因 | 解决方案 |
|---------|------|---------|
| 当前时间不在就餐时间内 | 扫码时间不在规定就餐时间内 | 在就餐时间内扫码 |
| 您尚未报餐，无法进行就餐登记 | 用户没有报餐记录 | 联系部门管理员代为报餐 |
| 您已登记过本次就餐 | 用户已经登记过该餐次 | 无需重复登记 |
| 二维码无效或已停用 | 二维码不存在或已停用 | 使用有效的二维码 |
| 用户不存在或已被禁用 | 用户账号异常 | 联系管理员检查账号状态 |

## 🎯 固定二维码

### 默认二维码

系统初始化时会自动创建以下固定二维码：

| 二维码标识 | 名称 | 位置 | 状态 |
|-----------|------|------|------|
| DINING_QR_MAIN_001 | 餐厅主入口二维码 | 餐厅主入口 | active |
| DINING_QR_MAIN_002 | 餐厅A区二维码 | 餐厅A区 | active |
| DINING_QR_MAIN_003 | 餐厅B区二维码 | 餐厅B区 | active |

### 二维码生成规则

- **格式**: `DINING_QR_${时间戳}_${随机字符串}`
- **示例**: `DINING_QR_1705123456789_ABC123DEF`
- **唯一性**: 每个二维码都有唯一的标识码

## 🔧 前端集成示例

### 完整的扫码功能实现

```javascript
class QRCodeManager {
  constructor(token) {
    this.token = token;
    this.baseURL = '/api/qr-scan';
  }
  
  // 扫码就餐登记
  async scanQRCode(qrCode) {
    try {
      const response = await fetch(`${this.baseURL}/scan`, {
        method: 'POST',
        headers: {
          'Authorization': `Bearer ${this.token}`,
          'Content-Type': 'application/json'
        },
        body: JSON.stringify({
          qrCode: qrCode,
          scanTime: new Date().toISOString()
        })
      });
      
      const result = await response.json();
      
      if (result.success) {
        return {
          success: true,
          data: result.data,
          message: result.message
        };
      } else {
        return {
          success: false,
          message: result.message
        };
      }
    } catch (error) {
      return {
        success: false,
        message: '网络请求失败'
      };
    }
  }
  
  // 获取用户历史记录
  async getUserHistory(date = null, limit = 20, offset = 0) {
    try {
      const params = new URLSearchParams();
      if (date) params.append('date', date);
      params.append('limit', limit);
      params.append('offset', offset);
      
      const response = await fetch(`${this.baseURL}/history?${params}`, {
        headers: {
          'Authorization': `Bearer ${this.token}`
        }
      });
      
      const result = await response.json();
      
      if (result.success) {
        return result.data;
      } else {
        throw new Error(result.message);
      }
    } catch (error) {
      console.error('获取历史记录失败:', error);
      throw error;
    }
  }
  
  // 获取二维码列表（管理员）
  async getQRCodes(status = null, limit = 100, offset = 0) {
    try {
      const params = new URLSearchParams();
      if (status) params.append('status', status);
      params.append('limit', limit);
      params.append('offset', offset);
      
      const response = await fetch(`${this.baseURL}/qr-codes?${params}`, {
        headers: {
          'Authorization': `Bearer ${this.token}`
        }
      });
      
      const result = await response.json();
      
      if (result.success) {
        return result.data;
      } else {
        throw new Error(result.message);
      }
    } catch (error) {
      console.error('获取二维码列表失败:', error);
      throw error;
    }
  }
  
  // 创建二维码（管理员）
  async createQRCode(name, location, description = '') {
    try {
      const response = await fetch(`${this.baseURL}/qr-codes`, {
        method: 'POST',
        headers: {
          'Authorization': `Bearer ${this.token}`,
          'Content-Type': 'application/json'
        },
        body: JSON.stringify({
          name,
          location,
          description
        })
      });
      
      const result = await response.json();
      
      if (result.success) {
        return result.data;
      } else {
        throw new Error(result.message);
      }
    } catch (error) {
      console.error('创建二维码失败:', error);
      throw error;
    }
  }
  
  // 生成二维码图片
  async generateQRCodeImage(qrCode, width = 200, margin = 2) {
    try {
      const response = await fetch(`${this.baseURL}/qr-codes/${qrCode}/image?width=${width}&margin=${margin}`, {
        headers: {
          'Authorization': `Bearer ${this.token}`
        }
      });
      
      const result = await response.json();
      
      if (result.success) {
        return result.data.imageDataURL;
      } else {
        throw new Error(result.message);
      }
    } catch (error) {
      console.error('生成二维码图片失败:', error);
      throw error;
    }
  }
}

// 使用示例
const qrManager = new QRCodeManager(userToken);

// 生成并显示二维码图片
async function displayQRCodes() {
  const qrCodes = [
    { code: 'DINING_QR_MAIN_001', name: '餐厅主入口二维码', location: '餐厅主入口' },
    { code: 'DINING_QR_MAIN_002', name: '餐厅A区二维码', location: '餐厅A区' },
    { code: 'DINING_QR_MAIN_003', name: '餐厅B区二维码', location: '餐厅B区' }
  ];
  
  for (const qr of qrCodes) {
    try {
      const qrImageDataURL = await qrManager.generateQRCodeImage(qr.code, 200, 2);
      
      // 创建二维码显示元素
      const qrContainer = document.createElement('div');
      qrContainer.className = 'qr-code-item';
      
      const qrImage = document.createElement('img');
      qrImage.src = qrImageDataURL;
      qrImage.alt = qr.name;
      
      const qrInfo = document.createElement('div');
      qrInfo.innerHTML = `
        <h3>${qr.name}</h3>
        <p>位置: ${qr.location}</p>
        <p>标识: ${qr.code}</p>
      `;
      
      qrContainer.appendChild(qrImage);
      qrContainer.appendChild(qrInfo);
      document.body.appendChild(qrContainer);
      
    } catch (error) {
      console.error(`生成二维码 ${qr.code} 失败:`, error);
    }
  }
}

// 扫码就餐
const scanResult = await qrManager.scanQRCode('DINING_QR_MAIN_001');
if (scanResult.success) {
  console.log('扫码成功:', scanResult.message);
} else {
  console.error('扫码失败:', scanResult.message);
}
```

## 📊 总结

本文档提供了二维码功能的完整API接口说明，包括：

- ✅ **用户端接口**: 扫码登记、历史查询、统计查看
- ✅ **管理员接口**: 二维码创建、列表查询、详情查看、状态更新
- ✅ **固定二维码**: 系统默认提供的3个固定二维码
- ✅ **完整示例**: 前端集成代码和使用示例
- ✅ **错误处理**: 详细的错误信息和解决方案

前端开发者可以根据本文档快速集成二维码功能。
