# 📱 固定二维码扫码确认就餐接口文档

## 📖 文档概述

本文档详细描述了使用固定二维码进行扫码确认就餐的完整流程和接口。系统提供一个固定的二维码供所有用户扫描确认就餐。

**基础路径**: `/api/qr-scan`  
**认证方式**: JWT Token  
**文档版本**: v2.0.0  
**最后更新**: 2025年1月

## 🎯 固定二维码信息

### 默认固定二维码
- **二维码标识**: `DINING_QR_MAIN_001`
- **二维码名称**: `餐厅主入口二维码`
- **张贴位置**: `餐厅主入口`
- **状态**: `active`（启用）
- **用途**: 所有用户扫码确认就餐

## 🔐 认证配置

### 请求头设置
```javascript
const headers = {
  'Authorization': `Bearer ${token}`,
  'Content-Type': 'application/json'
};
```

### Token获取
```javascript
// 登录后获取token
const loginResponse = await fetch('/api/auth/login', {
  method: 'POST',
  headers: { 'Content-Type': 'application/json' },
  body: JSON.stringify({ username, password })
});
const { data: { token } } = await loginResponse.json();
```

## 📱 核心接口

### 1. 生成固定二维码图片

**接口地址**: `GET /api/qr-scan/qr-codes/DINING_QR_MAIN_001/image`

**功能描述**: 生成固定二维码的图片，供前端显示

**权限要求**: 已登录用户

**请求头**:
```
Authorization: Bearer {your-jwt-token}
```

**请求参数**: 路径参数
- `qrCode`: 固定二维码标识 `DINING_QR_MAIN_001`

**查询参数**:
- `width`: 图片宽度，可选，默认200
- `margin`: 边距，可选，默认2

**成功响应**:
```json
{
  "success": true,
  "message": "二维码图片生成成功",
  "data": {
    "qrCode": "DINING_QR_MAIN_001",
    "imageDataURL": "data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAA...",
    "width": 200,
    "margin": 2
  },
  "code": "200",
  "timestamp": "2025-09-09T12:30:00.000Z"
}
```

**前端调用示例**:
```javascript
async function generateFixedQRCode(width = 200, margin = 2) {
  try {
    const response = await fetch(`/api/qr-scan/qr-codes/DINING_QR_MAIN_001/image?width=${width}&margin=${margin}`, {
      headers: {
        'Authorization': `Bearer ${token}`
      }
    });
    
    const result = await response.json();
    
    if (result.success) {
      return result.data.imageDataURL;
    } else {
      throw new Error(result.message);
    }
  } catch (error) {
    console.error('生成二维码图片失败:', error);
    throw error;
  }
}

// 使用示例
const qrImageDataURL = await generateFixedQRCode();
// 在页面上显示二维码图片
const img = document.createElement('img');
img.src = qrImageDataURL;
img.alt = '餐厅主入口二维码';
document.body.appendChild(img);
```

### 2. 扫码确认就餐

**接口地址**: `POST /api/qr-scan/scan`

**功能描述**: 处理用户扫码确认就餐请求，根据扫码时间自动判断餐次

**权限要求**: 已登录用户

**请求头**:
```
Authorization: Bearer {your-jwt-token}
Content-Type: application/json
```

**请求参数**:
```json
{
  "qrCode": "DINING_QR_MAIN_001",
  "scanTime": "2025-09-09T12:30:00.000Z"
}
```

**参数说明**:
- `qrCode`: 固定二维码标识，必填，值为 `DINING_QR_MAIN_001`
- `scanTime`: 扫码时间，必填，ISO 8601格式

**成功响应**:
```json
{
  "success": true,
  "message": "登记成功！[午餐] 2025-09-09 12:30",
  "data": {
    "userId": "user-uuid",
    "userName": "张三",
    "mealType": "lunch",
    "mealTypeName": "午餐",
    "diningDate": "2025-09-09",
    "scanTime": "2025-09-09 12:30:00",
    "qrCodeInfo": {
      "name": "餐厅主入口二维码",
      "location": "餐厅主入口"
    }
  },
  "code": "200",
  "timestamp": "2025-09-09T12:30:00.000Z"
}
```

**错误响应**:
```json
{
  "success": false,
  "message": "您尚未报餐，无法进行就餐登记",
  "error": "您尚未报餐，无法进行就餐登记",
  "code": "400",
  "timestamp": "2025-09-09T12:30:00.000Z"
}
```

**前端调用示例**:
```javascript
async function scanQRCodeConfirmDining() {
  try {
    const response = await fetch('/api/qr-scan/scan', {
      method: 'POST',
      headers: {
        'Authorization': `Bearer ${token}`,
        'Content-Type': 'application/json'
      },
      body: JSON.stringify({
        qrCode: 'DINING_QR_MAIN_001', // 固定二维码标识
        scanTime: new Date().toISOString()
      })
    });
    
    const result = await response.json();
    
    if (result.success) {
      console.log('扫码确认成功:', result.message);
      return {
        success: true,
        data: result.data,
        message: result.message
      };
    } else {
      console.error('扫码确认失败:', result.message);
      return {
        success: false,
        message: result.message
      };
    }
  } catch (error) {
    console.error('扫码请求失败:', error);
    return {
      success: false,
      message: '网络请求失败'
    };
  }
}
```

### 3. 获取用户就餐确认状态

**接口地址**: `GET /api/dining-confirmation/status`

**功能描述**: 获取用户指定日期的就餐确认状态，显示每个餐次的报餐和确认情况

**权限要求**: 已登录用户

**请求头**:
```
Authorization: Bearer {your-jwt-token}
```

**请求参数**:
```
GET /api/dining-confirmation/status?date=2025-09-09
```

**参数说明**:
- `date`: 查询日期，可选，格式：YYYY-MM-DD，默认今日

**成功响应**:
```json
{
  "success": true,
  "message": "获取就餐确认状态成功",
  "data": {
    "date": "2025-09-09",
    "mealConfirmationStatus": {
      "breakfast": {
        "isRegistered": true,
        "diningStatus": "dined",
        "actualDiningTime": "2025-09-09T08:30:00.000Z",
        "confirmationType": "qr",
        "confirmationTime": "2025-09-09T08:30:00.000Z"
      },
      "lunch": {
        "isRegistered": true,
        "diningStatus": "ordered",
        "actualDiningTime": null,
        "confirmationType": null,
        "confirmationTime": null
      },
      "dinner": {
        "isRegistered": false,
        "diningStatus": null,
        "actualDiningTime": null,
        "confirmationType": null,
        "confirmationTime": null
      }
    }
  },
  "code": "200",
  "timestamp": "2025-09-09T12:30:00.000Z"
}
```

## 🔄 扫码确认就餐完整流程

### 1. 业务流程
```
用户报餐 (diningStatus: 'ordered')
   ↓
用户扫描固定二维码 (DINING_QR_MAIN_001)
   ↓
系统验证二维码有效性
   ↓
系统根据扫码时间判断餐次 (breakfast/lunch/dinner)
   ↓
系统检查用户是否已报餐
   ↓
系统检查是否重复扫码
   ↓
系统更新订单状态 (diningStatus: 'dined')
   ↓
系统创建确认就餐日志 (confirmationType: 'qr')
   ↓
完成就餐确认
```

### 2. 数据更新

扫码成功后，系统会同时更新以下数据：

#### 2.1 更新 `dining_orders` 表
```sql
UPDATE dining_orders 
SET diningStatus = 'dined', 
    actualDiningTime = '扫码时间'
WHERE _id = '订单ID'
```

#### 2.2 创建 `dining_registrations` 记录
```sql
INSERT INTO dining_registrations 
(_id, userId, userName, qrCodeId, qrCode, scanTime, mealType, diningDate, orderId, status)
VALUES ('登记ID', '用户ID', '用户姓名', '二维码ID', 'DINING_QR_MAIN_001', '扫码时间', '餐次', '就餐日期', '订单ID', 'success')
```

#### 2.3 创建 `dining_confirmation_logs` 记录
```sql
INSERT INTO dining_confirmation_logs 
(_id, orderId, userId, userName, confirmationType, confirmationTime, remark, confirmedBy)
VALUES ('日志ID', '订单ID', '用户ID', '用户姓名', 'qr', '扫码时间', '扫码确认就餐 - 二维码: DINING_QR_MAIN_001', '用户ID')
```

## 📋 业务规则

### 扫码确认规则

1. **时间限制**: 只有在就餐时间内扫码才能成功确认
   - 早餐时间: 6:00-10:00
   - 午餐时间: 11:00-14:00
   - 晚餐时间: 17:00-20:00

2. **报餐验证**: 用户必须先报餐才能进行扫码确认
   - ⚠️ **重要**: 只有部门管理员可以为部门成员报餐
   - 普通用户无法自行报餐，需要部门管理员代为报餐

3. **重复确认**: 同一用户同一餐次只能确认一次

4. **二维码有效性**: 固定二维码 `DINING_QR_MAIN_001` 必须处于 `active` 状态

### 错误处理

| 错误信息 | 原因 | 解决方案 |
|---------|------|---------|
| 当前时间不在就餐时间内 | 扫码时间不在规定就餐时间内 | 在就餐时间内扫码 |
| 您尚未报餐，无法进行就餐登记 | 用户没有报餐记录 | 联系部门管理员代为报餐 |
| 您已登记过本次就餐 | 用户已经确认过该餐次 | 无需重复确认 |
| 二维码无效或已停用 | 二维码不存在或已停用 | 使用有效的固定二维码 |
| 用户不存在或已被禁用 | 用户账号异常 | 联系管理员检查账号状态 |

## 🔧 前端完整实现示例

### 完整的扫码确认功能

```javascript
class FixedQRCodeManager {
  constructor(token) {
    this.token = token;
    this.baseURL = '/api/qr-scan';
    this.fixedQRCode = 'DINING_QR_MAIN_001'; // 固定二维码标识
  }
  
  // 生成固定二维码图片
  async generateFixedQRCodeImage(width = 200, margin = 2) {
    try {
      const response = await fetch(`${this.baseURL}/qr-codes/${this.fixedQRCode}/image?width=${width}&margin=${margin}`, {
        headers: {
          'Authorization': `Bearer ${this.token}`
        }
      });
      
      const result = await response.json();
      
      if (result.success) {
        return result.data.imageDataURL;
      } else {
        throw new Error(result.message);
      }
    } catch (error) {
      console.error('生成固定二维码图片失败:', error);
      throw error;
    }
  }
  
  // 扫码确认就餐
  async scanQRCodeConfirmDining() {
    try {
      const response = await fetch(`${this.baseURL}/scan`, {
        method: 'POST',
        headers: {
          'Authorization': `Bearer ${this.token}`,
          'Content-Type': 'application/json'
        },
        body: JSON.stringify({
          qrCode: this.fixedQRCode, // 使用固定二维码
          scanTime: new Date().toISOString()
        })
      });
      
      const result = await response.json();
      
      if (result.success) {
        return {
          success: true,
          data: result.data,
          message: result.message
        };
      } else {
        return {
          success: false,
          message: result.message
        };
      }
    } catch (error) {
      return {
        success: false,
        message: '网络请求失败'
      };
    }
  }
  
  // 获取用户就餐确认状态
  async getUserDiningStatus(date = null) {
    try {
      const params = new URLSearchParams();
      if (date) params.append('date', date);
      
      const response = await fetch(`/api/dining-confirmation/status?${params}`, {
        headers: {
          'Authorization': `Bearer ${this.token}`
        }
      });
      
      const result = await response.json();
      
      if (result.success) {
        return result.data;
      } else {
        throw new Error(result.message);
      }
    } catch (error) {
      console.error('获取就餐状态失败:', error);
      throw error;
    }
  }
}

// 使用示例
const qrManager = new FixedQRCodeManager(userToken);

// 1. 生成并显示固定二维码
async function displayFixedQRCode() {
  try {
    const qrImageDataURL = await qrManager.generateFixedQRCodeImage(200, 2);
    
    // 创建二维码显示元素
    const qrContainer = document.createElement('div');
    qrContainer.className = 'fixed-qr-code';
    
    const qrImage = document.createElement('img');
    qrImage.src = qrImageDataURL;
    qrImage.alt = '餐厅主入口二维码';
    qrImage.style.width = '200px';
    qrImage.style.height = '200px';
    
    const qrInfo = document.createElement('div');
    qrInfo.innerHTML = `
      <h3>餐厅主入口二维码</h3>
      <p>位置: 餐厅主入口</p>
      <p>标识: DINING_QR_MAIN_001</p>
      <p>用途: 扫码确认就餐</p>
    `;
    
    qrContainer.appendChild(qrImage);
    qrContainer.appendChild(qrInfo);
    document.body.appendChild(qrContainer);
    
  } catch (error) {
    console.error('显示固定二维码失败:', error);
  }
}

// 2. 扫码确认就餐
async function confirmDiningByScan() {
  const result = await qrManager.scanQRCodeConfirmDining();
  
  if (result.success) {
    alert(`扫码确认成功！${result.message}`);
    console.log('确认数据:', result.data);
  } else {
    alert(`扫码确认失败：${result.message}`);
  }
}

// 3. 查看就餐状态
async function checkDiningStatus() {
  try {
    const status = await qrManager.getUserDiningStatus();
    console.log('就餐状态:', status);
    
    // 显示状态信息
    Object.keys(status.mealConfirmationStatus).forEach(mealType => {
      const meal = status.mealConfirmationStatus[mealType];
      console.log(`${mealType}: ${meal.isRegistered ? '已报餐' : '未报餐'} - ${meal.diningStatus === 'dined' ? '已确认' : '未确认'}`);
    });
  } catch (error) {
    console.error('获取就餐状态失败:', error);
  }
}

// 初始化页面
async function initPage() {
  await displayFixedQRCode();
  await checkDiningStatus();
}

// 页面加载完成后初始化
document.addEventListener('DOMContentLoaded', initPage);
```

## ✅ 确认扫码过程能完成就餐确认

### 完整的确认流程验证

1. **✅ 二维码验证**: 验证固定二维码 `DINING_QR_MAIN_001` 的有效性
2. **✅ 时间判断**: 根据扫码时间自动判断餐次（早餐/午餐/晚餐）
3. **✅ 用户验证**: 验证用户身份和状态
4. **✅ 报餐检查**: 检查用户是否已报餐
5. **✅ 重复检查**: 防止重复扫码确认
6. **✅ 状态更新**: 更新订单状态为 `dined`
7. **✅ 日志记录**: 创建确认就餐日志，类型为 `qr`
8. **✅ 数据一致性**: 确保所有相关表的数据同步更新

### 扫码确认的数据变化

**扫码前**:
- `dining_orders.diningStatus = 'ordered'`
- `dining_orders.actualDiningTime = null`
- `dining_confirmation_logs` 无记录

**扫码后**:
- `dining_orders.diningStatus = 'dined'` ✅
- `dining_orders.actualDiningTime = '扫码时间'` ✅
- `dining_confirmation_logs` 新增记录，`confirmationType = 'qr'` ✅
- `dining_registrations` 新增扫码登记记录 ✅

## 📊 总结

**是的，扫码过程完全可以确认就餐！**

系统提供了完整的固定二维码扫码确认就餐功能：

- ✅ **固定二维码**: `DINING_QR_MAIN_001` 供所有用户使用
- ✅ **图片生成**: 后端提供二维码图片生成接口
- ✅ **扫码确认**: 完整的扫码确认就餐流程
- ✅ **状态更新**: 自动更新就餐状态和创建日志
- ✅ **数据一致性**: 确保所有相关数据同步更新
- ✅ **错误处理**: 完善的错误提示和业务规则验证

用户只需要扫描固定的二维码，系统就会自动完成所有必要的确认步骤。
