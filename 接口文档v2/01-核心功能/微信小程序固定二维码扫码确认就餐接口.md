# 微信小程序固定二维码扫码确认就餐接口文档

## 📋 概述

本文档描述了基于微信小程序的固定二维码扫码确认就餐功能。用户通过微信扫描固定二维码，进入小程序进行身份验证，然后调用后端接口确认就餐。

## 🎯 功能特点

- ✅ **固定二维码**：二维码长期有效，无需动态生成
- ✅ **微信外部扫码**：用户用微信扫二维码直接进入小程序
- ✅ **自动身份验证**：小程序内进行微信登录验证
- ✅ **一键确认**：登录后自动调用确认就餐接口
- ✅ **安全可靠**：基于微信官方API，安全可靠

## 🔄 业务流程

```
用户扫描二维码 → 进入微信小程序 → 微信登录验证 → 自动确认就餐 → 显示结果
```

### 详细步骤

1. **扫描二维码**
   - 用户使用微信扫描固定二维码
   - 微信识别二维码内容，跳转到小程序

2. **进入小程序**
   - 小程序自动启动，进入用餐确认页面
   - 获取二维码参数（qrCode）

3. **身份验证**
   - 检查用户登录状态
   - 如果未登录，引导用户进行微信登录
   - 获取用户openid和基本信息

4. **确认就餐**
   - 登录成功后，自动调用确认就餐接口
   - 传递二维码标识和扫码时间

5. **显示结果**
   - 显示确认结果（成功/失败）
   - 成功时显示详细信息（餐次、日期、时间等）

## 🔧 技术实现

### 后端接口

#### 1. 生成微信小程序码

**接口**: `GET /api/qr-scan/qr-codes/:qrCode/image-wechat`

**功能**: 生成微信小程序码（固定二维码）

**请求参数**:
- `qrCode` (path): 二维码标识，如 `DINING_QR_MAIN_001`
- `width` (query, 可选): 二维码宽度，默认200
- `margin` (query, 可选): 二维码边距，默认2

**响应示例**:
```json
{
  "success": true,
  "message": "微信小程序码生成成功",
  "data": {
    "qrCode": "DINING_QR_MAIN_001",
    "imageDataURL": "data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAA...",
    "miniProgramPath": "pages/dining-confirm/dining-confirm?qrCode=DINING_QR_MAIN_001",
    "scene": "DINING_QR_MAIN_001",
    "width": 200,
    "margin": 2
  }
}
```

#### 2. 微信小程序扫码确认就餐

**接口**: `POST /api/qr-scan/wechat-scan`

**功能**: 处理微信小程序扫码确认就餐

**请求头**:
```
Authorization: Bearer {token}
Content-Type: application/json
```

**请求参数**:
```json
{
  "qrCode": "DINING_QR_MAIN_001",
  "scanTime": "2024-01-15T12:30:00.000Z"
}
```

**响应示例**:
```json
{
  "success": true,
  "message": "用餐确认成功",
  "data": {
    "userId": "user123",
    "userName": "张三",
    "qrCode": "DINING_QR_MAIN_001",
    "mealType": "lunch",
    "mealTypeName": "午餐",
    "diningDate": "2024-01-15",
    "scanTime": "2024-01-15 12:30:00",
    "diningStatus": "confirmed",
    "actualDiningTime": "2024-01-15 12:30:00"
  }
}
```

### 微信小程序实现

#### 1. 页面配置

**文件**: `pages/dining-confirm/dining-confirm.json`
```json
{
  "navigationBarTitleText": "用餐确认",
  "navigationBarBackgroundColor": "#07c160",
  "navigationBarTextStyle": "white",
  "backgroundColor": "#f5f5f5"
}
```

#### 2. 页面逻辑

**文件**: `pages/dining-confirm/dining-confirm.js`

**主要功能**:
- 获取二维码参数
- 检查登录状态
- 微信登录验证
- 调用确认就餐接口
- 显示确认结果

#### 3. 页面模板

**文件**: `pages/dining-confirm/dining-confirm.wxml`

**页面结构**:
- 登录提示区域
- 用户信息显示
- 确认按钮
- 结果展示区域

#### 4. 页面样式

**文件**: `pages/dining-confirm/dining-confirm.wxss`

**样式特点**:
- 响应式设计
- 微信风格UI
- 清晰的状态反馈

## 📱 小程序配置

### 1. 小程序基本信息

**app.json**:
```json
{
  "pages": [
    "pages/index/index",
    "pages/dining-confirm/dining-confirm"
  ],
  "window": {
    "backgroundTextStyle": "light",
    "navigationBarBackgroundColor": "#07c160",
    "navigationBarTitleText": "智能用餐系统",
    "navigationBarTextStyle": "white",
    "backgroundColor": "#f5f5f5"
  },
  "networkTimeout": {
    "request": 10000,
    "downloadFile": 10000
  },
  "debug": true
}
```

### 2. 服务器域名配置

需要在微信公众平台配置以下域名：

**request合法域名**:
- `https://your-domain.com` (后端API域名)

**downloadFile合法域名**:
- `https://your-domain.com` (后端API域名)

## 🔐 安全机制

### 1. 微信登录验证

- 使用微信官方登录API
- 验证code的有效性
- 获取用户openid和基本信息
- 生成JWT token进行后续验证

### 2. 接口安全

- 所有接口需要JWT token验证
- 验证用户身份和权限
- 检查二维码的有效性
- 验证扫码时间窗口

### 3. 数据安全

- 敏感信息加密传输
- 用户隐私保护
- 防止重复确认
- 记录操作日志

## 📋 使用说明

### 1. 生成固定二维码

```javascript
// 调用后端接口生成微信小程序码
const response = await fetch('/api/qr-scan/qr-codes/DINING_QR_MAIN_001/image-wechat');
const result = await response.json();
const qrCodeImage = result.data.imageDataURL;

// 显示二维码
const img = document.createElement('img');
img.src = qrCodeImage;
document.body.appendChild(img);
```

### 2. 用户扫码流程

1. **扫描二维码**: 用户使用微信扫描固定二维码
2. **进入小程序**: 微信自动跳转到小程序页面
3. **身份验证**: 小程序检查登录状态，如未登录则引导微信登录
4. **确认就餐**: 登录成功后自动调用确认就餐接口
5. **查看结果**: 显示确认结果和详细信息

### 3. 错误处理

- **登录失败**: 显示错误提示，允许重新登录
- **确认失败**: 显示失败原因，允许重新确认
- **网络错误**: 显示网络错误提示，允许重试
- **权限不足**: 显示权限不足提示

## ⚠️ 注意事项

### 1. 微信小程序配置

- 需要配置正确的服务器域名
- 需要配置正确的页面路径
- 需要配置正确的二维码参数

### 2. 后端配置

- 需要配置正确的微信AppID和AppSecret
- 需要配置正确的API域名
- 需要配置正确的JWT密钥

### 3. 测试环境

- 开发环境可以使用测试AppID
- 生产环境必须使用正式AppID
- 需要配置正确的域名白名单

### 4. 用户体验

- 确保二维码清晰可扫描
- 确保小程序加载速度快
- 确保确认流程简单直观
- 确保错误提示清晰明确

## 🔄 更新日志

### v1.0.0 (2024-01-15)
- 初始版本发布
- 支持微信小程序固定二维码扫码确认就餐
- 支持微信登录验证
- 支持自动确认就餐
- 支持结果展示

## 📞 技术支持

如有问题，请联系技术支持团队：
- 邮箱: support@example.com
- 电话: 400-123-4567
- 微信: tech_support
