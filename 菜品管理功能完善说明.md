# èœå“ç®¡ç†åŠŸèƒ½å®Œå–„è¯´æ˜

## ğŸ¯ åŠŸèƒ½æ¦‚è¿°

æœ¬æ¬¡æ›´æ–°å®Œå–„äº†èœå“ç®¡ç†åŠŸèƒ½ï¼Œå®ç°äº†æ—©ä¸­æ™šé¤èœå“çš„åŒºåˆ†ç®¡ç†ï¼Œè®©ç®¡ç†å‘˜å¯ä»¥ï¼š
1. åœ¨åˆ›å»ºèœå“æ—¶æŒ‡å®šé€‚ç”¨çš„é¤æ¬¡ç±»å‹
2. æŒ‰é¤æ¬¡ç±»å‹æŸ¥è¯¢å’Œç­›é€‰èœå“
3. æ›´æ–°èœå“çš„é¤æ¬¡ç±»å‹è®¾ç½®

## ğŸ—ï¸ æŠ€æœ¯å®ç°

### 1. æ•°æ®åº“å±‚é¢

#### æ–°å¢å­—æ®µ
åœ¨ `dishes` è¡¨ä¸­æ–°å¢äº† `meal_types` å­—æ®µï¼š

```sql
ALTER TABLE dishes 
ADD COLUMN meal_types JSON COMMENT 'é€‚ç”¨é¤æ¬¡ç±»å‹ï¼Œæ•°ç»„æ ¼å¼ï¼š["breakfast", "lunch", "dinner"]' 
AFTER isRecommended;
```

#### å­—æ®µç‰¹æ€§
- **æ•°æ®ç±»å‹**: JSON
- **é»˜è®¤å€¼**: `["breakfast", "lunch", "dinner"]` (é€‚ç”¨äºæ‰€æœ‰é¤æ¬¡)
- **ç´¢å¼•**: æ·»åŠ äº†JSONç´¢å¼•ä»¥æé«˜æŸ¥è¯¢æ€§èƒ½
- **éªŒè¯**: æ”¯æŒ `breakfast`ã€`lunch`ã€`dinner` ä¸‰ç§é¤æ¬¡ç±»å‹

### 2. åç«¯APIå±‚é¢

#### æ–°å¢æ¥å£

**æŒ‰é¤æ¬¡ç±»å‹è·å–èœå“åˆ—è¡¨**
```
GET /api/admin/dishes/meal/:mealType
```

**å‚æ•°è¯´æ˜:**
- `mealType`: é¤æ¬¡ç±»å‹ (`breakfast` | `lunch` | `dinner`)
- `page`: é¡µç  (å¯é€‰ï¼Œé»˜è®¤1)
- `pageSize`: æ¯é¡µæ•°é‡ (å¯é€‰ï¼Œé»˜è®¤20)
- `keyword`: æœç´¢å…³é”®è¯ (å¯é€‰)
- `categoryId`: åˆ†ç±»ID (å¯é€‰)
- `isRecommended`: æ˜¯å¦æ¨è (å¯é€‰)

#### å¢å¼ºæ¥å£

**è·å–èœå“åˆ—è¡¨** (å¢å¼º)
```
GET /api/admin/dishes
```

**æ–°å¢å‚æ•°:**
- `mealType`: æŒ‰é¤æ¬¡ç±»å‹ç­›é€‰ (å¯é€‰)

**åˆ›å»ºèœå“** (å¢å¼º)
```
POST /api/admin/dishes
```

**æ–°å¢å­—æ®µ:**
- `mealTypes`: é¤æ¬¡ç±»å‹æ•°ç»„ (å¯é€‰ï¼Œé»˜è®¤æ‰€æœ‰é¤æ¬¡)

**æ›´æ–°èœå“** (å¢å¼º)
```
PUT /api/admin/dishes/:dishId
```

**æ–°å¢å­—æ®µ:**
- `mealTypes`: é¤æ¬¡ç±»å‹æ•°ç»„ (å¯é€‰)

### 3. æœåŠ¡å±‚å®ç°

#### æ ¸å¿ƒå‡½æ•°

1. **getDishes()** - è·å–èœå“åˆ—è¡¨
   - æ”¯æŒæŒ‰é¤æ¬¡ç±»å‹ç­›é€‰
   - ä½¿ç”¨ `JSON_CONTAINS()` å‡½æ•°è¿›è¡ŒJSONå­—æ®µæŸ¥è¯¢

2. **getDishesByMealType()** - æŒ‰é¤æ¬¡ç±»å‹è·å–èœå“
   - ä¸“é—¨ç”¨äºæŒ‰é¤æ¬¡ç±»å‹æŸ¥è¯¢
   - æ”¯æŒå¤šç§ç­›é€‰æ¡ä»¶ç»„åˆ

3. **createDish()** - åˆ›å»ºèœå“
   - æ”¯æŒè®¾ç½®é¤æ¬¡ç±»å‹
   - é»˜è®¤é€‚ç”¨äºæ‰€æœ‰é¤æ¬¡

4. **updateDish()** - æ›´æ–°èœå“
   - æ”¯æŒæ›´æ–°é¤æ¬¡ç±»å‹
   - ä¿æŒå‘åå…¼å®¹

## ğŸ“Š æ•°æ®ç¤ºä¾‹

### èœå“æ•°æ®æ ¼å¼

```json
{
  "_id": "dish-001",
  "name": "å®«ä¿é¸¡ä¸",
  "description": "ç»å…¸å·èœï¼Œéº»è¾£é²œé¦™",
  "price": 25.50,
  "categoryId": "cat-001",
  "categoryName": "å·èœ",
  "meal_types": ["lunch", "dinner"],
  "status": "active",
  "isRecommended": true,
  "calories": 350,
  "protein": 25.5,
  "fat": 15.2,
  "carbohydrate": 18.7
}
```

### APIå“åº”ç¤ºä¾‹

**æŒ‰é¤æ¬¡ç±»å‹è·å–èœå“**
```json
{
  "success": true,
  "message": "è·å–æ—©é¤èœå“åˆ—è¡¨æˆåŠŸ",
  "data": {
    "list": [
      {
        "_id": "dish-001",
        "name": "å°ç¬¼åŒ…",
        "price": "8.00",
        "meal_types": ["breakfast"],
        "isRecommended": 1
      }
    ],
    "total": 1,
    "page": 1,
    "pageSize": 20,
    "totalPages": 1,
    "mealType": "breakfast"
  }
}
```

## ğŸ”§ ä½¿ç”¨æ–¹æ³•

### 1. åˆ›å»ºèœå“æ—¶æŒ‡å®šé¤æ¬¡ç±»å‹

```javascript
// åˆ›å»ºåªé€‚ç”¨äºæ—©é¤çš„èœå“
const breakfastDish = {
  name: "å°ç¬¼åŒ…",
  categoryId: "cat-001",
  description: "ç»å…¸ä¸Šæµ·å°ç¬¼åŒ…",
  price: 8.00,
  mealTypes: ["breakfast"], // åªé€‚ç”¨äºæ—©é¤
  status: "active"
};

// åˆ›å»ºé€‚ç”¨äºåˆé¤å’Œæ™šé¤çš„èœå“
const lunchDinnerDish = {
  name: "å®«ä¿é¸¡ä¸",
  categoryId: "cat-001", 
  description: "ç»å…¸å·èœ",
  price: 25.50,
  mealTypes: ["lunch", "dinner"], // é€‚ç”¨äºåˆé¤å’Œæ™šé¤
  status: "active"
};
```

### 2. æŒ‰é¤æ¬¡ç±»å‹æŸ¥è¯¢èœå“

```javascript
// è·å–æ—©é¤èœå“
GET /api/admin/dishes/meal/breakfast

// è·å–åˆé¤èœå“
GET /api/admin/dishes/meal/lunch

// è·å–æ™šé¤èœå“
GET /api/admin/dishes/meal/dinner

// åœ¨æ‰€æœ‰èœå“ä¸­ç­›é€‰æ—©é¤èœå“
GET /api/admin/dishes?mealType=breakfast
```

### 3. æ›´æ–°èœå“é¤æ¬¡ç±»å‹

```javascript
// å°†èœå“æ›´æ–°ä¸ºé€‚ç”¨äºæ‰€æœ‰é¤æ¬¡
PUT /api/admin/dishes/dish-001
{
  "mealTypes": ["breakfast", "lunch", "dinner"]
}
```

## ğŸš€ éƒ¨ç½²è¯´æ˜

### 1. æ•°æ®åº“æ›´æ–°

æ‰§è¡Œä»¥ä¸‹SQLè„šæœ¬æ›´æ–°æ•°æ®åº“ç»“æ„ï¼š

```bash
# æ–¹æ³•1: ä½¿ç”¨æä¾›çš„è„šæœ¬
node scripts/update_dishes_meal_types.js

# æ–¹æ³•2: ç›´æ¥æ‰§è¡ŒSQL
mysql -u root -p smart_property < sql/add_meal_types_to_dishes.sql
```

### 2. ä»£ç éƒ¨ç½²

ç¡®ä¿ä»¥ä¸‹æ–‡ä»¶å·²æ›´æ–°ï¼š
- `services/adminService.js` - æœåŠ¡å±‚é€»è¾‘
- `controllers/adminController.js` - æ§åˆ¶å™¨é€»è¾‘  
- `routes/admin.js` - è·¯ç”±å®šä¹‰

### 3. éªŒè¯éƒ¨ç½²

```bash
# æµ‹è¯•æ•°æ®åº“æ›´æ–°
node scripts/test_meal_type_direct.js

# æµ‹è¯•APIæ¥å£
node scripts/test_api_simple.js
```

## ğŸ“ˆ æ€§èƒ½ä¼˜åŒ–

### 1. æ•°æ®åº“ç´¢å¼•

ä¸º `meal_types` å­—æ®µæ·»åŠ äº†JSONç´¢å¼•ï¼š

```sql
ALTER TABLE dishes 
ADD INDEX idx_meal_types ((CAST(meal_types AS CHAR(255) ARRAY)));
```

### 2. æŸ¥è¯¢ä¼˜åŒ–

ä½¿ç”¨ `JSON_CONTAINS()` å‡½æ•°è¿›è¡Œé«˜æ•ˆçš„JSONå­—æ®µæŸ¥è¯¢ï¼š

```sql
SELECT * FROM dishes 
WHERE JSON_CONTAINS(meal_types, '"breakfast"')
AND status = 'active'
```

## ğŸ” æµ‹è¯•éªŒè¯

### 1. åŠŸèƒ½æµ‹è¯•

- âœ… æ•°æ®åº“å­—æ®µæ·»åŠ æˆåŠŸ
- âœ… èœå“åˆ›å»ºæ”¯æŒé¤æ¬¡ç±»å‹
- âœ… èœå“æ›´æ–°æ”¯æŒé¤æ¬¡ç±»å‹
- âœ… æŒ‰é¤æ¬¡ç±»å‹æŸ¥è¯¢åŠŸèƒ½æ­£å¸¸
- âœ… é¤æ¬¡ç±»å‹ç­›é€‰åŠŸèƒ½æ­£å¸¸

### 2. æ•°æ®éªŒè¯

- âœ… ç°æœ‰èœå“è‡ªåŠ¨è®¾ç½®ä¸ºé€‚ç”¨äºæ‰€æœ‰é¤æ¬¡
- âœ… æ–°èœå“é»˜è®¤é€‚ç”¨äºæ‰€æœ‰é¤æ¬¡
- âœ… JSONå­—æ®µæ ¼å¼æ­£ç¡®
- âœ… ç´¢å¼•åˆ›å»ºæˆåŠŸ

## ğŸ‰ æ€»ç»“

æœ¬æ¬¡åŠŸèƒ½å®Œå–„æˆåŠŸå®ç°äº†èœå“æŒ‰é¤æ¬¡ç±»å‹çš„åŒºåˆ†ç®¡ç†ï¼Œä¸»è¦ç‰¹ç‚¹ï¼š

1. **å‘åå…¼å®¹**: ç°æœ‰åŠŸèƒ½ä¸å—å½±å“
2. **çµæ´»é…ç½®**: æ”¯æŒä¸€ä¸ªèœå“é€‚ç”¨äºå¤šä¸ªé¤æ¬¡
3. **é«˜æ•ˆæŸ¥è¯¢**: ä½¿ç”¨JSONç´¢å¼•ä¼˜åŒ–æŸ¥è¯¢æ€§èƒ½
4. **æ˜“äºä½¿ç”¨**: æä¾›ç›´è§‚çš„APIæ¥å£
5. **æ•°æ®å®Œæ•´**: ä¿æŒæ•°æ®ä¸€è‡´æ€§å’Œå®Œæ•´æ€§

é€šè¿‡è¿™æ¬¡æ›´æ–°ï¼Œç®¡ç†å‘˜å¯ä»¥æ›´ç²¾ç¡®åœ°ç®¡ç†ä¸åŒé¤æ¬¡çš„èœå“ï¼Œæå‡ç³»ç»Ÿçš„å®ç”¨æ€§å’Œç”¨æˆ·ä½“éªŒã€‚
