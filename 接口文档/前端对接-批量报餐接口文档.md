# 前端对接 - 批量报餐接口文档

## 📋 接口概述

批量报餐功能支持部门管理员一次性为多个成员、多个餐次、多个日期进行报餐，大大提高了报餐效率。

**基础URL**: `http://localhost:3000`  
**认证方式**: Bearer Token (JWT)  
**权限要求**: 部门管理员 (dept_admin)

---

## 🔐 认证说明

所有接口都需要在请求头中携带JWT Token：

```javascript
headers: {
  'Authorization': `Bearer ${token}`,
  'Content-Type': 'application/json'
}
```

---

## 📡 API接口列表

### 1. 批量报餐接口

**接口地址**: `POST /api/dining/enhanced/batch-orders`

**功能描述**: 支持一次性提交多个日期、多个餐次的报餐申请，每个餐次可以选择不同的成员

**请求参数**:
```typescript
interface BatchOrderRequest {
  orders: OrderItem[];
}

interface OrderItem {
  date: string;           // 用餐日期，格式：YYYY-MM-DD
  mealType: 'breakfast' | 'lunch' | 'dinner';  // 餐次类型
  members: Member[];      // 成员列表
  remark?: string;        // 备注信息，可选，最多500字符
}

interface Member {
  userId: string;         // 用户ID (UUID格式)
}
```

**请求示例**:
```javascript
const requestData = {
  orders: [
    {
      date: "2025-09-06",
      mealType: "lunch",
      members: [
        {"userId": "user1-uuid"},
        {"userId": "user2-uuid"}
      ],
      remark: "今日午餐"
    },
    {
      date: "2025-09-06", 
      mealType: "dinner",
      members: [
        {"userId": "user1-uuid"},
        {"userId": "user3-uuid"}
      ],
      remark: "今日晚餐"
    },
    {
      date: "2025-09-07",
      mealType: "breakfast", 
      members: [
        {"userId": "user1-uuid"},
        {"userId": "user2-uuid"},
        {"userId": "user3-uuid"}
      ],
      remark: "明日早餐"
    }
  ]
};
```

**响应格式**:
```typescript
interface BatchOrderResponse {
  success: boolean;
  message: string;
  data: {
    totalOrders: number;      // 总订单数
    successCount: number;     // 成功订单数
    failedCount: number;      // 失败订单数
    orders: OrderResult[];    // 成功订单列表
    errors: OrderError[];     // 失败订单错误列表
  };
}

interface OrderResult {
  orderId: string;           // 订单ID
  date: string;             // 用餐日期
  mealType: string;         // 餐次类型
  memberCount: number;      // 成员数量
  totalAmount: number;      // 总金额
  status: 'pending';        // 订单状态
}

interface OrderError {
  orderIndex: number;        // 失败订单索引
  date: string;             // 用餐日期
  mealType: string;         // 餐次类型
  error: string;            // 错误信息
}
```

**成功响应示例**:
```json
{
  "success": true,
  "message": "批量报餐提交完成",
  "data": {
    "totalOrders": 3,
    "successCount": 3,
    "failedCount": 0,
    "orders": [
      {
        "orderId": "order-uuid-1",
        "date": "2025-09-06",
        "mealType": "lunch",
        "memberCount": 2,
        "totalAmount": 25.00,
        "status": "pending"
      },
      {
        "orderId": "order-uuid-2", 
        "date": "2025-09-06",
        "mealType": "dinner",
        "memberCount": 2,
        "totalAmount": 30.00,
        "status": "pending"
      },
      {
        "orderId": "order-uuid-3",
        "date": "2025-09-07", 
        "mealType": "breakfast",
        "memberCount": 3,
        "totalAmount": 15.00,
        "status": "pending"
      }
    ],
    "errors": []
  }
}
```

**部分成功响应示例**:
```json
{
  "success": true,
  "message": "批量报餐提交完成",
  "data": {
    "totalOrders": 3,
    "successCount": 2,
    "failedCount": 1,
    "orders": [
      {
        "orderId": "order-uuid-1",
        "date": "2025-09-06",
        "mealType": "lunch",
        "memberCount": 2,
        "totalAmount": 25.00,
        "status": "pending"
      },
      {
        "orderId": "order-uuid-2", 
        "date": "2025-09-06",
        "mealType": "dinner",
        "memberCount": 2,
        "totalAmount": 30.00,
        "status": "pending"
      }
    ],
    "errors": [
      {
        "orderIndex": 3,
        "date": "2025-09-07",
        "mealType": "breakfast",
        "error": "订单 3: 菜单尚未发布"
      }
    ]
  }
}
```

---

### 2. 快速批量报餐接口

**接口地址**: `POST /api/dining/enhanced/quick-batch-orders`

**功能描述**: 为固定的成员列表快速报多个餐次，适用于为同一批人报多个餐次

**请求参数**:
```typescript
interface QuickBatchOrderRequest {
  members: Member[];        // 成员列表，最多50个
  meals: MealItem[];        // 餐次列表，最多10个
  remark?: string;          // 备注信息，可选，最多500字符
}

interface MealItem {
  date: string;             // 用餐日期，格式：YYYY-MM-DD
  mealType: 'breakfast' | 'lunch' | 'dinner';  // 餐次类型
}
```

**请求示例**:
```javascript
const requestData = {
  members: [
    {"userId": "user1-uuid"},
    {"userId": "user2-uuid"},
    {"userId": "user3-uuid"}
  ],
  meals: [
    {date: "2025-09-06", mealType: "lunch"},
    {date: "2025-09-06", mealType: "dinner"},
    {date: "2025-09-07", mealType: "breakfast"},
    {date: "2025-09-07", mealType: "lunch"}
  ],
  remark: "团队批量报餐"
};
```

**响应格式**: 与批量报餐接口相同

---

## 🚨 错误处理

### HTTP状态码

| 状态码 | 说明 | 处理方式 |
|--------|------|----------|
| 200 | 请求成功 | 正常处理响应数据 |
| 400 | 请求参数错误 | 检查请求参数格式 |
| 401 | 未授权 | 重新登录获取Token |
| 403 | 权限不足 | 检查用户权限 |
| 422 | 参数验证失败 | 检查参数格式和必填项 |
| 500 | 服务器内部错误 | 联系后端开发人员 |

### 常见错误信息

| 错误信息 | 原因 | 解决方案 |
|---------|------|----------|
| `订单 1: 缺少必要参数` | 请求参数不完整 | 检查必填字段 |
| `订单 1: 日期格式不正确` | 日期格式错误 | 使用 YYYY-MM-DD 格式 |
| `订单 1: 餐次类型不正确` | 餐次类型错误 | 使用 breakfast/lunch/dinner |
| `订单 1: 不能为过去的日期报餐` | 选择了过去的日期 | 选择今天或未来的日期 |
| `订单 1: 菜单尚未发布` | 对应餐次菜单未发布 | 等待菜单发布或联系管理员 |
| `订单 1: 部分用户不存在或状态异常` | 用户ID错误 | 检查用户ID是否正确 |
| `订单 1: 用户 张三 不属于本部门` | 跨部门报餐 | 只能为同部门成员报餐 |
| `订单 1: 用户 李四 已经报餐` | 重复报餐 | 检查是否已报过该餐次 |

---

## 📝 前端实现示例

### JavaScript/TypeScript 示例

```typescript
// 批量报餐API调用
class BatchDiningAPI {
  private baseURL = 'http://localhost:3000';
  private token: string;

  constructor(token: string) {
    this.token = token;
  }

  // 批量报餐
  async batchOrders(orders: OrderItem[]): Promise<BatchOrderResponse> {
    try {
      const response = await fetch(`${this.baseURL}/api/dining/enhanced/batch-orders`, {
        method: 'POST',
        headers: {
          'Authorization': `Bearer ${this.token}`,
          'Content-Type': 'application/json'
        },
        body: JSON.stringify({ orders })
      });

      if (!response.ok) {
        throw new Error(`HTTP error! status: ${response.status}`);
      }

      return await response.json();
    } catch (error) {
      console.error('批量报餐失败:', error);
      throw error;
    }
  }

  // 快速批量报餐
  async quickBatchOrders(members: Member[], meals: MealItem[], remark?: string): Promise<BatchOrderResponse> {
    try {
      const response = await fetch(`${this.baseURL}/api/dining/enhanced/quick-batch-orders`, {
        method: 'POST',
        headers: {
          'Authorization': `Bearer ${this.token}`,
          'Content-Type': 'application/json'
        },
        body: JSON.stringify({ members, meals, remark })
      });

      if (!response.ok) {
        throw new Error(`HTTP error! status: ${response.status}`);
      }

      return await response.json();
    } catch (error) {
      console.error('快速批量报餐失败:', error);
      throw error;
    }
  }
}

// 使用示例
const api = new BatchDiningAPI(userToken);

// 批量报餐
const batchResult = await api.batchOrders([
  {
    date: "2025-09-06",
    mealType: "lunch",
    members: [{ userId: "user1-uuid" }, { userId: "user2-uuid" }],
    remark: "今日午餐"
  },
  {
    date: "2025-09-06",
    mealType: "dinner", 
    members: [{ userId: "user1-uuid" }, { userId: "user3-uuid" }],
    remark: "今日晚餐"
  }
]);

console.log(`批量报餐完成: 成功 ${batchResult.data.successCount} 个, 失败 ${batchResult.data.failedCount} 个`);

// 快速批量报餐
const quickResult = await api.quickBatchOrders(
  [{ userId: "user1-uuid" }, { userId: "user2-uuid" }],
  [
    { date: "2025-09-06", mealType: "lunch" },
    { date: "2025-09-06", mealType: "dinner" },
    { date: "2025-09-07", mealType: "breakfast" }
  ],
  "团队批量报餐"
);
```

### React Hook 示例

```typescript
import { useState, useCallback } from 'react';

interface UseBatchDiningReturn {
  loading: boolean;
  error: string | null;
  batchOrders: (orders: OrderItem[]) => Promise<BatchOrderResponse>;
  quickBatchOrders: (members: Member[], meals: MealItem[], remark?: string) => Promise<BatchOrderResponse>;
}

export const useBatchDining = (token: string): UseBatchDiningReturn => {
  const [loading, setLoading] = useState(false);
  const [error, setError] = useState<string | null>(null);

  const apiCall = useCallback(async (url: string, data: any) => {
    setLoading(true);
    setError(null);

    try {
      const response = await fetch(url, {
        method: 'POST',
        headers: {
          'Authorization': `Bearer ${token}`,
          'Content-Type': 'application/json'
        },
        body: JSON.stringify(data)
      });

      if (!response.ok) {
        const errorData = await response.json();
        throw new Error(errorData.message || `HTTP error! status: ${response.status}`);
      }

      return await response.json();
    } catch (err) {
      const errorMessage = err instanceof Error ? err.message : '未知错误';
      setError(errorMessage);
      throw err;
    } finally {
      setLoading(false);
    }
  }, [token]);

  const batchOrders = useCallback(async (orders: OrderItem[]) => {
    return apiCall('http://localhost:3000/api/dining/enhanced/batch-orders', { orders });
  }, [apiCall]);

  const quickBatchOrders = useCallback(async (members: Member[], meals: MealItem[], remark?: string) => {
    return apiCall('http://localhost:3000/api/dining/enhanced/quick-batch-orders', { members, meals, remark });
  }, [apiCall]);

  return {
    loading,
    error,
    batchOrders,
    quickBatchOrders
  };
};

// 组件中使用
const BatchDiningComponent = () => {
  const { loading, error, batchOrders, quickBatchOrders } = useBatchDining(userToken);

  const handleBatchSubmit = async (orders: OrderItem[]) => {
    try {
      const result = await batchOrders(orders);
      console.log('批量报餐成功:', result);
      // 处理成功结果
    } catch (err) {
      console.error('批量报餐失败:', err);
      // 处理错误
    }
  };

  return (
    <div>
      {loading && <div>提交中...</div>}
      {error && <div>错误: {error}</div>}
      {/* 您的UI组件 */}
    </div>
  );
};
```

---

## 🎯 使用场景示例

### 场景1: 部门管理员为团队报餐

```javascript
// 今天午餐、晚餐 + 明天早餐
const batchOrder = {
  orders: [
    {
      date: "2025-09-06",
      mealType: "lunch", 
      members: [
        {"userId": "user1-uuid"}, 
        {"userId": "user2-uuid"}
      ],
      remark: "今日午餐"
    },
    {
      date: "2025-09-06",
      mealType: "dinner",
      members: [
        {"userId": "user1-uuid"}, 
        {"userId": "user3-uuid"}
      ],
      remark: "今日晚餐"
    },
    {
      date: "2025-09-07", 
      mealType: "breakfast",
      members: [
        {"userId": "user1-uuid"}, 
        {"userId": "user2-uuid"}, 
        {"userId": "user3-uuid"}
      ],
      remark: "明日早餐"
    }
  ]
};
```

### 场景2: 快速为固定团队报多餐

```javascript
// 为固定团队报今天和明天的所有餐次
const quickBatch = {
  members: [
    {"userId": "user1-uuid"}, 
    {"userId": "user2-uuid"}
  ],
  meals: [
    {date: "2025-09-06", mealType: "lunch"},
    {date: "2025-09-06", mealType: "dinner"}, 
    {date: "2025-09-07", mealType: "breakfast"},
    {date: "2025-09-07", mealType: "lunch"}
  ],
  remark: "团队批量报餐"
};
```

### 场景3: 复杂报餐需求

```javascript
// 不同餐次选择不同成员
const complexBatch = {
  orders: [
    // 今天午餐：A组
    {
      date: "2025-09-06",
      mealType: "lunch",
      members: [
        {"userId": "user1-uuid"},
        {"userId": "user2-uuid"}
      ],
      remark: "A组今日午餐"
    },
    // 今天晚餐：B组
    {
      date: "2025-09-06",
      mealType: "dinner",
      members: [
        {"userId": "user3-uuid"},
        {"userId": "user4-uuid"}
      ],
      remark: "B组今日晚餐"
    },
    // 明天早餐：全员
    {
      date: "2025-09-07",
      mealType: "breakfast",
      members: [
        {"userId": "user1-uuid"},
        {"userId": "user2-uuid"},
        {"userId": "user3-uuid"},
        {"userId": "user4-uuid"}
      ],
      remark: "全员明日早餐"
    }
  ]
};
```

---

## ⚠️ 注意事项

### 1. 数量限制
- **批量报餐**: 最多20个订单
- **快速批量**: 最多50个成员，10个餐次

### 2. 时间限制
- 不能为过去的日期报餐
- 建议提前1天报餐

### 3. 权限限制
- 只有部门管理员可以使用
- 只能为同部门成员报餐

### 4. 菜单依赖
- 需要对应日期和餐次的菜单已发布
- 建议先检查菜单状态

### 5. 重复检查
- 系统会自动检查重复报餐
- 建议前端也做重复检查

### 6. 错误处理
- 建议根据错误信息进行相应处理
- 部分成功时显示成功和失败的订单

---

## 🔧 调试建议

### 1. 请求日志
```javascript
// 在发送请求前打印日志
console.log('发送批量报餐请求:', JSON.stringify(requestData, null, 2));
```

### 2. 响应日志
```javascript
// 在收到响应后打印日志
console.log('批量报餐响应:', JSON.stringify(response, null, 2));
```

### 3. 错误处理
```javascript
try {
  const result = await batchOrders(orders);
  // 处理成功结果
} catch (error) {
  console.error('批量报餐错误:', error);
  // 根据错误类型进行不同处理
  if (error.message.includes('权限不足')) {
    // 重新登录
  } else if (error.message.includes('参数验证失败')) {
    // 检查参数格式
  } else {
    // 其他错误处理
  }
}
```

---

## 📞 技术支持

如有问题，请联系后端开发团队或查看服务器日志获取详细错误信息。

**服务器地址**: `http://localhost:3000`  
**健康检查**: `http://localhost:3000/health`