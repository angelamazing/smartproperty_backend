# 扫码就餐登记接口文档

## 📖 功能概述

扫码就餐登记功能为用户提供极简的就餐登记体验。用户通过扫描餐厅张贴的二维码，系统根据扫码时间自动判断餐次（早餐、午餐、晚餐），并完成就餐登记。支持微信扫码和内部扫码两种方式。

## 🎯 核心特性

- ✅ **自动餐次判断**: 根据扫码时间自动识别早餐(6:00-10:00)、午餐(11:00-14:00)、晚餐(17:00-20:00)
- ✅ **业务规则验证**: 检查用户是否已报餐、是否重复登记等
- ✅ **二维码管理**: 支持二维码的创建、管理和状态控制
- ✅ **数据统计**: 提供各餐别就餐数据统计功能
- ✅ **历史查询**: 支持用户就餐登记历史记录查询

## 🔗 接口列表

### 1. 扫码就餐登记

**接口地址**: `POST /api/qr-scan/scan`

**功能描述**: 处理用户扫码就餐登记请求

**权限要求**: 已登录用户

**请求参数**:
```json
{
  "qrCode": "DINING_QR_MAIN_001",
  "scanTime": "2025-09-09T12:30:00.000Z"
}
```

**参数说明**:
- `qrCode`: 二维码标识，必填，最大100字符
- `scanTime`: 扫码时间，必填，ISO 8601格式

**响应示例**:
```json
{
  "success": true,
  "message": "登记成功！[午餐] 2025-09-09 12:30",
  "data": {
    "userId": "user-uuid",
    "userName": "张三",
    "mealType": "lunch",
    "mealTypeName": "午餐",
    "diningDate": "2025-09-09",
    "scanTime": "2025-09-09 12:30:00",
    "qrCodeInfo": {
      "name": "餐厅主入口二维码",
      "location": "餐厅主入口"
    }
  },
  "code": "200",
  "timestamp": "2025-09-09T12:30:00.000Z"
}
```

**错误响应**:
```json
{
  "success": false,
  "message": "您尚未报餐，无法进行就餐登记",
  "error": "您尚未报餐，无法进行就餐登记",
  "code": "400",
  "timestamp": "2025-09-09T12:30:00.000Z"
}
```

### 2. 获取用户就餐登记历史

**接口地址**: `GET /api/qr-scan/history`

**功能描述**: 获取用户的历史就餐登记记录

**权限要求**: 已登录用户

**请求参数**:
```
GET /api/qr-scan/history?startDate=2025-09-01&endDate=2025-09-09&mealType=lunch&limit=20&offset=0
```

**参数说明**:
- `startDate`: 开始日期，可选，格式：YYYY-MM-DD
- `endDate`: 结束日期，可选，格式：YYYY-MM-DD
- `mealType`: 餐次类型，可选，枚举值：breakfast/lunch/dinner
- `limit`: 每页数量，可选，默认50，最大100
- `offset`: 偏移量，可选，默认0

**响应示例**:
```json
{
  "success": true,
  "message": "获取登记历史成功",
  "data": [
    {
      "_id": "registration-uuid",
      "userId": "user-uuid",
      "userName": "张三",
      "qrCodeId": "qr-uuid",
      "qrCode": "DINING_QR_MAIN_001",
      "scanTime": "2025-09-09T12:30:00.000Z",
      "mealType": "lunch",
      "mealTypeName": "午餐",
      "diningDate": "2025-09-09",
      "status": "success",
      "scanTimeFormatted": "2025-09-09 12:30:00",
      "qrCodeName": "餐厅主入口二维码",
      "qrCodeLocation": "餐厅主入口"
    }
  ],
  "code": "200",
  "timestamp": "2025-09-09T12:30:00.000Z"
}
```

### 3. 获取今日就餐概览

**接口地址**: `GET /api/qr-scan/today-overview`

**功能描述**: 获取用户今日各餐次的报餐和登记状态

**权限要求**: 已登录用户

**请求参数**: 无

**响应示例**:
```json
{
  "success": true,
  "message": "获取今日概览成功",
  "data": {
    "date": "2025-09-09",
    "breakfast": {
      "ordered": true,
      "registered": true,
      "lastOrderTime": "2025-09-09T08:00:00.000Z",
      "lastScanTime": "2025-09-09T08:30:00.000Z"
    },
    "lunch": {
      "ordered": true,
      "registered": false,
      "lastOrderTime": "2025-09-09T10:00:00.000Z",
      "lastScanTime": null
    },
    "dinner": {
      "ordered": false,
      "registered": false,
      "lastOrderTime": null,
      "lastScanTime": null
    }
  },
  "code": "200",
  "timestamp": "2025-09-09T12:30:00.000Z"
}
```

## 🔧 管理员功能

### 4. 获取就餐统计信息

**接口地址**: `GET /api/qr-scan/statistics`

**功能描述**: 获取指定日期的就餐统计数据

**权限要求**: 部门管理员及以上

**请求参数**:
```
GET /api/qr-scan/statistics?date=2025-09-09
```

**参数说明**:
- `date`: 统计日期，可选，格式：YYYY-MM-DD，默认今天

**响应示例**:
```json
{
  "success": true,
  "message": "获取就餐统计成功",
  "data": {
    "date": "2025-09-09",
    "breakfast": {
      "registrations": 25,
      "users": 20
    },
    "lunch": {
      "registrations": 45,
      "users": 40
    },
    "dinner": {
      "registrations": 30,
      "users": 28
    },
    "total": {
      "registrations": 100,
      "users": 88
    }
  },
  "code": "200",
  "timestamp": "2025-09-09T12:30:00.000Z"
}
```

### 5. 创建二维码

**接口地址**: `POST /api/qr-scan/qr-codes`

**功能描述**: 创建新的二维码

**权限要求**: 部门管理员及以上

**请求参数**:
```json
{
  "name": "餐厅B区二维码",
  "location": "餐厅B区入口",
  "description": "餐厅B区通用二维码，支持所有餐次登记"
}
```

**参数说明**:
- `name`: 二维码名称，必填，2-100字符
- `location`: 张贴位置，必填，2-200字符
- `description`: 描述信息，可选，最大500字符

**响应示例**:
```json
{
  "success": true,
  "message": "二维码创建成功",
  "data": {
    "qrId": "qr-uuid",
    "code": "DINING_QR_1705123456789_ABC123DEF",
    "message": "二维码创建成功"
  },
  "code": "200",
  "timestamp": "2025-09-09T12:30:00.000Z"
}
```

### 6. 获取二维码列表

**接口地址**: `GET /api/qr-scan/qr-codes`

**功能描述**: 获取二维码列表

**权限要求**: 部门管理员及以上

**请求参数**:
```
GET /api/qr-scan/qr-codes?status=active&limit=50&offset=0
```

**参数说明**:
- `status`: 状态筛选，可选，枚举值：active/inactive
- `limit`: 每页数量，可选，默认100，最大200
- `offset`: 偏移量，可选，默认0

**响应示例**:
```json
{
  "success": true,
  "message": "获取二维码列表成功",
  "data": [
    {
      "_id": "qr-uuid",
      "code": "DINING_QR_MAIN_001",
      "name": "餐厅主入口二维码",
      "location": "餐厅主入口",
      "description": "餐厅主入口通用二维码，支持所有餐次登记",
      "status": "active",
      "createTime": "2025-09-09T08:00:00.000Z",
      "updateTime": "2025-09-09T08:00:00.000Z"
    }
  ],
  "code": "200",
  "timestamp": "2025-09-09T12:30:00.000Z"
}
```

### 7. 获取二维码详情

**接口地址**: `GET /api/qr-scan/qr-codes/:qrId`

**功能描述**: 获取指定二维码的详细信息和使用统计

**权限要求**: 部门管理员及以上

**请求参数**: 路径参数
- `qrId`: 二维码ID

**响应示例**:
```json
{
  "success": true,
  "message": "获取二维码详情成功",
  "data": {
    "_id": "qr-uuid",
    "code": "DINING_QR_MAIN_001",
    "name": "餐厅主入口二维码",
    "location": "餐厅主入口",
    "description": "餐厅主入口通用二维码，支持所有餐次登记",
    "status": "active",
    "createTime": "2025-09-09T08:00:00.000Z",
    "updateTime": "2025-09-09T08:00:00.000Z",
    "usageStats": {
      "totalScans": 150,
      "uniqueUsers": 120,
      "successfulScans": 145,
      "failedScans": 5
    }
  },
  "code": "200",
  "timestamp": "2025-09-09T12:30:00.000Z"
}
```

### 8. 更新二维码状态

**接口地址**: `PUT /api/qr-scan/qr-codes/:qrId/status`

**功能描述**: 更新二维码的启用/停用状态

**权限要求**: 部门管理员及以上

**请求参数**:
```json
{
  "status": "inactive"
}
```

**参数说明**:
- `status`: 状态，必填，枚举值：active/inactive

**响应示例**:
```json
{
  "success": true,
  "message": "二维码状态更新成功",
  "data": {
    "qrId": "qr-uuid",
    "status": "inactive"
  },
  "code": "200",
  "timestamp": "2025-09-09T12:30:00.000Z"
}
```

## 📋 业务规则

### 扫码登记规则

1. **时间限制**: 只有在就餐时间内扫码才能成功登记
   - 早餐时间: 6:00-10:00
   - 午餐时间: 11:00-14:00
   - 晚餐时间: 17:00-20:00

2. **报餐验证**: 用户必须先报餐才能进行就餐登记

3. **重复登记**: 同一用户同一餐次只能登记一次

4. **二维码有效性**: 只有状态为"active"的二维码才能使用

### 错误处理

| 错误信息 | 原因 | 解决方案 |
|---------|------|---------|
| 当前时间不在就餐时间内 | 扫码时间不在规定就餐时间内 | 在就餐时间内扫码 |
| 您尚未报餐，无法进行就餐登记 | 用户未报餐 | 先进行报餐操作 |
| 您已登记过本次就餐 | 重复登记 | 无需重复操作 |
| 二维码无效或已停用 | 二维码不存在或已停用 | 联系管理员检查二维码状态 |
| 用户不存在或已被禁用 | 用户状态异常 | 联系管理员检查用户状态 |

## 🚀 使用流程

### 用户扫码流程

1. **准备阶段**
   - 管理员从后台获取二维码
   - 打印并张贴在餐厅各位置

2. **扫码登记**
   - 用户到达餐厅
   - 使用微信扫一扫或小程序内部扫码功能
   - 扫描二维码
   - 系统自动判断餐次并完成登记

3. **结果反馈**
   - 成功: 显示"登记成功！[餐次] 日期 时间"
   - 失败: 显示具体失败原因

### 管理员管理流程

1. **二维码管理**
   - 创建新二维码
   - 设置张贴位置和描述
   - 管理二维码状态

2. **数据统计**
   - 查看各餐别就餐统计
   - 分析就餐数据趋势
   - 导出统计报表

## 🔒 安全考虑

1. **权限控制**: 所有接口都需要相应的权限验证
2. **数据验证**: 严格的参数验证和业务规则检查
3. **日志记录**: 完整的操作日志和错误记录
4. **防重复**: 防止重复登记和恶意扫码

## 📊 数据库设计

### 新增表结构

#### qr_codes (二维码管理表)
```sql
CREATE TABLE qr_codes (
  _id VARCHAR(36) PRIMARY KEY,
  code VARCHAR(100) UNIQUE NOT NULL,
  name VARCHAR(100) NOT NULL,
  location VARCHAR(200),
  description TEXT,
  status ENUM('active', 'inactive') DEFAULT 'active',
  createTime TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  updateTime TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP
);
```

#### dining_registrations (就餐登记表)
```sql
CREATE TABLE dining_registrations (
  _id VARCHAR(36) PRIMARY KEY,
  userId VARCHAR(36) NOT NULL,
  userName VARCHAR(50) NOT NULL,
  qrCodeId VARCHAR(36) NOT NULL,
  qrCode VARCHAR(100) NOT NULL,
  scanTime TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  mealType ENUM('breakfast', 'lunch', 'dinner') NOT NULL,
  diningDate DATE NOT NULL,
  orderId VARCHAR(36),
  status ENUM('success', 'failed') DEFAULT 'success',
  failureReason TEXT,
  createTime TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  
  UNIQUE KEY uk_user_date_meal (userId, diningDate, mealType),
  FOREIGN KEY (userId) REFERENCES users(_id) ON DELETE CASCADE,
  FOREIGN KEY (qrCodeId) REFERENCES qr_codes(_id) ON DELETE CASCADE,
  FOREIGN KEY (orderId) REFERENCES dining_orders(_id) ON DELETE SET NULL
);
```

#### dining_orders 表新增字段
```sql
ALTER TABLE dining_orders ADD COLUMN actualDiningTime TIMESTAMP NULL COMMENT '实际就餐时间';
ALTER TABLE dining_orders ADD COLUMN diningStatus ENUM('ordered', 'dined', 'cancelled') DEFAULT 'ordered' COMMENT '就餐状态';
```

---

**文档版本**: v1.0.0  
**最后更新**: 2025年9月  
**维护团队**: 湖北省地质局第三地质大队
