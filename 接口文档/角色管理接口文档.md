# 角色管理接口文档

## 概述

本文档描述了角色管理系统的完整API接口，包括角色的增删改查、权限分配、用户角色管理等功能。系统支持多种角色类型，包括普通用户、管理员、系统管理员等。

## 基础信息

- **基础URL**: `http://localhost:3000/api/admin`
- **认证方式**: Bearer Token (JWT)
- **内容类型**: `application/json`
- **字符编码**: UTF-8

## 认证说明

所有接口都需要在请求头中携带有效的JWT Token：

```http
Authorization: Bearer <your-jwt-token>
```

获取Token的方式：
```http
POST /api/auth/test-login-admin
Content-Type: application/json

{
  "phoneNumber": "13800000001",
  "password": "admin123"
}
```

## 接口列表

### 1. 获取角色列表

**接口地址**: `GET /api/admin/roles`

**功能描述**: 获取所有活跃角色的列表，包含权限信息和用户数量

**请求头**:
```http
Authorization: Bearer <token>
```

**响应示例**:
```json
{
  "success": true,
  "message": "获取角色列表成功",
  "data": [
    {
      "id": "role_001",
      "name": "user",
      "description": "普通用户",
      "status": "active",
      "create_time": "2025-01-01T00:00:00.000Z",
      "update_time": "2025-01-01T00:00:00.000Z",
      "create_by": null,
      "user_count": 56,
      "permissions": [],
      "permissionCount": 0
    },
    {
      "id": "role_002",
      "name": "admin",
      "description": "普通管理员",
      "status": "active",
      "create_time": "2025-01-01T00:00:00.000Z",
      "update_time": "2025-01-01T00:00:00.000Z",
      "create_by": null,
      "user_count": 0,
      "permissions": [],
      "permissionCount": 0
    },
    {
      "id": "role_003",
      "name": "sys_admin",
      "description": "系统管理员",
      "status": "active",
      "create_time": "2025-01-01T00:00:00.000Z",
      "update_time": "2025-01-01T00:00:00.000Z",
      "create_by": null,
      "user_count": 1,
      "permissions": [],
      "permissionCount": 0
    }
  ],
  "timestamp": "2025-01-01T12:00:00.000Z"
}
```

### 2. 获取角色详情

**接口地址**: `GET /api/admin/roles/{roleId}`

**功能描述**: 根据角色ID获取角色详细信息，包含权限列表和分配的用户

**路径参数**:

| 参数名 | 类型 | 必填 | 说明 |
|--------|------|------|------|
| roleId | string | 是 | 角色唯一标识符 |

**请求示例**:
```http
GET /api/admin/roles/role_001
Authorization: Bearer <token>
```

**响应示例**:
```json
{
  "success": true,
  "message": "获取角色详情成功",
  "data": {
    "id": "role_001",
    "name": "user",
    "description": "普通用户",
    "status": "active",
    "create_time": "2025-01-01T00:00:00.000Z",
    "update_time": "2025-01-01T00:00:00.000Z",
    "create_by": null,
    "permissions": [],
    "permissionCount": 0,
    "assignedUsers": [],
    "userCount": 0
  },
  "timestamp": "2025-01-01T12:00:00.000Z"
}
```

### 3. 创建角色

**接口地址**: `POST /api/admin/roles`

**功能描述**: 创建新的角色

**请求头**:
```http
Authorization: Bearer <token>
Content-Type: application/json
```

**请求体参数**:

| 参数名 | 类型 | 必填 | 说明 |
|--------|------|------|------|
| name | string | 是 | 角色名称，最大50字符，唯一 |
| description | string | 否 | 角色描述，最大200字符 |
| permissions | array | 否 | 权限ID数组 |
| status | string | 否 | 状态：active(活跃)、inactive(非活跃)，默认active |

**请求示例**:
```http
POST /api/admin/roles
Authorization: Bearer <token>
Content-Type: application/json

{
  "name": "内容编辑员",
  "description": "负责内容编辑和审核",
  "permissions": [],
  "status": "active"
}
```

**响应示例**:
```json
{
  "success": true,
  "message": "创建角色成功",
  "data": {
    "id": "role_004",
    "name": "内容编辑员",
    "description": "负责内容编辑和审核",
    "status": "active"
  },
  "timestamp": "2025-01-01T12:00:00.000Z"
}
```

### 4. 更新角色

**接口地址**: `PUT /api/admin/roles/{roleId}`

**功能描述**: 更新角色信息

**路径参数**:

| 参数名 | 类型 | 必填 | 说明 |
|--------|------|------|------|
| roleId | string | 是 | 角色唯一标识符 |

**请求体参数**: 与创建角色相同，所有字段都是可选的

**请求示例**:
```http
PUT /api/admin/roles/role_004
Authorization: Bearer <token>
Content-Type: application/json

{
  "name": "高级内容编辑员",
  "description": "负责高级内容编辑和审核，拥有更多权限"
}
```

**响应示例**:
```json
{
  "success": true,
  "message": "更新角色成功",
  "data": {
    "id": "role_004",
    "name": "高级内容编辑员",
    "description": "负责高级内容编辑和审核，拥有更多权限",
    "status": "active"
  },
  "timestamp": "2025-01-01T12:00:00.000Z"
}
```

### 5. 删除角色

**接口地址**: `DELETE /api/admin/roles/{roleId}`

**功能描述**: 删除角色（软删除）

**路径参数**:

| 参数名 | 类型 | 必填 | 说明 |
|--------|------|------|------|
| roleId | string | 是 | 角色唯一标识符 |

**请求示例**:
```http
DELETE /api/admin/roles/role_004
Authorization: Bearer <token>
```

**响应示例**:
```json
{
  "success": true,
  "message": "删除角色成功",
  "timestamp": "2025-01-01T12:00:00.000Z"
}
```

### 6. 获取权限列表

**接口地址**: `GET /api/admin/permissions`

**功能描述**: 获取所有可用权限列表，按模块分组

**请求示例**:
```http
GET /api/admin/permissions
Authorization: Bearer <token>
```

**响应示例**:
```json
{
  "success": true,
  "message": "获取权限列表成功",
  "data": {
    "permissions": [],
    "groupedPermissions": {}
  },
  "timestamp": "2025-01-01T12:00:00.000Z"
}
```

### 7. 更新角色权限

**接口地址**: `PUT /api/admin/roles/{roleId}/permissions`

**功能描述**: 更新角色的权限分配

**路径参数**:

| 参数名 | 类型 | 必填 | 说明 |
|--------|------|------|------|
| roleId | string | 是 | 角色唯一标识符 |

**请求体参数**:

| 参数名 | 类型 | 必填 | 说明 |
|--------|------|------|------|
| permissionIds | array | 是 | 权限ID数组 |

**请求示例**:
```http
PUT /api/admin/roles/role_004/permissions
Authorization: Bearer <token>
Content-Type: application/json

{
  "permissionIds": ["perm_001", "perm_002", "perm_003"]
}
```

**响应示例**:
```json
{
  "success": true,
  "message": "更新角色权限成功",
  "data": {
    "roleId": "role_004",
    "permissionCount": 3,
    "updateTime": "2025-01-01T12:00:00.000Z"
  },
  "timestamp": "2025-01-01T12:00:00.000Z"
}
```

### 8. 分配角色

**接口地址**: `POST /api/admin/roles/assign`

**功能描述**: 将角色分配给指定用户

**请求体参数**:

| 参数名 | 类型 | 必填 | 说明 |
|--------|------|------|------|
| userId | string | 是 | 用户ID |
| roleId | string | 是 | 角色ID |

**请求示例**:
```http
POST /api/admin/roles/assign
Authorization: Bearer <token>
Content-Type: application/json

{
  "userId": "user_001",
  "roleId": "role_004"
}
```

**响应示例**:
```json
{
  "success": true,
  "message": "分配角色成功",
  "timestamp": "2025-01-01T12:00:00.000Z"
}
```

### 9. 批量分配角色

**接口地址**: `POST /api/admin/roles/batch-assign`

**功能描述**: 批量分配角色给多个用户

**请求体参数**:

| 参数名 | 类型 | 必填 | 说明 |
|--------|------|------|------|
| assignments | array | 是 | 分配列表，每个元素包含userId和roleId |

**请求示例**:
```http
POST /api/admin/roles/batch-assign
Authorization: Bearer <token>
Content-Type: application/json

{
  "assignments": [
    {
      "userId": "user_001",
      "roleId": "role_004"
    },
    {
      "userId": "user_002",
      "roleId": "role_004"
    }
  ]
}
```

**响应示例**:
```json
{
  "success": true,
  "message": "批量分配角色完成",
  "data": {
    "total": 2,
    "success": 2,
    "failed": 0,
    "results": [
      {
        "userId": "user_001",
        "roleId": "role_004",
        "success": true,
        "roleName": "内容编辑员"
      },
      {
        "userId": "user_002",
        "roleId": "role_004",
        "success": true,
        "roleName": "内容编辑员"
      }
    ]
  },
  "timestamp": "2025-01-01T12:00:00.000Z"
}
```

## 数据字典

### 角色状态 (status)

| 值 | 说明 |
|----|------|
| active | 活跃 |
| inactive | 非活跃 |
| deleted | 已删除 |

### 默认角色

| 角色名称 | 角色代码 | 说明 |
|----------|----------|------|
| 普通用户 | user | 系统普通用户，基础权限 |
| 普通管理员 | admin | 部门管理员，管理权限 |
| 系统管理员 | sys_admin | 系统管理员，最高权限 |

## 错误码说明

| 错误码 | 说明 |
|--------|------|
| 400 | 请求参数错误 |
| 401 | 未授权，Token无效或过期 |
| 403 | 权限不足 |
| 404 | 资源不存在 |
| 409 | 资源冲突（如角色名称重复） |
| 500 | 服务器内部错误 |

## 错误响应格式

```json
{
  "success": false,
  "message": "错误描述信息",
  "code": "400",
  "timestamp": "2025-01-01T12:00:00.000Z"
}
```

## 注意事项

1. **认证要求**: 所有接口都需要有效的JWT Token
2. **权限控制**: 需要管理员权限才能访问这些接口
3. **数据验证**: 所有输入数据都会进行严格验证
4. **角色唯一性**: 角色名称必须唯一
5. **软删除**: 删除操作采用软删除方式，保护数据完整性
6. **权限表**: 权限管理功能需要`permissions`和`role_permissions`表支持

## 测试用例

### 完整流程测试

```javascript
// 1. 登录获取Token
const loginResponse = await fetch('/api/auth/test-login-admin', {
  method: 'POST',
  headers: { 'Content-Type': 'application/json' },
  body: JSON.stringify({
    phoneNumber: '13800000001',
    password: 'admin123'
  })
});
const { data: { token } } = await loginResponse.json();

// 2. 获取角色列表
const rolesResponse = await fetch('/api/admin/roles', {
  headers: { 'Authorization': `Bearer ${token}` }
});

// 3. 创建新角色
const createResponse = await fetch('/api/admin/roles', {
  method: 'POST',
  headers: {
    'Authorization': `Bearer ${token}`,
    'Content-Type': 'application/json'
  },
  body: JSON.stringify({
    name: '测试角色',
    description: '这是一个测试角色',
    status: 'active'
  })
});

// 4. 更新角色权限
const roleId = createResponse.data.id;
await fetch(`/api/admin/roles/${roleId}/permissions`, {
  method: 'PUT',
  headers: {
    'Authorization': `Bearer ${token}`,
    'Content-Type': 'application/json'
  },
  body: JSON.stringify({
    permissionIds: []
  })
});

// 5. 分配角色给用户
await fetch('/api/admin/roles/assign', {
  method: 'POST',
  headers: {
    'Authorization': `Bearer ${token}`,
    'Content-Type': 'application/json'
  },
  body: JSON.stringify({
    userId: 'user_001',
    roleId: roleId
  })
});
```

## 更新日志

- **v1.0.0** (2025-01-01): 初始版本，包含完整的角色CRUD操作
- **v1.0.1** (2025-01-01): 添加权限管理功能
- **v1.0.2** (2025-01-01): 添加批量分配角色功能
- **v1.0.3** (2025-01-01): 优化角色列表接口，添加权限信息
