# 通知设置接口文档

## 📋 接口概述

通知设置接口提供用户通知偏好的获取、更新和管理功能，包括系统通知、业务通知、消息通知、通知方式以及免打扰时间等设置。

**基础路径**: `/api/user`

**认证要求**: 所有接口都需要有效的JWT Token

## 🔐 接口列表

### 1. 获取通知设置

**接口地址**: `GET /api/user/notification-settings`

**接口描述**: 获取当前用户的通知设置配置

**权限要求**: 用户登录认证

**请求头**:
```http
Authorization: Bearer {token}
Content-Type: application/json
```

**请求参数**: 无

**成功响应**:
```json
{
  "success": true,
  "message": "获取通知设置成功",
  "code": "200",
  "timestamp": "2025-01-27T10:30:00.000Z",
  "data": {
    "systemAnnouncement": true,
    "securityAlert": true,
    "mealReminder": true,
    "courtBooking": true,
    "approvalNotification": true,
    "instantMessage": true,
    "groupMessage": true,
    "inAppNotification": true,
    "pushNotification": true,
    "emailNotification": false,
    "doNotDisturb": false,
    "dndStartTime": "22:00",
    "dndEndTime": "08:00",
    "lastUpdated": "2025-01-27T10:30:00.000Z"
  }
}
```

**错误响应**:
```json
{
  "success": false,
  "message": "获取通知设置失败",
  "code": "500",
  "timestamp": "2025-01-27T10:30:00.000Z"
}
```

**常见错误码**:
- `401`: 未授权，Token无效或过期
- `404`: 用户不存在
- `500`: 服务器内部错误

---

### 2. 更新通知设置

**接口地址**: `PUT /api/user/notification-settings`

**接口描述**: 更新用户的通知设置配置

**权限要求**: 用户登录认证

**请求头**:
```http
Authorization: Bearer {token}
Content-Type: application/json
```

**请求参数**:
```json
{
  "systemAnnouncement": true,
  "securityAlert": true,
  "mealReminder": true,
  "courtBooking": true,
  "approvalNotification": true,
  "instantMessage": true,
  "groupMessage": true,
  "inAppNotification": true,
  "pushNotification": true,
  "emailNotification": false,
  "doNotDisturb": false,
  "dndStartTime": "22:00",
  "dndEndTime": "08:00"
}
```

**参数说明**:
| 参数名 | 类型 | 必填 | 说明 | 默认值 |
|--------|------|------|------|--------|
| systemAnnouncement | boolean | ❌ | 系统公告通知 | true |
| securityAlert | boolean | ❌ | 安全提醒通知 | true |
| mealReminder | boolean | ❌ | 报餐提醒通知 | true |
| courtBooking | boolean | ❌ | 球馆预约通知 | true |
| approvalNotification | boolean | ❌ | 审批通知 | true |
| instantMessage | boolean | ❌ | 即时消息通知 | true |
| groupMessage | boolean | ❌ | 群组消息通知 | true |
| inAppNotification | boolean | ❌ | 应用内通知 | true |
| pushNotification | boolean | ❌ | 推送通知 | true |
| emailNotification | boolean | ❌ | 邮件通知 | false |
| doNotDisturb | boolean | ❌ | 免打扰模式 | false |
| dndStartTime | string | ❌ | 免打扰开始时间 (HH:mm) | "22:00" |
| dndEndTime | string | ❌ | 免打扰结束时间 (HH:mm) | "08:00" |

**成功响应**:
```json
{
  "success": true,
  "message": "通知设置更新成功",
  "code": "200",
  "timestamp": "2025-01-27T10:30:00.000Z",
  "data": {
    "systemAnnouncement": true,
    "securityAlert": true,
    "mealReminder": true,
    "courtBooking": true,
    "approvalNotification": true,
    "instantMessage": true,
    "groupMessage": true,
    "inAppNotification": true,
    "pushNotification": true,
    "emailNotification": false,
    "doNotDisturb": false,
    "dndStartTime": "22:00",
    "dndEndTime": "08:00",
    "lastUpdated": "2025-01-27T10:30:00.000Z"
  }
}
```

**错误响应**:
```json
{
  "success": false,
  "message": "时间格式不正确",
  "code": "422",
  "timestamp": "2025-01-27T10:30:00.000Z"
}
```

**常见错误码**:
- `400`: 参数格式错误
- `401`: 未授权，Token无效或过期
- `422`: 参数验证失败
- `500`: 服务器内部错误

---

### 3. 重置通知设置

**接口地址**: `POST /api/user/notification-settings/reset`

**接口描述**: 重置用户通知设置为默认配置

**权限要求**: 用户登录认证

**请求头**:
```http
Authorization: Bearer {token}
Content-Type: application/json
```

**请求参数**: 无

**成功响应**:
```json
{
  "success": true,
  "message": "通知设置已重置为默认配置",
  "code": "200",
  "timestamp": "2025-01-27T10:30:00.000Z",
  "data": {
    "systemAnnouncement": true,
    "securityAlert": true,
    "mealReminder": true,
    "courtBooking": true,
    "approvalNotification": true,
    "instantMessage": true,
    "groupMessage": true,
    "inAppNotification": true,
    "pushNotification": true,
    "emailNotification": false,
    "doNotDisturb": false,
    "dndStartTime": "22:00",
    "dndEndTime": "08:00",
    "lastUpdated": "2025-01-27T10:30:00.000Z"
  }
}
```

---

## 📱 前端集成示例

### JavaScript/TypeScript 示例

#### 1. 获取通知设置

```javascript
/**
 * 获取用户通知设置
 * @returns {Promise<Object>} 通知设置数据
 */
async function getNotificationSettings() {
  try {
    const token = localStorage.getItem('token');
    
    const response = await fetch('/api/user/notification-settings', {
      method: 'GET',
      headers: {
        'Authorization': `Bearer ${token}`,
        'Content-Type': 'application/json'
      }
    });
    
    const result = await response.json();
    
    if (result.success) {
      console.log('获取通知设置成功:', result.data);
      return result.data;
    } else {
      console.error('获取通知设置失败:', result.message);
      throw new Error(result.message);
    }
  } catch (error) {
    console.error('获取通知设置请求失败:', error);
    throw error;
  }
}
```

#### 2. 更新通知设置

```javascript
/**
 * 更新用户通知设置
 * @param {Object} settings - 通知设置对象
 * @returns {Promise<Object>} 更新结果
 */
async function updateNotificationSettings(settings) {
  try {
    const token = localStorage.getItem('token');
    
    const response = await fetch('/api/user/notification-settings', {
      method: 'PUT',
      headers: {
        'Authorization': `Bearer ${token}`,
        'Content-Type': 'application/json'
      },
      body: JSON.stringify(settings)
    });
    
    const result = await response.json();
    
    if (result.success) {
      console.log('通知设置更新成功:', result.data);
      return result.data;
    } else {
      console.error('通知设置更新失败:', result.message);
      throw new Error(result.message);
    }
  } catch (error) {
    console.error('更新通知设置请求失败:', error);
    throw error;
  }
}
```

#### 3. 重置通知设置

```javascript
/**
 * 重置用户通知设置为默认配置
 * @returns {Promise<Object>} 重置结果
 */
async function resetNotificationSettings() {
  try {
    const token = localStorage.getItem('token');
    
    const response = await fetch('/api/user/notification-settings/reset', {
      method: 'POST',
      headers: {
        'Authorization': `Bearer ${token}`,
        'Content-Type': 'application/json'
      }
    });
    
    const result = await response.json();
    
    if (result.success) {
      console.log('通知设置重置成功:', result.data);
      return result.data;
    } else {
      console.error('通知设置重置失败:', result.message);
      throw new Error(result.message);
    }
  } catch (error) {
    console.error('重置通知设置请求失败:', error);
    throw error;
  }
}
```

### Vue.js 组件示例

```vue
<template>
  <view class="notification-settings-page">
    <!-- 页面头部 -->
    <view class="page-header">
      <button class="back-btn" @click="goBack">←</button>
      <text class="page-title">通知设置</text>
    </view>

    <!-- 内容区域 -->
    <view class="content-container">
      <!-- 系统通知 -->
      <view class="settings-section">
        <text class="section-title">系统通知</text>
        
        <view class="setting-item">
          <view class="setting-info">
            <text class="setting-label">系统公告</text>
            <text class="setting-desc">接收系统维护、更新等重要通知</text>
          </view>
          <switch 
            :checked="settings.systemAnnouncement" 
            @change="toggleSetting('systemAnnouncement')"
            color="#667eea"
          />
        </view>

        <view class="setting-item">
          <view class="setting-info">
            <text class="setting-label">安全提醒</text>
            <text class="setting-desc">接收登录异常、密码修改等安全提醒</text>
          </view>
          <switch 
            :checked="settings.securityAlert" 
            @change="toggleSetting('securityAlert')"
            color="#667eea"
          />
        </view>
      </view>

      <!-- 业务通知 -->
      <view class="settings-section">
        <text class="section-title">业务通知</text>
        
        <view class="setting-item">
          <view class="setting-info">
            <text class="setting-label">报餐提醒</text>
            <text class="setting-desc">接收报餐截止时间、餐品变更等提醒</text>
          </view>
          <switch 
            :checked="settings.mealReminder" 
            @change="toggleSetting('mealReminder')"
            color="#667eea"
          />
        </view>

        <view class="setting-item">
          <view class="setting-info">
            <text class="setting-label">球馆预约</text>
            <text class="setting-desc">接收预约成功、时间变更等通知</text>
          </view>
          <switch 
            :checked="settings.courtBooking" 
            @change="toggleSetting('courtBooking')"
            color="#667eea"
          />
        </view>

        <view class="setting-item">
          <view class="setting-info">
            <text class="setting-label">审批通知</text>
            <text class="setting-desc">接收请假、报销等审批结果通知</text>
          </view>
          <switch 
            :checked="settings.approvalNotification" 
            @change="toggleSetting('approvalNotification')"
            color="#667eea"
          />
        </view>
      </view>

      <!-- 消息通知 -->
      <view class="settings-section">
        <text class="section-title">消息通知</text>
        
        <view class="setting-item">
          <view class="setting-info">
            <text class="setting-label">即时消息</text>
            <text class="setting-desc">接收同事发送的即时消息</text>
          </view>
          <switch 
            :checked="settings.instantMessage" 
            @change="toggleSetting('instantMessage')"
            color="#667eea"
          />
        </view>

        <view class="setting-item">
          <view class="setting-info">
            <text class="setting-label">群组消息</text>
            <text class="setting-desc">接收群组聊天和公告消息</text>
          </view>
          <switch 
            :checked="settings.groupMessage" 
            @change="toggleSetting('groupMessage')"
            color="#667eea"
          />
        </view>
      </view>

      <!-- 通知方式 -->
      <view class="settings-section">
        <text class="section-title">通知方式</text>
        
        <view class="setting-item">
          <view class="setting-info">
            <text class="setting-label">应用内通知</text>
            <text class="setting-desc">在应用内显示通知横幅</text>
          </view>
          <switch 
            :checked="settings.inAppNotification" 
            @change="toggleSetting('inAppNotification')"
            color="#667eea"
          />
        </view>

        <view class="setting-item">
          <view class="setting-info">
            <text class="setting-label">推送通知</text>
            <text class="setting-desc">接收手机推送通知</text>
          </view>
          <switch 
            :checked="settings.pushNotification" 
            @change="toggleSetting('pushNotification')"
            color="#667eea"
          />
        </view>

        <view class="setting-item">
          <view class="setting-info">
            <text class="setting-label">邮件通知</text>
            <text class="setting-desc">接收重要通知的邮件提醒</text>
          </view>
          <switch 
            :checked="settings.emailNotification" 
            @change="toggleSetting('emailNotification')"
            color="#667eea"
          />
        </view>
      </view>

      <!-- 免打扰时间 -->
      <view class="settings-section">
        <text class="section-title">免打扰时间</text>
        
        <view class="setting-item">
          <view class="setting-info">
            <text class="setting-label">开启免打扰</text>
            <text class="setting-desc">在指定时间段内不接收通知</text>
          </view>
          <switch 
            :checked="settings.doNotDisturb" 
            @change="toggleSetting('doNotDisturb')"
            color="#667eea"
          />
        </view>

        <view v-if="settings.doNotDisturb" class="time-settings">
          <view class="time-item">
            <text class="time-label">开始时间</text>
            <picker 
              mode="time" 
              :value="settings.dndStartTime"
              @change="onStartTimeChange"
            >
              <view class="time-picker">{{ settings.dndStartTime }}</view>
            </picker>
          </view>
          
          <view class="time-item">
            <text class="time-label">结束时间</text>
            <picker 
              mode="time" 
              :value="settings.dndEndTime"
              @change="onEndTimeChange"
            >
              <view class="time-picker">{{ settings.dndEndTime }}</view>
            </picker>
          </view>
        </view>
      </view>

      <!-- 操作按钮 -->
      <view class="action-buttons">
        <button class="reset-btn" @click="resetSettings">重置为默认</button>
        <button class="save-btn" @click="saveSettings" :disabled="saving">
          {{ saving ? '保存中...' : '保存设置' }}
        </button>
      </view>
    </view>
  </view>
</template>

<script>
import api from '@/utils/api'

export default {
  name: 'NotificationSettings',
  data() {
    return {
      saving: false,
      settings: {
        // 系统通知
        systemAnnouncement: true,
        securityAlert: true,
        
        // 业务通知
        mealReminder: true,
        courtBooking: true,
        approvalNotification: true,
        
        // 消息通知
        instantMessage: true,
        groupMessage: true,
        
        // 通知方式
        inAppNotification: true,
        pushNotification: true,
        emailNotification: false,
        
        // 免打扰
        doNotDisturb: false,
        dndStartTime: '22:00',
        dndEndTime: '08:00'
      }
    }
  },
  onLoad() {
    this.loadSettings()
  },
  methods: {
    /**
     * 加载通知设置
     */
    async loadSettings() {
      try {
        const response = await api.user.getNotificationSettings()
        if (response.success) {
          this.settings = { ...this.settings, ...response.data }
        }
      } catch (error) {
        console.error('加载通知设置失败:', error)
        this.showError('加载设置失败，请重试')
      }
    },

    /**
     * 切换设置开关
     */
    toggleSetting(key) {
      this.settings[key] = !this.settings[key]
    },

    /**
     * 开始时间变化
     */
    onStartTimeChange(e) {
      this.settings.dndStartTime = e.detail.value
    },

    /**
     * 结束时间变化
     */
    onEndTimeChange(e) {
      this.settings.dndEndTime = e.detail.value
    },

    /**
     * 保存设置
     */
    async saveSettings() {
      this.saving = true
      try {
        const response = await api.user.updateNotificationSettings(this.settings)
        if (response.success) {
          this.showSuccess('设置保存成功')
        } else {
          this.showError(response.message || '保存失败')
        }
      } catch (error) {
        console.error('保存设置失败:', error)
        this.showError('保存失败，请重试')
      } finally {
        this.saving = false
      }
    },

    /**
     * 重置设置
     */
    async resetSettings() {
      try {
        const response = await api.user.resetNotificationSettings()
        if (response.success) {
          this.settings = { ...this.settings, ...response.data }
          this.showSuccess('设置已重置为默认配置')
        } else {
          this.showError(response.message || '重置失败')
        }
      } catch (error) {
        console.error('重置设置失败:', error)
        this.showError('重置失败，请重试')
      }
    },

    /**
     * 返回上一页
     */
    goBack() {
      uni.navigateBack()
    },

    /**
     * 显示成功提示
     */
    showSuccess(message) {
      uni.showToast({
        title: message,
        icon: 'success'
      })
    },

    /**
     * 显示错误提示
     */
    showError(message) {
      uni.showToast({
        title: message,
        icon: 'error'
      })
    }
  }
}
</script>
```

## 🔧 后端实现示例

### Node.js + Express 实现

```javascript
const express = require('express');
const router = express.Router();

// 通知设置数据模型
const NotificationSettings = {
  systemAnnouncement: { type: Boolean, default: true },
  securityAlert: { type: Boolean, default: true },
  mealReminder: { type: Boolean, default: true },
  courtBooking: { type: Boolean, default: true },
  approvalNotification: { type: Boolean, default: true },
  instantMessage: { type: Boolean, default: true },
  groupMessage: { type: Boolean, default: true },
  inAppNotification: { type: Boolean, default: true },
  pushNotification: { type: Boolean, default: true },
  emailNotification: { type: Boolean, default: false },
  doNotDisturb: { type: Boolean, default: false },
  dndStartTime: { type: String, default: '22:00' },
  dndEndTime: { type: String, default: '08:00' }
};

/**
 * 获取通知设置
 * GET /api/user/notification-settings
 */
router.get('/notification-settings', authenticateToken, async (req, res) => {
  try {
    const userId = req.user.userId;
    
    // 从数据库获取用户通知设置
    const settings = await getUserNotificationSettings(userId);
    
    res.json({
      success: true,
      message: '获取通知设置成功',
      data: settings
    });
  } catch (error) {
    console.error('获取通知设置失败:', error);
    res.status(500).json({
      success: false,
      message: '获取通知设置失败',
      error: error.message
    });
  }
});

/**
 * 更新通知设置
 * PUT /api/user/notification-settings
 */
router.put('/notification-settings', authenticateToken, async (req, res) => {
  try {
    const userId = req.user.userId;
    const settings = req.body;
    
    // 验证时间格式
    if (settings.dndStartTime && !isValidTimeFormat(settings.dndStartTime)) {
      return res.status(422).json({
        success: false,
        message: '开始时间格式不正确，请使用HH:mm格式'
      });
    }
    
    if (settings.dndEndTime && !isValidTimeFormat(settings.dndEndTime)) {
      return res.status(422).json({
        success: false,
        message: '结束时间格式不正确，请使用HH:mm格式'
      });
    }
    
    // 更新用户通知设置
    const updatedSettings = await updateUserNotificationSettings(userId, settings);
    
    res.json({
      success: true,
      message: '通知设置更新成功',
      data: updatedSettings
    });
  } catch (error) {
    console.error('更新通知设置失败:', error);
    res.status(500).json({
      success: false,
      message: '更新通知设置失败',
      error: error.message
    });
  }
});

/**
 * 重置通知设置
 * POST /api/user/notification-settings/reset
 */
router.post('/notification-settings/reset', authenticateToken, async (req, res) => {
  try {
    const userId = req.user.userId;
    
    // 重置为默认设置
    const defaultSettings = getDefaultNotificationSettings();
    const resetSettings = await updateUserNotificationSettings(userId, defaultSettings);
    
    res.json({
      success: true,
      message: '通知设置已重置为默认配置',
      data: resetSettings
    });
  } catch (error) {
    console.error('重置通知设置失败:', error);
    res.status(500).json({
      success: false,
      message: '重置通知设置失败',
      error: error.message
    });
  }
});

// 辅助函数
function isValidTimeFormat(time) {
  const timeRegex = /^([01]?[0-9]|2[0-3]):[0-5][0-9]$/;
  return timeRegex.test(time);
}

function getDefaultNotificationSettings() {
  return {
    systemAnnouncement: true,
    securityAlert: true,
    mealReminder: true,
    courtBooking: true,
    approvalNotification: true,
    instantMessage: true,
    groupMessage: true,
    inAppNotification: true,
    pushNotification: true,
    emailNotification: false,
    doNotDisturb: false,
    dndStartTime: '22:00',
    dndEndTime: '08:00'
  };
}

async function getUserNotificationSettings(userId) {
  // 从数据库获取用户通知设置
  // 如果不存在，返回默认设置
  const settings = await db.notificationSettings.findOne({ userId });
  return settings || getDefaultNotificationSettings();
}

async function updateUserNotificationSettings(userId, settings) {
  // 更新或创建用户通知设置
  const updatedSettings = await db.notificationSettings.findOneAndUpdate(
    { userId },
    { 
      ...settings,
      lastUpdated: new Date()
    },
    { upsert: true, new: true }
  );
  return updatedSettings;
}

module.exports = router;
```

## 📊 数据库设计

### 通知设置表 (notification_settings)

```sql
CREATE TABLE notification_settings (
  id VARCHAR(36) PRIMARY KEY,
  user_id VARCHAR(36) NOT NULL,
  system_announcement BOOLEAN DEFAULT TRUE,
  security_alert BOOLEAN DEFAULT TRUE,
  meal_reminder BOOLEAN DEFAULT TRUE,
  court_booking BOOLEAN DEFAULT TRUE,
  approval_notification BOOLEAN DEFAULT TRUE,
  instant_message BOOLEAN DEFAULT TRUE,
  group_message BOOLEAN DEFAULT TRUE,
  in_app_notification BOOLEAN DEFAULT TRUE,
  push_notification BOOLEAN DEFAULT TRUE,
  email_notification BOOLEAN DEFAULT FALSE,
  do_not_disturb BOOLEAN DEFAULT FALSE,
  dnd_start_time VARCHAR(5) DEFAULT '22:00',
  dnd_end_time VARCHAR(5) DEFAULT '08:00',
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  UNIQUE KEY unique_user_settings (user_id)
);
```

## 🎯 业务逻辑说明

### 1. 通知类型分类

- **系统通知**: 系统维护、更新等重要通知
- **业务通知**: 报餐、预约、审批等业务相关通知
- **消息通知**: 即时消息、群组消息等社交通知

### 2. 通知方式

- **应用内通知**: 在应用内显示通知横幅
- **推送通知**: 手机系统推送通知
- **邮件通知**: 重要通知的邮件提醒

### 3. 免打扰机制

- 在指定时间段内不接收任何通知
- 支持自定义开始和结束时间
- 时间格式为 HH:mm (24小时制)

### 4. 设置优先级

1. 免打扰时间 > 通知类型设置
2. 通知方式设置 > 通知类型设置
3. 用户个人设置 > 系统默认设置

## 📝 测试用例

### 1. 获取通知设置测试

```javascript
// 测试用例1：正常获取设置
await getNotificationSettings();
// 预期：返回用户当前通知设置

// 测试用例2：用户不存在
// 使用不存在的用户ID
// 预期：返回404错误

// 测试用例3：Token无效
// 使用无效或过期的Token
// 预期：返回401错误
```

### 2. 更新通知设置测试

```javascript
// 测试用例1：正常更新设置
await updateNotificationSettings({
  systemAnnouncement: false,
  emailNotification: true
});
// 预期：更新成功

// 测试用例2：时间格式错误
await updateNotificationSettings({
  dndStartTime: '25:00'
});
// 预期：返回422错误

// 测试用例3：部分更新
await updateNotificationSettings({
  mealReminder: false
});
// 预期：只更新指定字段
```

### 3. 重置通知设置测试

```javascript
// 测试用例1：正常重置
await resetNotificationSettings();
// 预期：重置为默认配置

// 测试用例2：重置后验证
const settings = await getNotificationSettings();
// 预期：所有设置都为默认值
```

## 🔒 安全考虑

### 1. 权限控制
- 用户只能修改自己的通知设置
- 管理员可以查看所有用户的通知设置

### 2. 数据验证
- 验证时间格式的正确性
- 验证布尔值类型的正确性
- 防止SQL注入攻击

### 3. 日志记录
- 记录通知设置的修改操作
- 记录敏感操作的审计日志

## 📞 技术支持

如果在对接过程中遇到问题，请检查：

1. **Token有效性**: 确保JWT Token未过期且有效
2. **参数格式**: 确保请求参数格式正确
3. **时间格式**: 确保时间格式为HH:mm
4. **网络连接**: 确保网络连接正常
5. **服务器状态**: 确保后端服务正常运行

---

**文档版本**: v1.0  
**最后更新**: 2025-01-27  
**维护人员**: 后端开发团队
