# é€šçŸ¥è®¾ç½®æ¥å£æ–‡æ¡£

## ğŸ“‹ æ¥å£æ¦‚è¿°

é€šçŸ¥è®¾ç½®æ¥å£æä¾›ç”¨æˆ·é€šçŸ¥åå¥½çš„è·å–ã€æ›´æ–°å’Œç®¡ç†åŠŸèƒ½ï¼ŒåŒ…æ‹¬ç³»ç»Ÿé€šçŸ¥ã€ä¸šåŠ¡é€šçŸ¥ã€æ¶ˆæ¯é€šçŸ¥ã€é€šçŸ¥æ–¹å¼ä»¥åŠå…æ‰“æ‰°æ—¶é—´ç­‰è®¾ç½®ã€‚

**åŸºç¡€è·¯å¾„**: `/api/user`

**è®¤è¯è¦æ±‚**: æ‰€æœ‰æ¥å£éƒ½éœ€è¦æœ‰æ•ˆçš„JWT Token

## ğŸ” æ¥å£åˆ—è¡¨

### 1. è·å–é€šçŸ¥è®¾ç½®

**æ¥å£åœ°å€**: `GET /api/user/notification-settings`

**æ¥å£æè¿°**: è·å–å½“å‰ç”¨æˆ·çš„é€šçŸ¥è®¾ç½®é…ç½®

**æƒé™è¦æ±‚**: ç”¨æˆ·ç™»å½•è®¤è¯

**è¯·æ±‚å¤´**:
```http
Authorization: Bearer {token}
Content-Type: application/json
```

**è¯·æ±‚å‚æ•°**: æ— 

**æˆåŠŸå“åº”**:
```json
{
  "success": true,
  "message": "è·å–é€šçŸ¥è®¾ç½®æˆåŠŸ",
  "code": "200",
  "timestamp": "2025-01-27T10:30:00.000Z",
  "data": {
    "systemAnnouncement": true,
    "securityAlert": true,
    "mealReminder": true,
    "courtBooking": true,
    "approvalNotification": true,
    "instantMessage": true,
    "groupMessage": true,
    "inAppNotification": true,
    "pushNotification": true,
    "emailNotification": false,
    "doNotDisturb": false,
    "dndStartTime": "22:00",
    "dndEndTime": "08:00",
    "lastUpdated": "2025-01-27T10:30:00.000Z"
  }
}
```

**é”™è¯¯å“åº”**:
```json
{
  "success": false,
  "message": "è·å–é€šçŸ¥è®¾ç½®å¤±è´¥",
  "code": "500",
  "timestamp": "2025-01-27T10:30:00.000Z"
}
```

**å¸¸è§é”™è¯¯ç **:
- `401`: æœªæˆæƒï¼ŒTokenæ— æ•ˆæˆ–è¿‡æœŸ
- `404`: ç”¨æˆ·ä¸å­˜åœ¨
- `500`: æœåŠ¡å™¨å†…éƒ¨é”™è¯¯

---

### 2. æ›´æ–°é€šçŸ¥è®¾ç½®

**æ¥å£åœ°å€**: `PUT /api/user/notification-settings`

**æ¥å£æè¿°**: æ›´æ–°ç”¨æˆ·çš„é€šçŸ¥è®¾ç½®é…ç½®

**æƒé™è¦æ±‚**: ç”¨æˆ·ç™»å½•è®¤è¯

**è¯·æ±‚å¤´**:
```http
Authorization: Bearer {token}
Content-Type: application/json
```

**è¯·æ±‚å‚æ•°**:
```json
{
  "systemAnnouncement": true,
  "securityAlert": true,
  "mealReminder": true,
  "courtBooking": true,
  "approvalNotification": true,
  "instantMessage": true,
  "groupMessage": true,
  "inAppNotification": true,
  "pushNotification": true,
  "emailNotification": false,
  "doNotDisturb": false,
  "dndStartTime": "22:00",
  "dndEndTime": "08:00"
}
```

**å‚æ•°è¯´æ˜**:
| å‚æ•°å | ç±»å‹ | å¿…å¡« | è¯´æ˜ | é»˜è®¤å€¼ |
|--------|------|------|------|--------|
| systemAnnouncement | boolean | âŒ | ç³»ç»Ÿå…¬å‘Šé€šçŸ¥ | true |
| securityAlert | boolean | âŒ | å®‰å…¨æé†’é€šçŸ¥ | true |
| mealReminder | boolean | âŒ | æŠ¥é¤æé†’é€šçŸ¥ | true |
| courtBooking | boolean | âŒ | çƒé¦†é¢„çº¦é€šçŸ¥ | true |
| approvalNotification | boolean | âŒ | å®¡æ‰¹é€šçŸ¥ | true |
| instantMessage | boolean | âŒ | å³æ—¶æ¶ˆæ¯é€šçŸ¥ | true |
| groupMessage | boolean | âŒ | ç¾¤ç»„æ¶ˆæ¯é€šçŸ¥ | true |
| inAppNotification | boolean | âŒ | åº”ç”¨å†…é€šçŸ¥ | true |
| pushNotification | boolean | âŒ | æ¨é€é€šçŸ¥ | true |
| emailNotification | boolean | âŒ | é‚®ä»¶é€šçŸ¥ | false |
| doNotDisturb | boolean | âŒ | å…æ‰“æ‰°æ¨¡å¼ | false |
| dndStartTime | string | âŒ | å…æ‰“æ‰°å¼€å§‹æ—¶é—´ (HH:mm) | "22:00" |
| dndEndTime | string | âŒ | å…æ‰“æ‰°ç»“æŸæ—¶é—´ (HH:mm) | "08:00" |

**æˆåŠŸå“åº”**:
```json
{
  "success": true,
  "message": "é€šçŸ¥è®¾ç½®æ›´æ–°æˆåŠŸ",
  "code": "200",
  "timestamp": "2025-01-27T10:30:00.000Z",
  "data": {
    "systemAnnouncement": true,
    "securityAlert": true,
    "mealReminder": true,
    "courtBooking": true,
    "approvalNotification": true,
    "instantMessage": true,
    "groupMessage": true,
    "inAppNotification": true,
    "pushNotification": true,
    "emailNotification": false,
    "doNotDisturb": false,
    "dndStartTime": "22:00",
    "dndEndTime": "08:00",
    "lastUpdated": "2025-01-27T10:30:00.000Z"
  }
}
```

**é”™è¯¯å“åº”**:
```json
{
  "success": false,
  "message": "æ—¶é—´æ ¼å¼ä¸æ­£ç¡®",
  "code": "422",
  "timestamp": "2025-01-27T10:30:00.000Z"
}
```

**å¸¸è§é”™è¯¯ç **:
- `400`: å‚æ•°æ ¼å¼é”™è¯¯
- `401`: æœªæˆæƒï¼ŒTokenæ— æ•ˆæˆ–è¿‡æœŸ
- `422`: å‚æ•°éªŒè¯å¤±è´¥
- `500`: æœåŠ¡å™¨å†…éƒ¨é”™è¯¯

---

### 3. é‡ç½®é€šçŸ¥è®¾ç½®

**æ¥å£åœ°å€**: `POST /api/user/notification-settings/reset`

**æ¥å£æè¿°**: é‡ç½®ç”¨æˆ·é€šçŸ¥è®¾ç½®ä¸ºé»˜è®¤é…ç½®

**æƒé™è¦æ±‚**: ç”¨æˆ·ç™»å½•è®¤è¯

**è¯·æ±‚å¤´**:
```http
Authorization: Bearer {token}
Content-Type: application/json
```

**è¯·æ±‚å‚æ•°**: æ— 

**æˆåŠŸå“åº”**:
```json
{
  "success": true,
  "message": "é€šçŸ¥è®¾ç½®å·²é‡ç½®ä¸ºé»˜è®¤é…ç½®",
  "code": "200",
  "timestamp": "2025-01-27T10:30:00.000Z",
  "data": {
    "systemAnnouncement": true,
    "securityAlert": true,
    "mealReminder": true,
    "courtBooking": true,
    "approvalNotification": true,
    "instantMessage": true,
    "groupMessage": true,
    "inAppNotification": true,
    "pushNotification": true,
    "emailNotification": false,
    "doNotDisturb": false,
    "dndStartTime": "22:00",
    "dndEndTime": "08:00",
    "lastUpdated": "2025-01-27T10:30:00.000Z"
  }
}
```

---

## ğŸ“± å‰ç«¯é›†æˆç¤ºä¾‹

### JavaScript/TypeScript ç¤ºä¾‹

#### 1. è·å–é€šçŸ¥è®¾ç½®

```javascript
/**
 * è·å–ç”¨æˆ·é€šçŸ¥è®¾ç½®
 * @returns {Promise<Object>} é€šçŸ¥è®¾ç½®æ•°æ®
 */
async function getNotificationSettings() {
  try {
    const token = localStorage.getItem('token');
    
    const response = await fetch('/api/user/notification-settings', {
      method: 'GET',
      headers: {
        'Authorization': `Bearer ${token}`,
        'Content-Type': 'application/json'
      }
    });
    
    const result = await response.json();
    
    if (result.success) {
      console.log('è·å–é€šçŸ¥è®¾ç½®æˆåŠŸ:', result.data);
      return result.data;
    } else {
      console.error('è·å–é€šçŸ¥è®¾ç½®å¤±è´¥:', result.message);
      throw new Error(result.message);
    }
  } catch (error) {
    console.error('è·å–é€šçŸ¥è®¾ç½®è¯·æ±‚å¤±è´¥:', error);
    throw error;
  }
}
```

#### 2. æ›´æ–°é€šçŸ¥è®¾ç½®

```javascript
/**
 * æ›´æ–°ç”¨æˆ·é€šçŸ¥è®¾ç½®
 * @param {Object} settings - é€šçŸ¥è®¾ç½®å¯¹è±¡
 * @returns {Promise<Object>} æ›´æ–°ç»“æœ
 */
async function updateNotificationSettings(settings) {
  try {
    const token = localStorage.getItem('token');
    
    const response = await fetch('/api/user/notification-settings', {
      method: 'PUT',
      headers: {
        'Authorization': `Bearer ${token}`,
        'Content-Type': 'application/json'
      },
      body: JSON.stringify(settings)
    });
    
    const result = await response.json();
    
    if (result.success) {
      console.log('é€šçŸ¥è®¾ç½®æ›´æ–°æˆåŠŸ:', result.data);
      return result.data;
    } else {
      console.error('é€šçŸ¥è®¾ç½®æ›´æ–°å¤±è´¥:', result.message);
      throw new Error(result.message);
    }
  } catch (error) {
    console.error('æ›´æ–°é€šçŸ¥è®¾ç½®è¯·æ±‚å¤±è´¥:', error);
    throw error;
  }
}
```

#### 3. é‡ç½®é€šçŸ¥è®¾ç½®

```javascript
/**
 * é‡ç½®ç”¨æˆ·é€šçŸ¥è®¾ç½®ä¸ºé»˜è®¤é…ç½®
 * @returns {Promise<Object>} é‡ç½®ç»“æœ
 */
async function resetNotificationSettings() {
  try {
    const token = localStorage.getItem('token');
    
    const response = await fetch('/api/user/notification-settings/reset', {
      method: 'POST',
      headers: {
        'Authorization': `Bearer ${token}`,
        'Content-Type': 'application/json'
      }
    });
    
    const result = await response.json();
    
    if (result.success) {
      console.log('é€šçŸ¥è®¾ç½®é‡ç½®æˆåŠŸ:', result.data);
      return result.data;
    } else {
      console.error('é€šçŸ¥è®¾ç½®é‡ç½®å¤±è´¥:', result.message);
      throw new Error(result.message);
    }
  } catch (error) {
    console.error('é‡ç½®é€šçŸ¥è®¾ç½®è¯·æ±‚å¤±è´¥:', error);
    throw error;
  }
}
```

### Vue.js ç»„ä»¶ç¤ºä¾‹

```vue
<template>
  <view class="notification-settings-page">
    <!-- é¡µé¢å¤´éƒ¨ -->
    <view class="page-header">
      <button class="back-btn" @click="goBack">â†</button>
      <text class="page-title">é€šçŸ¥è®¾ç½®</text>
    </view>

    <!-- å†…å®¹åŒºåŸŸ -->
    <view class="content-container">
      <!-- ç³»ç»Ÿé€šçŸ¥ -->
      <view class="settings-section">
        <text class="section-title">ç³»ç»Ÿé€šçŸ¥</text>
        
        <view class="setting-item">
          <view class="setting-info">
            <text class="setting-label">ç³»ç»Ÿå…¬å‘Š</text>
            <text class="setting-desc">æ¥æ”¶ç³»ç»Ÿç»´æŠ¤ã€æ›´æ–°ç­‰é‡è¦é€šçŸ¥</text>
          </view>
          <switch 
            :checked="settings.systemAnnouncement" 
            @change="toggleSetting('systemAnnouncement')"
            color="#667eea"
          />
        </view>

        <view class="setting-item">
          <view class="setting-info">
            <text class="setting-label">å®‰å…¨æé†’</text>
            <text class="setting-desc">æ¥æ”¶ç™»å½•å¼‚å¸¸ã€å¯†ç ä¿®æ”¹ç­‰å®‰å…¨æé†’</text>
          </view>
          <switch 
            :checked="settings.securityAlert" 
            @change="toggleSetting('securityAlert')"
            color="#667eea"
          />
        </view>
      </view>

      <!-- ä¸šåŠ¡é€šçŸ¥ -->
      <view class="settings-section">
        <text class="section-title">ä¸šåŠ¡é€šçŸ¥</text>
        
        <view class="setting-item">
          <view class="setting-info">
            <text class="setting-label">æŠ¥é¤æé†’</text>
            <text class="setting-desc">æ¥æ”¶æŠ¥é¤æˆªæ­¢æ—¶é—´ã€é¤å“å˜æ›´ç­‰æé†’</text>
          </view>
          <switch 
            :checked="settings.mealReminder" 
            @change="toggleSetting('mealReminder')"
            color="#667eea"
          />
        </view>

        <view class="setting-item">
          <view class="setting-info">
            <text class="setting-label">çƒé¦†é¢„çº¦</text>
            <text class="setting-desc">æ¥æ”¶é¢„çº¦æˆåŠŸã€æ—¶é—´å˜æ›´ç­‰é€šçŸ¥</text>
          </view>
          <switch 
            :checked="settings.courtBooking" 
            @change="toggleSetting('courtBooking')"
            color="#667eea"
          />
        </view>

        <view class="setting-item">
          <view class="setting-info">
            <text class="setting-label">å®¡æ‰¹é€šçŸ¥</text>
            <text class="setting-desc">æ¥æ”¶è¯·å‡ã€æŠ¥é”€ç­‰å®¡æ‰¹ç»“æœé€šçŸ¥</text>
          </view>
          <switch 
            :checked="settings.approvalNotification" 
            @change="toggleSetting('approvalNotification')"
            color="#667eea"
          />
        </view>
      </view>

      <!-- æ¶ˆæ¯é€šçŸ¥ -->
      <view class="settings-section">
        <text class="section-title">æ¶ˆæ¯é€šçŸ¥</text>
        
        <view class="setting-item">
          <view class="setting-info">
            <text class="setting-label">å³æ—¶æ¶ˆæ¯</text>
            <text class="setting-desc">æ¥æ”¶åŒäº‹å‘é€çš„å³æ—¶æ¶ˆæ¯</text>
          </view>
          <switch 
            :checked="settings.instantMessage" 
            @change="toggleSetting('instantMessage')"
            color="#667eea"
          />
        </view>

        <view class="setting-item">
          <view class="setting-info">
            <text class="setting-label">ç¾¤ç»„æ¶ˆæ¯</text>
            <text class="setting-desc">æ¥æ”¶ç¾¤ç»„èŠå¤©å’Œå…¬å‘Šæ¶ˆæ¯</text>
          </view>
          <switch 
            :checked="settings.groupMessage" 
            @change="toggleSetting('groupMessage')"
            color="#667eea"
          />
        </view>
      </view>

      <!-- é€šçŸ¥æ–¹å¼ -->
      <view class="settings-section">
        <text class="section-title">é€šçŸ¥æ–¹å¼</text>
        
        <view class="setting-item">
          <view class="setting-info">
            <text class="setting-label">åº”ç”¨å†…é€šçŸ¥</text>
            <text class="setting-desc">åœ¨åº”ç”¨å†…æ˜¾ç¤ºé€šçŸ¥æ¨ªå¹…</text>
          </view>
          <switch 
            :checked="settings.inAppNotification" 
            @change="toggleSetting('inAppNotification')"
            color="#667eea"
          />
        </view>

        <view class="setting-item">
          <view class="setting-info">
            <text class="setting-label">æ¨é€é€šçŸ¥</text>
            <text class="setting-desc">æ¥æ”¶æ‰‹æœºæ¨é€é€šçŸ¥</text>
          </view>
          <switch 
            :checked="settings.pushNotification" 
            @change="toggleSetting('pushNotification')"
            color="#667eea"
          />
        </view>

        <view class="setting-item">
          <view class="setting-info">
            <text class="setting-label">é‚®ä»¶é€šçŸ¥</text>
            <text class="setting-desc">æ¥æ”¶é‡è¦é€šçŸ¥çš„é‚®ä»¶æé†’</text>
          </view>
          <switch 
            :checked="settings.emailNotification" 
            @change="toggleSetting('emailNotification')"
            color="#667eea"
          />
        </view>
      </view>

      <!-- å…æ‰“æ‰°æ—¶é—´ -->
      <view class="settings-section">
        <text class="section-title">å…æ‰“æ‰°æ—¶é—´</text>
        
        <view class="setting-item">
          <view class="setting-info">
            <text class="setting-label">å¼€å¯å…æ‰“æ‰°</text>
            <text class="setting-desc">åœ¨æŒ‡å®šæ—¶é—´æ®µå†…ä¸æ¥æ”¶é€šçŸ¥</text>
          </view>
          <switch 
            :checked="settings.doNotDisturb" 
            @change="toggleSetting('doNotDisturb')"
            color="#667eea"
          />
        </view>

        <view v-if="settings.doNotDisturb" class="time-settings">
          <view class="time-item">
            <text class="time-label">å¼€å§‹æ—¶é—´</text>
            <picker 
              mode="time" 
              :value="settings.dndStartTime"
              @change="onStartTimeChange"
            >
              <view class="time-picker">{{ settings.dndStartTime }}</view>
            </picker>
          </view>
          
          <view class="time-item">
            <text class="time-label">ç»“æŸæ—¶é—´</text>
            <picker 
              mode="time" 
              :value="settings.dndEndTime"
              @change="onEndTimeChange"
            >
              <view class="time-picker">{{ settings.dndEndTime }}</view>
            </picker>
          </view>
        </view>
      </view>

      <!-- æ“ä½œæŒ‰é’® -->
      <view class="action-buttons">
        <button class="reset-btn" @click="resetSettings">é‡ç½®ä¸ºé»˜è®¤</button>
        <button class="save-btn" @click="saveSettings" :disabled="saving">
          {{ saving ? 'ä¿å­˜ä¸­...' : 'ä¿å­˜è®¾ç½®' }}
        </button>
      </view>
    </view>
  </view>
</template>

<script>
import api from '@/utils/api'

export default {
  name: 'NotificationSettings',
  data() {
    return {
      saving: false,
      settings: {
        // ç³»ç»Ÿé€šçŸ¥
        systemAnnouncement: true,
        securityAlert: true,
        
        // ä¸šåŠ¡é€šçŸ¥
        mealReminder: true,
        courtBooking: true,
        approvalNotification: true,
        
        // æ¶ˆæ¯é€šçŸ¥
        instantMessage: true,
        groupMessage: true,
        
        // é€šçŸ¥æ–¹å¼
        inAppNotification: true,
        pushNotification: true,
        emailNotification: false,
        
        // å…æ‰“æ‰°
        doNotDisturb: false,
        dndStartTime: '22:00',
        dndEndTime: '08:00'
      }
    }
  },
  onLoad() {
    this.loadSettings()
  },
  methods: {
    /**
     * åŠ è½½é€šçŸ¥è®¾ç½®
     */
    async loadSettings() {
      try {
        const response = await api.user.getNotificationSettings()
        if (response.success) {
          this.settings = { ...this.settings, ...response.data }
        }
      } catch (error) {
        console.error('åŠ è½½é€šçŸ¥è®¾ç½®å¤±è´¥:', error)
        this.showError('åŠ è½½è®¾ç½®å¤±è´¥ï¼Œè¯·é‡è¯•')
      }
    },

    /**
     * åˆ‡æ¢è®¾ç½®å¼€å…³
     */
    toggleSetting(key) {
      this.settings[key] = !this.settings[key]
    },

    /**
     * å¼€å§‹æ—¶é—´å˜åŒ–
     */
    onStartTimeChange(e) {
      this.settings.dndStartTime = e.detail.value
    },

    /**
     * ç»“æŸæ—¶é—´å˜åŒ–
     */
    onEndTimeChange(e) {
      this.settings.dndEndTime = e.detail.value
    },

    /**
     * ä¿å­˜è®¾ç½®
     */
    async saveSettings() {
      this.saving = true
      try {
        const response = await api.user.updateNotificationSettings(this.settings)
        if (response.success) {
          this.showSuccess('è®¾ç½®ä¿å­˜æˆåŠŸ')
        } else {
          this.showError(response.message || 'ä¿å­˜å¤±è´¥')
        }
      } catch (error) {
        console.error('ä¿å­˜è®¾ç½®å¤±è´¥:', error)
        this.showError('ä¿å­˜å¤±è´¥ï¼Œè¯·é‡è¯•')
      } finally {
        this.saving = false
      }
    },

    /**
     * é‡ç½®è®¾ç½®
     */
    async resetSettings() {
      try {
        const response = await api.user.resetNotificationSettings()
        if (response.success) {
          this.settings = { ...this.settings, ...response.data }
          this.showSuccess('è®¾ç½®å·²é‡ç½®ä¸ºé»˜è®¤é…ç½®')
        } else {
          this.showError(response.message || 'é‡ç½®å¤±è´¥')
        }
      } catch (error) {
        console.error('é‡ç½®è®¾ç½®å¤±è´¥:', error)
        this.showError('é‡ç½®å¤±è´¥ï¼Œè¯·é‡è¯•')
      }
    },

    /**
     * è¿”å›ä¸Šä¸€é¡µ
     */
    goBack() {
      uni.navigateBack()
    },

    /**
     * æ˜¾ç¤ºæˆåŠŸæç¤º
     */
    showSuccess(message) {
      uni.showToast({
        title: message,
        icon: 'success'
      })
    },

    /**
     * æ˜¾ç¤ºé”™è¯¯æç¤º
     */
    showError(message) {
      uni.showToast({
        title: message,
        icon: 'error'
      })
    }
  }
}
</script>
```

## ğŸ”§ åç«¯å®ç°ç¤ºä¾‹

### Node.js + Express å®ç°

```javascript
const express = require('express');
const router = express.Router();

// é€šçŸ¥è®¾ç½®æ•°æ®æ¨¡å‹
const NotificationSettings = {
  systemAnnouncement: { type: Boolean, default: true },
  securityAlert: { type: Boolean, default: true },
  mealReminder: { type: Boolean, default: true },
  courtBooking: { type: Boolean, default: true },
  approvalNotification: { type: Boolean, default: true },
  instantMessage: { type: Boolean, default: true },
  groupMessage: { type: Boolean, default: true },
  inAppNotification: { type: Boolean, default: true },
  pushNotification: { type: Boolean, default: true },
  emailNotification: { type: Boolean, default: false },
  doNotDisturb: { type: Boolean, default: false },
  dndStartTime: { type: String, default: '22:00' },
  dndEndTime: { type: String, default: '08:00' }
};

/**
 * è·å–é€šçŸ¥è®¾ç½®
 * GET /api/user/notification-settings
 */
router.get('/notification-settings', authenticateToken, async (req, res) => {
  try {
    const userId = req.user.userId;
    
    // ä»æ•°æ®åº“è·å–ç”¨æˆ·é€šçŸ¥è®¾ç½®
    const settings = await getUserNotificationSettings(userId);
    
    res.json({
      success: true,
      message: 'è·å–é€šçŸ¥è®¾ç½®æˆåŠŸ',
      data: settings
    });
  } catch (error) {
    console.error('è·å–é€šçŸ¥è®¾ç½®å¤±è´¥:', error);
    res.status(500).json({
      success: false,
      message: 'è·å–é€šçŸ¥è®¾ç½®å¤±è´¥',
      error: error.message
    });
  }
});

/**
 * æ›´æ–°é€šçŸ¥è®¾ç½®
 * PUT /api/user/notification-settings
 */
router.put('/notification-settings', authenticateToken, async (req, res) => {
  try {
    const userId = req.user.userId;
    const settings = req.body;
    
    // éªŒè¯æ—¶é—´æ ¼å¼
    if (settings.dndStartTime && !isValidTimeFormat(settings.dndStartTime)) {
      return res.status(422).json({
        success: false,
        message: 'å¼€å§‹æ—¶é—´æ ¼å¼ä¸æ­£ç¡®ï¼Œè¯·ä½¿ç”¨HH:mmæ ¼å¼'
      });
    }
    
    if (settings.dndEndTime && !isValidTimeFormat(settings.dndEndTime)) {
      return res.status(422).json({
        success: false,
        message: 'ç»“æŸæ—¶é—´æ ¼å¼ä¸æ­£ç¡®ï¼Œè¯·ä½¿ç”¨HH:mmæ ¼å¼'
      });
    }
    
    // æ›´æ–°ç”¨æˆ·é€šçŸ¥è®¾ç½®
    const updatedSettings = await updateUserNotificationSettings(userId, settings);
    
    res.json({
      success: true,
      message: 'é€šçŸ¥è®¾ç½®æ›´æ–°æˆåŠŸ',
      data: updatedSettings
    });
  } catch (error) {
    console.error('æ›´æ–°é€šçŸ¥è®¾ç½®å¤±è´¥:', error);
    res.status(500).json({
      success: false,
      message: 'æ›´æ–°é€šçŸ¥è®¾ç½®å¤±è´¥',
      error: error.message
    });
  }
});

/**
 * é‡ç½®é€šçŸ¥è®¾ç½®
 * POST /api/user/notification-settings/reset
 */
router.post('/notification-settings/reset', authenticateToken, async (req, res) => {
  try {
    const userId = req.user.userId;
    
    // é‡ç½®ä¸ºé»˜è®¤è®¾ç½®
    const defaultSettings = getDefaultNotificationSettings();
    const resetSettings = await updateUserNotificationSettings(userId, defaultSettings);
    
    res.json({
      success: true,
      message: 'é€šçŸ¥è®¾ç½®å·²é‡ç½®ä¸ºé»˜è®¤é…ç½®',
      data: resetSettings
    });
  } catch (error) {
    console.error('é‡ç½®é€šçŸ¥è®¾ç½®å¤±è´¥:', error);
    res.status(500).json({
      success: false,
      message: 'é‡ç½®é€šçŸ¥è®¾ç½®å¤±è´¥',
      error: error.message
    });
  }
});

// è¾…åŠ©å‡½æ•°
function isValidTimeFormat(time) {
  const timeRegex = /^([01]?[0-9]|2[0-3]):[0-5][0-9]$/;
  return timeRegex.test(time);
}

function getDefaultNotificationSettings() {
  return {
    systemAnnouncement: true,
    securityAlert: true,
    mealReminder: true,
    courtBooking: true,
    approvalNotification: true,
    instantMessage: true,
    groupMessage: true,
    inAppNotification: true,
    pushNotification: true,
    emailNotification: false,
    doNotDisturb: false,
    dndStartTime: '22:00',
    dndEndTime: '08:00'
  };
}

async function getUserNotificationSettings(userId) {
  // ä»æ•°æ®åº“è·å–ç”¨æˆ·é€šçŸ¥è®¾ç½®
  // å¦‚æœä¸å­˜åœ¨ï¼Œè¿”å›é»˜è®¤è®¾ç½®
  const settings = await db.notificationSettings.findOne({ userId });
  return settings || getDefaultNotificationSettings();
}

async function updateUserNotificationSettings(userId, settings) {
  // æ›´æ–°æˆ–åˆ›å»ºç”¨æˆ·é€šçŸ¥è®¾ç½®
  const updatedSettings = await db.notificationSettings.findOneAndUpdate(
    { userId },
    { 
      ...settings,
      lastUpdated: new Date()
    },
    { upsert: true, new: true }
  );
  return updatedSettings;
}

module.exports = router;
```

## ğŸ“Š æ•°æ®åº“è®¾è®¡

### é€šçŸ¥è®¾ç½®è¡¨ (notification_settings)

```sql
CREATE TABLE notification_settings (
  id VARCHAR(36) PRIMARY KEY,
  user_id VARCHAR(36) NOT NULL,
  system_announcement BOOLEAN DEFAULT TRUE,
  security_alert BOOLEAN DEFAULT TRUE,
  meal_reminder BOOLEAN DEFAULT TRUE,
  court_booking BOOLEAN DEFAULT TRUE,
  approval_notification BOOLEAN DEFAULT TRUE,
  instant_message BOOLEAN DEFAULT TRUE,
  group_message BOOLEAN DEFAULT TRUE,
  in_app_notification BOOLEAN DEFAULT TRUE,
  push_notification BOOLEAN DEFAULT TRUE,
  email_notification BOOLEAN DEFAULT FALSE,
  do_not_disturb BOOLEAN DEFAULT FALSE,
  dnd_start_time VARCHAR(5) DEFAULT '22:00',
  dnd_end_time VARCHAR(5) DEFAULT '08:00',
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  UNIQUE KEY unique_user_settings (user_id)
);
```

## ğŸ¯ ä¸šåŠ¡é€»è¾‘è¯´æ˜

### 1. é€šçŸ¥ç±»å‹åˆ†ç±»

- **ç³»ç»Ÿé€šçŸ¥**: ç³»ç»Ÿç»´æŠ¤ã€æ›´æ–°ç­‰é‡è¦é€šçŸ¥
- **ä¸šåŠ¡é€šçŸ¥**: æŠ¥é¤ã€é¢„çº¦ã€å®¡æ‰¹ç­‰ä¸šåŠ¡ç›¸å…³é€šçŸ¥
- **æ¶ˆæ¯é€šçŸ¥**: å³æ—¶æ¶ˆæ¯ã€ç¾¤ç»„æ¶ˆæ¯ç­‰ç¤¾äº¤é€šçŸ¥

### 2. é€šçŸ¥æ–¹å¼

- **åº”ç”¨å†…é€šçŸ¥**: åœ¨åº”ç”¨å†…æ˜¾ç¤ºé€šçŸ¥æ¨ªå¹…
- **æ¨é€é€šçŸ¥**: æ‰‹æœºç³»ç»Ÿæ¨é€é€šçŸ¥
- **é‚®ä»¶é€šçŸ¥**: é‡è¦é€šçŸ¥çš„é‚®ä»¶æé†’

### 3. å…æ‰“æ‰°æœºåˆ¶

- åœ¨æŒ‡å®šæ—¶é—´æ®µå†…ä¸æ¥æ”¶ä»»ä½•é€šçŸ¥
- æ”¯æŒè‡ªå®šä¹‰å¼€å§‹å’Œç»“æŸæ—¶é—´
- æ—¶é—´æ ¼å¼ä¸º HH:mm (24å°æ—¶åˆ¶)

### 4. è®¾ç½®ä¼˜å…ˆçº§

1. å…æ‰“æ‰°æ—¶é—´ > é€šçŸ¥ç±»å‹è®¾ç½®
2. é€šçŸ¥æ–¹å¼è®¾ç½® > é€šçŸ¥ç±»å‹è®¾ç½®
3. ç”¨æˆ·ä¸ªäººè®¾ç½® > ç³»ç»Ÿé»˜è®¤è®¾ç½®

## ğŸ“ æµ‹è¯•ç”¨ä¾‹

### 1. è·å–é€šçŸ¥è®¾ç½®æµ‹è¯•

```javascript
// æµ‹è¯•ç”¨ä¾‹1ï¼šæ­£å¸¸è·å–è®¾ç½®
await getNotificationSettings();
// é¢„æœŸï¼šè¿”å›ç”¨æˆ·å½“å‰é€šçŸ¥è®¾ç½®

// æµ‹è¯•ç”¨ä¾‹2ï¼šç”¨æˆ·ä¸å­˜åœ¨
// ä½¿ç”¨ä¸å­˜åœ¨çš„ç”¨æˆ·ID
// é¢„æœŸï¼šè¿”å›404é”™è¯¯

// æµ‹è¯•ç”¨ä¾‹3ï¼šTokenæ— æ•ˆ
// ä½¿ç”¨æ— æ•ˆæˆ–è¿‡æœŸçš„Token
// é¢„æœŸï¼šè¿”å›401é”™è¯¯
```

### 2. æ›´æ–°é€šçŸ¥è®¾ç½®æµ‹è¯•

```javascript
// æµ‹è¯•ç”¨ä¾‹1ï¼šæ­£å¸¸æ›´æ–°è®¾ç½®
await updateNotificationSettings({
  systemAnnouncement: false,
  emailNotification: true
});
// é¢„æœŸï¼šæ›´æ–°æˆåŠŸ

// æµ‹è¯•ç”¨ä¾‹2ï¼šæ—¶é—´æ ¼å¼é”™è¯¯
await updateNotificationSettings({
  dndStartTime: '25:00'
});
// é¢„æœŸï¼šè¿”å›422é”™è¯¯

// æµ‹è¯•ç”¨ä¾‹3ï¼šéƒ¨åˆ†æ›´æ–°
await updateNotificationSettings({
  mealReminder: false
});
// é¢„æœŸï¼šåªæ›´æ–°æŒ‡å®šå­—æ®µ
```

### 3. é‡ç½®é€šçŸ¥è®¾ç½®æµ‹è¯•

```javascript
// æµ‹è¯•ç”¨ä¾‹1ï¼šæ­£å¸¸é‡ç½®
await resetNotificationSettings();
// é¢„æœŸï¼šé‡ç½®ä¸ºé»˜è®¤é…ç½®

// æµ‹è¯•ç”¨ä¾‹2ï¼šé‡ç½®åéªŒè¯
const settings = await getNotificationSettings();
// é¢„æœŸï¼šæ‰€æœ‰è®¾ç½®éƒ½ä¸ºé»˜è®¤å€¼
```

## ğŸ”’ å®‰å…¨è€ƒè™‘

### 1. æƒé™æ§åˆ¶
- ç”¨æˆ·åªèƒ½ä¿®æ”¹è‡ªå·±çš„é€šçŸ¥è®¾ç½®
- ç®¡ç†å‘˜å¯ä»¥æŸ¥çœ‹æ‰€æœ‰ç”¨æˆ·çš„é€šçŸ¥è®¾ç½®

### 2. æ•°æ®éªŒè¯
- éªŒè¯æ—¶é—´æ ¼å¼çš„æ­£ç¡®æ€§
- éªŒè¯å¸ƒå°”å€¼ç±»å‹çš„æ­£ç¡®æ€§
- é˜²æ­¢SQLæ³¨å…¥æ”»å‡»

### 3. æ—¥å¿—è®°å½•
- è®°å½•é€šçŸ¥è®¾ç½®çš„ä¿®æ”¹æ“ä½œ
- è®°å½•æ•æ„Ÿæ“ä½œçš„å®¡è®¡æ—¥å¿—

## ğŸ“ æŠ€æœ¯æ”¯æŒ

å¦‚æœåœ¨å¯¹æ¥è¿‡ç¨‹ä¸­é‡åˆ°é—®é¢˜ï¼Œè¯·æ£€æŸ¥ï¼š

1. **Tokenæœ‰æ•ˆæ€§**: ç¡®ä¿JWT Tokenæœªè¿‡æœŸä¸”æœ‰æ•ˆ
2. **å‚æ•°æ ¼å¼**: ç¡®ä¿è¯·æ±‚å‚æ•°æ ¼å¼æ­£ç¡®
3. **æ—¶é—´æ ¼å¼**: ç¡®ä¿æ—¶é—´æ ¼å¼ä¸ºHH:mm
4. **ç½‘ç»œè¿æ¥**: ç¡®ä¿ç½‘ç»œè¿æ¥æ­£å¸¸
5. **æœåŠ¡å™¨çŠ¶æ€**: ç¡®ä¿åç«¯æœåŠ¡æ­£å¸¸è¿è¡Œ

---

**æ–‡æ¡£ç‰ˆæœ¬**: v1.0  
**æœ€åæ›´æ–°**: 2025-01-27  
**ç»´æŠ¤äººå‘˜**: åç«¯å¼€å‘å›¢é˜Ÿ
