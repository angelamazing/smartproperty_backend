<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>èœå•æ‰¹é‡å¯¼å…¥</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            background: white;
            border-radius: 8px;
            padding: 30px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .header {
            text-align: center;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 2px solid #e0e0e0;
        }
        .header h1 {
            color: #333;
            margin: 0;
        }
        .section {
            margin-bottom: 30px;
            padding: 20px;
            border: 1px solid #e0e0e0;
            border-radius: 6px;
            background-color: #fafafa;
        }
        .section h3 {
            margin-top: 0;
            color: #555;
        }
        .btn {
            background: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            margin-right: 10px;
            margin-bottom: 10px;
        }
        .btn:hover {
            background: #0056b3;
        }
        .btn:disabled {
            background: #ccc;
            cursor: not-allowed;
        }
        .btn-success {
            background: #28a745;
        }
        .btn-success:hover {
            background: #1e7e34;
        }
        .btn-warning {
            background: #ffc107;
            color: #212529;
        }
        .btn-warning:hover {
            background: #e0a800;
        }
        .btn-danger {
            background: #dc3545;
        }
        .btn-danger:hover {
            background: #c82333;
        }
        .file-input {
            margin: 10px 0;
        }
        .file-input input[type="file"] {
            margin-right: 10px;
        }
        .status {
            padding: 10px;
            border-radius: 4px;
            margin: 10px 0;
        }
        .status.success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        .status.error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        .status.info {
            background: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }
        .preview-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 10px;
        }
        .preview-table th,
        .preview-table td {
            border: 1px solid #ddd;
            padding: 8px;
            text-align: left;
        }
        .preview-table th {
            background-color: #f2f2f2;
        }
        .history-item {
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            margin-bottom: 10px;
            background: white;
        }
        .history-item .time {
            color: #666;
            font-size: 0.9em;
        }
        .history-item .status {
            display: inline-block;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 0.8em;
            margin-left: 10px;
        }
        .status.success {
            background: #d4edda;
            color: #155724;
        }
        .status.failed {
            background: #f8d7da;
            color: #721c24;
        }
        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid #f3f3f3;
            border-top: 3px solid #3498db;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .hidden {
            display: none;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸ½ï¸ èœå•æ‰¹é‡å¯¼å…¥ç³»ç»Ÿ</h1>
            <p>æ”¯æŒExcelæ–‡ä»¶æ‰¹é‡å¯¼å…¥ä¸€å‘¨çš„æ—©ä¸­æ™šé¤èœå•</p>
        </div>

        <!-- ç™»å½•åŒºåŸŸ -->
        <div class="section" id="loginSection">
            <h3>ğŸ” ç®¡ç†å‘˜ç™»å½•</h3>
            <div>
                <input type="text" id="phoneInput" placeholder="æ‰‹æœºå·" value="13800138001" style="margin-right: 10px; padding: 8px;">
                <input type="password" id="passwordInput" placeholder="å¯†ç " value="admin123456" style="margin-right: 10px; padding: 8px;">
                <button class="btn" onclick="login()">ç™»å½•</button>
            </div>
            <div id="loginStatus"></div>
        </div>

        <!-- æ¨¡æ¿ä¸‹è½½åŒºåŸŸ -->
        <div class="section" id="templateSection" style="display: none;">
            <h3>ğŸ“¥ ä¸‹è½½Excelæ¨¡æ¿</h3>
            <p>ä¸‹è½½æ ‡å‡†çš„Excelå¯¼å…¥æ¨¡æ¿ï¼ŒæŒ‰ç…§æ¨¡æ¿æ ¼å¼å¡«å†™èœå•æ•°æ®</p>
            <button class="btn btn-success" onclick="downloadTemplate()">ä¸‹è½½æ¨¡æ¿</button>
            <div id="templateStatus"></div>
        </div>

        <!-- æ–‡ä»¶ä¸Šä¼ åŒºåŸŸ -->
        <div class="section" id="uploadSection" style="display: none;">
            <h3>ğŸ“¤ ä¸Šä¼ Excelæ–‡ä»¶</h3>
            <div class="file-input">
                <input type="file" id="excelFile" accept=".xlsx,.xls" onchange="handleFileSelect()">
                <button class="btn" onclick="parseExcel()" id="parseBtn" disabled>è§£ææ–‡ä»¶</button>
            </div>
            <div id="uploadStatus"></div>
        </div>

        <!-- æ•°æ®é¢„è§ˆåŒºåŸŸ -->
        <div class="section" id="previewSection" style="display: none;">
            <h3>ğŸ‘€ æ•°æ®é¢„è§ˆ</h3>
            <div id="previewContent"></div>
            <div style="margin-top: 20px;">
                <button class="btn btn-warning" onclick="executeImport()" id="importBtn">æ‰§è¡Œå¯¼å…¥</button>
                <button class="btn" onclick="resetUpload()">é‡æ–°ä¸Šä¼ </button>
            </div>
            <div id="importStatus"></div>
        </div>

        <!-- å¯¼å…¥å†å²åŒºåŸŸ -->
        <div class="section" id="historySection" style="display: none;">
            <h3>ğŸ“š å¯¼å…¥å†å²</h3>
            <button class="btn" onclick="loadImportHistory()">åˆ·æ–°å†å²</button>
            <div id="historyContent"></div>
        </div>
    </div>

    <script src="/js/api-utils.js"></script>
    <script>
        let currentParseData = null;
        let isLoggedIn = false;

        // ç™»å½•
        async function login() {
            const phone = document.getElementById('phoneInput').value;
            const password = document.getElementById('passwordInput').value;
            const statusDiv = document.getElementById('loginStatus');

            if (!phone || !password) {
                showStatus(statusDiv, 'è¯·è¾“å…¥æ‰‹æœºå·å’Œå¯†ç ', 'error');
                return;
            }

            try {
                showStatus(statusDiv, 'æ­£åœ¨ç™»å½•...', 'info');
                const response = await window.api.authApi.login({ phoneNumber: phone, password: password });
                
                if (response.success) {
                    localStorage.setItem('token', response.data.token);
                    isLoggedIn = true;
                    showStatus(statusDiv, 'ç™»å½•æˆåŠŸï¼', 'success');
                    showLoggedInSections();
                } else {
                    showStatus(statusDiv, 'ç™»å½•å¤±è´¥ï¼š' + response.message, 'error');
                }
            } catch (error) {
                showStatus(statusDiv, 'ç™»å½•å¤±è´¥ï¼š' + error.message, 'error');
            }
        }

        // æ˜¾ç¤ºç™»å½•åçš„åŒºåŸŸ
        function showLoggedInSections() {
            document.getElementById('loginSection').style.display = 'none';
            document.getElementById('templateSection').style.display = 'block';
            document.getElementById('uploadSection').style.display = 'block';
            document.getElementById('historySection').style.display = 'block';
        }

        // ä¸‹è½½æ¨¡æ¿
        async function downloadTemplate() {
            const statusDiv = document.getElementById('templateStatus');
            
            try {
                showStatus(statusDiv, 'æ­£åœ¨ä¸‹è½½æ¨¡æ¿...', 'info');
                await window.api.menuImportApi.downloadTemplate();
                showStatus(statusDiv, 'æ¨¡æ¿ä¸‹è½½æˆåŠŸï¼', 'success');
            } catch (error) {
                showStatus(statusDiv, 'ä¸‹è½½å¤±è´¥ï¼š' + error.message, 'error');
            }
        }

        // å¤„ç†æ–‡ä»¶é€‰æ‹©
        function handleFileSelect() {
            const fileInput = document.getElementById('excelFile');
            const parseBtn = document.getElementById('parseBtn');
            
            if (fileInput.files.length > 0) {
                parseBtn.disabled = false;
            } else {
                parseBtn.disabled = true;
            }
        }

        // è§£æExcelæ–‡ä»¶
        async function parseExcel() {
            const fileInput = document.getElementById('excelFile');
            const statusDiv = document.getElementById('uploadStatus');
            
            if (!fileInput.files.length) {
                showStatus(statusDiv, 'è¯·é€‰æ‹©Excelæ–‡ä»¶', 'error');
                return;
            }

            try {
                showStatus(statusDiv, 'æ­£åœ¨è§£ææ–‡ä»¶...', 'info');
                const response = await window.api.menuImportApi.uploadAndParseExcel(fileInput.files[0]);
                
                if (response.success) {
                    currentParseData = response.data.parseResult.data;
                    showStatus(statusDiv, 'æ–‡ä»¶è§£ææˆåŠŸï¼', 'success');
                    showPreview();
                } else {
                    showStatus(statusDiv, 'è§£æå¤±è´¥ï¼š' + response.message, 'error');
                }
            } catch (error) {
                showStatus(statusDiv, 'è§£æå¤±è´¥ï¼š' + error.message, 'error');
            }
        }

        // æ˜¾ç¤ºé¢„è§ˆ
        function showPreview() {
            const previewSection = document.getElementById('previewSection');
            const previewContent = document.getElementById('previewContent');
            
            if (!currentParseData || currentParseData.length === 0) {
                previewContent.innerHTML = '<p>æ²¡æœ‰å¯é¢„è§ˆçš„æ•°æ®</p>';
                return;
            }

            let html = '<h4>è§£æç»“æœé¢„è§ˆï¼š</h4>';
            html += '<p>å…±è§£æåˆ° ' + currentParseData.length + ' æ¡èœå•æ•°æ®</p>';
            
            // æŒ‰æ—¥æœŸåˆ†ç»„æ˜¾ç¤º
            const groupedData = {};
            currentParseData.forEach(item => {
                const date = item.date;
                if (!groupedData[date]) {
                    groupedData[date] = [];
                }
                groupedData[date].push(item);
            });

            Object.keys(groupedData).sort().forEach(date => {
                html += '<h5>' + date + '</h5>';
                html += '<table class="preview-table">';
                html += '<tr><th>é¤æ¬¡</th><th>èœå“åç§°</th><th>ä»·æ ¼</th><th>åˆ†ç±»</th></tr>';
                
                groupedData[date].forEach(item => {
                    html += '<tr>';
                    html += '<td>' + item.mealType + '</td>';
                    html += '<td>' + item.dishName + '</td>';
                    html += '<td>Â¥' + item.price + '</td>';
                    html += '<td>' + item.category + '</td>';
                    html += '</tr>';
                });
                
                html += '</table>';
            });

            previewContent.innerHTML = html;
            previewSection.style.display = 'block';
        }

        // æ‰§è¡Œå¯¼å…¥
        async function executeImport() {
            const statusDiv = document.getElementById('importStatus');
            const importBtn = document.getElementById('importBtn');
            
            if (!currentParseData) {
                showStatus(statusDiv, 'æ²¡æœ‰å¯å¯¼å…¥çš„æ•°æ®', 'error');
                return;
            }

            try {
                importBtn.disabled = true;
                importBtn.innerHTML = '<span class="loading"></span> æ­£åœ¨å¯¼å…¥...';
                
                showStatus(statusDiv, 'æ­£åœ¨æ‰§è¡Œæ‰¹é‡å¯¼å…¥...', 'info');
                
                const response = await window.api.menuImportApi.batchImportMenus({
                    menuData: currentParseData,
                    options: {
                        overwrite: true,
                        allowPastDates: false,
                        description: 'Webç•Œé¢å¯¼å…¥'
                    },
                    filename: document.getElementById('excelFile').files[0]?.name || 'å¯¼å…¥æ–‡ä»¶'
                });
                
                if (response.success) {
                    showStatus(statusDiv, 'å¯¼å…¥æˆåŠŸï¼å…±å¯¼å…¥ ' + response.data.summary.successCount + ' ä¸ªèœå•', 'success');
                    loadImportHistory(); // åˆ·æ–°å†å²è®°å½•
                } else {
                    showStatus(statusDiv, 'å¯¼å…¥å¤±è´¥ï¼š' + response.message, 'error');
                }
            } catch (error) {
                showStatus(statusDiv, 'å¯¼å…¥å¤±è´¥ï¼š' + error.message, 'error');
            } finally {
                importBtn.disabled = false;
                importBtn.innerHTML = 'æ‰§è¡Œå¯¼å…¥';
            }
        }

        // é‡ç½®ä¸Šä¼ 
        function resetUpload() {
            document.getElementById('excelFile').value = '';
            document.getElementById('parseBtn').disabled = true;
            document.getElementById('previewSection').style.display = 'none';
            document.getElementById('uploadStatus').innerHTML = '';
            document.getElementById('importStatus').innerHTML = '';
            currentParseData = null;
        }

        // åŠ è½½å¯¼å…¥å†å²
        async function loadImportHistory() {
            const historyContent = document.getElementById('historyContent');
            
            try {
                const response = await window.api.menuImportApi.getImportHistory({ page: 1, pageSize: 10 });
                
                if (response.success) {
                    const history = response.data.list;
                    
                    if (history.length === 0) {
                        historyContent.innerHTML = '<p>æš‚æ— å¯¼å…¥å†å²</p>';
                        return;
                    }
                    
                    let html = '<h4>æœ€è¿‘å¯¼å…¥è®°å½•ï¼š</h4>';
                    history.forEach(record => {
                        const details = JSON.parse(record.details);
                        const statusClass = details.success ? 'success' : 'failed';
                        const statusText = details.success ? 'æˆåŠŸ' : 'å¤±è´¥';
                        
                        html += '<div class="history-item">';
                        html += '<div><strong>' + record.resourceId + '</strong>';
                        html += '<span class="status ' + statusClass + '">' + statusText + '</span></div>';
                        html += '<div class="time">' + new Date(record.createTime).toLocaleString() + '</div>';
                        if (details.summary) {
                            html += '<div>æˆåŠŸ: ' + details.summary.successCount + ', å¤±è´¥: ' + details.summary.failedCount + '</div>';
                        }
                        html += '</div>';
                    });
                    
                    historyContent.innerHTML = html;
                } else {
                    historyContent.innerHTML = '<p>åŠ è½½å†å²å¤±è´¥ï¼š' + response.message + '</p>';
                }
            } catch (error) {
                historyContent.innerHTML = '<p>åŠ è½½å†å²å¤±è´¥ï¼š' + error.message + '</p>';
            }
        }

        // æ˜¾ç¤ºçŠ¶æ€ä¿¡æ¯
        function showStatus(element, message, type) {
            element.innerHTML = '<div class="status ' + type + '">' + message + '</div>';
        }

        // é¡µé¢åŠ è½½æ—¶æ£€æŸ¥ç™»å½•çŠ¶æ€
        window.onload = function() {
            const token = localStorage.getItem('token');
            if (token) {
                isLoggedIn = true;
                showLoggedInSections();
                loadImportHistory();
            }
        };
    </script>
</body>
</html>

