# 智慧物业管理系统 - 后端接口新增需求

## 概述

为了解决前端测试登录缺少部门管理员权限的问题，需要在后端新增以下测试登录接口：

## 1. 部门管理员测试登录接口

### 接口信息
- **接口地址**: `POST /api/auth/test-login-admin`
- **功能描述**: 提供部门管理员权限的测试登录功能
- **开发环境**: 仅在开发环境可用

### 请求参数
```javascript
{
  // 无需参数，接口内部生成测试数据
}
```

### 响应示例
```javascript
{
  "success": true,
  "message": "部门管理员测试登录成功",
  "data": {
    "token": "admin_token_123456789",
    "userInfo": {
      "_id": "test_admin_id_123",
      "nickName": "测试管理员",
      "avatarUrl": "https://...",
      "role": "dept_admin",
      "department": "技术部",
      "permissions": [
        "user.view",
        "dining.manage",
        "reservation.audit",
        "venue.manage"
      ],
      "isTestUser": true,
      "isAdminTest": true
    },
    "isTestLogin": true
  }
}
```

### 权限说明
部门管理员权限包括：
- 管理部门成员报餐
- 审核特殊预约申请
- 查看部门统计数据
- 管理场地预约（部分权限）

## 2. 系统管理员测试登录接口

### 接口信息
- **接口地址**: `POST /api/auth/test-login-sys-admin`
- **功能描述**: 提供系统管理员权限的测试登录功能
- **开发环境**: 仅在开发环境可用

### 请求参数
```javascript
{
  // 无需参数，接口内部生成测试数据
}
```

### 响应示例
```javascript
{
  "success": true,
  "message": "系统管理员测试登录成功",
  "data": {
    "token": "sys_admin_token_123456789",
    "userInfo": {
      "_id": "test_sys_admin_id_123",
      "nickName": "系统管理员",
      "avatarUrl": "https://...",
      "role": "sys_admin",
      "department": "系统管理",
      "permissions": [
        "user.manage",
        "system.manage",
        "dining.manage",
        "reservation.manage",
        "venue.manage",
        "verification.manage"
      ],
      "isTestUser": true,
      "isSysAdminTest": true
    },
    "isTestLogin": true
  }
}
```

### 权限说明
系统管理员权限包括：
- 所有用户管理权限
- 系统配置管理
- 所有业务模块管理
- 数据统计查看

## 3. 实现要求

### 安全要求
1. **仅开发环境可用**: 生产环境必须禁用这些接口
2. **Token有效期**: 测试Token有效期建议设置为24小时
3. **日志记录**: 记录测试登录操作，便于调试

### 数据库要求
1. **测试数据隔离**: 测试用户数据不应影响生产数据
2. **权限控制**: 严格按照角色权限控制访问范围
3. **数据清理**: 定期清理过期的测试数据

### 错误处理
1. **环境检查**: 非开发环境返回403错误
2. **参数验证**: 虽然无参数，也要进行基础验证
3. **异常处理**: 完善的异常处理和错误信息返回

## 4. 测试验证

### 前端验证步骤
1. 启动开发环境前端应用
2. 点击"管理员测试"或"系统管理员测试"按钮
3. 确认登录后检查用户角色和权限
4. 验证相关管理功能是否正常工作

### 后端验证步骤
1. 使用Postman等工具直接调用接口
2. 验证返回的Token是否有效
3. 验证用户角色和权限是否正确
4. 验证Token是否可以正常访问受保护的接口

## 5. 部署注意事项

### 环境配置
```javascript
// config/development.js
module.exports = {
  testLogin: {
    enabled: true,
    adminRole: 'dept_admin',
    sysAdminRole: 'sys_admin',
    tokenExpireTime: '24h'
  }
}

// config/production.js
module.exports = {
  testLogin: {
    enabled: false  // 生产环境禁用
  }
}
```

### 中间件配置
```javascript
// 中间件验证开发环境
const validateDevEnvironment = (req, res, next) => {
  if (process.env.NODE_ENV !== 'development') {
    return res.status(403).json({
      success: false,
      message: '该接口仅在开发环境可用'
    })
  }
  next()
}
```

## 6. 联系方式

如有技术问题，请联系开发团队。
