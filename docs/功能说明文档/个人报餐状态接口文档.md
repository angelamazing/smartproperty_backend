# 个人报餐状态接口文档

## 📋 接口概述

**接口名称**: 获取个人报餐状态  
**接口路径**: `GET /api/dining/personal-status`  
**功能描述**: 获取用户指定日期的个人报餐状态信息，包含早中晚三个餐次的报餐情况，用于前端生成用餐卡片。

## 🔐 权限要求

- 需要用户认证Token
- 用户只能查看自己的报餐状态

## 📥 请求参数

### Query Parameters

| 参数名 | 类型 | 必填 | 默认值 | 说明 |
|--------|------|------|--------|------|
| date | string | 否 | 今天 | 查询日期，格式：YYYY-MM-DD |

### 请求示例

```http
GET /api/dining/personal-status?date=2025-09-04
Authorization: Bearer {your-jwt-token}
Content-Type: application/json
```

## 📤 响应数据

### 成功响应 (200)

```json
{
  "success": true,
  "message": "获取个人报餐状态成功",
  "code": "200",
  "timestamp": "2025-09-04T10:15:08.638Z",
  "data": {
    "userId": "user_123",
    "userName": "张三",
    "department": "技术部",
    "queryDate": "2025-09-04",
    "mealStatus": {
      "breakfast": {
        "isRegistered": true,
        "status": "confirmed",
        "statusText": "已确认",
        "orderId": "order_123",
        "menuId": "menu_123",
        "menuName": "今日早餐",
        "dishes": [
          {
            "dishId": "dish_1",
            "dishName": "小笼包",
            "dishImage": "https://example.com/image1.jpg",
            "originalPrice": 10.00,
            "menuPrice": 8.00,
            "sort": 1
          },
          {
            "dishId": "dish_2",
            "dishName": "豆浆",
            "dishImage": "https://example.com/image2.jpg",
            "originalPrice": 5.00,
            "menuPrice": 4.00,
            "sort": 2
          }
        ],
        "totalAmount": 12.00,
        "registerTime": "2025-09-04T08:30:00.000Z",
        "registrantName": "部门管理员",
        "remark": "备注信息"
      },
      "lunch": {
        "isRegistered": true,
        "status": "pending",
        "statusText": "待确认",
        "orderId": "order_124",
        "menuId": "menu_124",
        "menuName": "今日午餐",
        "dishes": [
          {
            "dishId": "dish_3",
            "dishName": "宫保鸡丁",
            "dishImage": "https://example.com/image3.jpg",
            "originalPrice": 18.00,
            "menuPrice": 15.00,
            "sort": 1
          }
        ],
        "totalAmount": 15.00,
        "registerTime": "2025-09-04T10:15:00.000Z",
        "registrantName": "部门管理员",
        "remark": ""
      },
      "dinner": {
        "isRegistered": false,
        "status": null,
        "statusText": "未报餐",
        "orderId": null,
        "menuId": null,
        "menuName": null,
        "dishes": [],
        "totalAmount": 0.00,
        "registerTime": null,
        "registrantName": null,
        "remark": null
      }
    },
    "summary": {
      "totalRegistered": 2,
      "totalAmount": 27.00,
      "confirmedCount": 1,
      "pendingCount": 1,
      "unregisteredCount": 1
    },
    "availableMenus": {
      "breakfast": {
        "menuId": "menu_123",
        "menuName": "今日早餐",
        "publishStatus": "published",
        "dishes": [
          {
            "dishId": "dish_1",
            "dishName": "小笼包",
            "dishImage": "https://example.com/image1.jpg",
            "originalPrice": 10.00,
            "menuPrice": 8.00,
            "sort": 1
          }
        ]
      },
      "lunch": {
        "menuId": "menu_124",
        "menuName": "今日午餐",
        "publishStatus": "published",
        "dishes": [
          {
            "dishId": "dish_3",
            "dishName": "宫保鸡丁",
            "dishImage": "https://example.com/image3.jpg",
            "originalPrice": 18.00,
            "menuPrice": 15.00,
            "sort": 1
          }
        ]
      },
      "dinner": {
        "menuId": null,
        "menuName": null,
        "publishStatus": null,
        "dishes": []
      }
    }
  }
}
```

### 错误响应

#### 400 - 参数错误
```json
{
  "success": false,
  "message": "日期格式不正确，请使用YYYY-MM-DD格式",
  "code": "400",
  "timestamp": "2025-09-04T10:15:08.638Z"
}
```

#### 401 - 未授权
```json
{
  "success": false,
  "message": "未授权访问",
  "code": "401",
  "timestamp": "2025-09-04T10:15:08.638Z"
}
```

#### 404 - 用户不存在
```json
{
  "success": false,
  "message": "用户不存在",
  "code": "404",
  "timestamp": "2025-09-04T10:15:08.638Z"
}
```

#### 500 - 服务器错误
```json
{
  "success": false,
  "message": "获取个人报餐状态失败",
  "code": "500",
  "timestamp": "2025-09-04T10:15:08.638Z"
}
```

## 📊 数据结构说明

### mealStatus 对象

每个餐次（breakfast/lunch/dinner）包含以下字段：

| 字段名 | 类型 | 说明 |
|--------|------|------|
| isRegistered | boolean | 是否已报餐 |
| status | string\|null | 报餐状态：pending/confirmed/completed/cancelled |
| statusText | string | 状态文本：待确认/已确认/已完成/已取消/未报餐 |
| orderId | string\|null | 订单ID |
| menuId | string\|null | 菜单ID |
| menuName | string\|null | 菜单名称 |
| dishes | array | 菜品列表 |
| totalAmount | number | 总金额 |
| registerTime | string\|null | 报餐时间 |
| registrantName | string\|null | 报餐人姓名 |
| remark | string\|null | 备注信息 |

### dishes 数组

每个菜品包含以下字段：

| 字段名 | 类型 | 说明 |
|--------|------|------|
| dishId | string | 菜品ID |
| dishName | string | 菜品名称 |
| dishImage | string | 菜品图片URL |
| originalPrice | number | 原始价格 |
| menuPrice | number | 菜单价格 |
| sort | number | 排序 |

### summary 对象

汇总统计信息：

| 字段名 | 类型 | 说明 |
|--------|------|------|
| totalRegistered | number | 已报餐餐次数量 |
| totalAmount | number | 总金额 |
| confirmedCount | number | 已确认数量 |
| pendingCount | number | 待确认数量 |
| unregisteredCount | number | 未报餐数量 |

## 🎨 前端使用示例

### React 组件示例

```jsx
import React, { useState, useEffect } from 'react';

const DiningCard = () => {
  const [diningStatus, setDiningStatus] = useState(null);
  const [loading, setLoading] = useState(true);

  useEffect(() => {
    fetchPersonalDiningStatus();
  }, []);

  const fetchPersonalDiningStatus = async () => {
    try {
      const response = await fetch('/api/dining/personal-status', {
        headers: {
          'Authorization': `Bearer ${localStorage.getItem('token')}`
        }
      });
      const data = await response.json();
      setDiningStatus(data.data);
    } catch (error) {
      console.error('获取报餐状态失败:', error);
    } finally {
      setLoading(false);
    }
  };

  const renderMealCard = (mealType, mealData) => {
    const mealNames = {
      breakfast: '早餐',
      lunch: '午餐',
      dinner: '晚餐'
    };

    return (
      <div className={`meal-card ${mealData.isRegistered ? 'registered' : 'unregistered'}`}>
        <div className="meal-header">
          <h3>{mealNames[mealType]}</h3>
          <span className={`status ${mealData.status}`}>
            {mealData.statusText}
          </span>
        </div>
        
        {mealData.isRegistered ? (
          <div className="meal-content">
            <div className="menu-info">
              <h4>{mealData.menuName}</h4>
              <p className="amount">¥{mealData.totalAmount}</p>
            </div>
            
            <div className="dishes">
              {mealData.dishes.map(dish => (
                <div key={dish.dishId} className="dish-item">
                  <img src={dish.dishImage} alt={dish.dishName} />
                  <span>{dish.dishName}</span>
                  <span className="price">¥{dish.menuPrice}</span>
                </div>
              ))}
            </div>
            
            <div className="meal-footer">
              <small>报餐人：{mealData.registrantName}</small>
              <small>时间：{new Date(mealData.registerTime).toLocaleString()}</small>
            </div>
          </div>
        ) : (
          <div className="no-registration">
            <p>暂未报餐</p>
            {diningStatus.availableMenus[mealType] && (
              <button className="register-btn">立即报餐</button>
            )}
          </div>
        )}
      </div>
    );
  };

  if (loading) return <div>加载中...</div>;
  if (!diningStatus) return <div>获取数据失败</div>;

  return (
    <div className="dining-status">
      <div className="user-info">
        <h2>{diningStatus.userName}</h2>
        <p>{diningStatus.department} | {diningStatus.queryDate}</p>
      </div>
      
      <div className="summary">
        <div className="summary-item">
          <span>已报餐：{diningStatus.summary.totalRegistered}餐</span>
        </div>
        <div className="summary-item">
          <span>总金额：¥{diningStatus.summary.totalAmount}</span>
        </div>
      </div>
      
      <div className="meal-cards">
        {renderMealCard('breakfast', diningStatus.mealStatus.breakfast)}
        {renderMealCard('lunch', diningStatus.mealStatus.lunch)}
        {renderMealCard('dinner', diningStatus.mealStatus.dinner)}
      </div>
    </div>
  );
};

export default DiningCard;
```

### CSS 样式示例

```css
.dining-status {
  max-width: 800px;
  margin: 0 auto;
  padding: 20px;
}

.meal-card {
  border: 1px solid #ddd;
  border-radius: 8px;
  margin-bottom: 20px;
  padding: 16px;
  background: #fff;
}

.meal-card.registered {
  border-left: 4px solid #4CAF50;
}

.meal-card.unregistered {
  border-left: 4px solid #f44336;
  background: #fafafa;
}

.meal-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 12px;
}

.status {
  padding: 4px 8px;
  border-radius: 4px;
  font-size: 12px;
  font-weight: bold;
}

.status.confirmed {
  background: #4CAF50;
  color: white;
}

.status.pending {
  background: #FF9800;
  color: white;
}

.status.unregistered {
  background: #f44336;
  color: white;
}

.dishes {
  display: grid;
  grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
  gap: 12px;
  margin: 12px 0;
}

.dish-item {
  display: flex;
  align-items: center;
  gap: 8px;
  padding: 8px;
  background: #f5f5f5;
  border-radius: 4px;
}

.dish-item img {
  width: 40px;
  height: 40px;
  object-fit: cover;
  border-radius: 4px;
}

.summary {
  display: flex;
  gap: 20px;
  margin-bottom: 20px;
  padding: 16px;
  background: #e3f2fd;
  border-radius: 8px;
}

.no-registration {
  text-align: center;
  padding: 20px;
  color: #666;
}

.register-btn {
  background: #2196F3;
  color: white;
  border: none;
  padding: 8px 16px;
  border-radius: 4px;
  cursor: pointer;
}
```

## 🔧 技术实现要点

1. **性能优化**: 使用单次查询获取所有餐次信息，减少数据库查询次数
2. **数据完整性**: 处理菜单不存在、菜品信息缺失等情况
3. **权限控制**: 用户只能查看自己的报餐状态
4. **错误处理**: 完善的异常处理和默认值设置
5. **缓存策略**: 可考虑缓存菜单信息减少数据库查询

## 📱 移动端适配

- 响应式设计适配不同屏幕尺寸
- 卡片式布局便于滑动浏览
- 状态颜色区分便于快速识别
- 支持快速操作（如取消报餐、重新报餐等）

## 🧪 测试用例

### 正常情况测试
1. 用户已报早餐和午餐，未报晚餐
2. 用户未报任何餐次
3. 用户所有餐次都已报餐

### 边界情况测试
1. 查询不存在的日期
2. 用户不存在
3. 菜单信息缺失
4. 菜品信息缺失

### 错误情况测试
1. 无效的日期格式
2. 缺少认证Token
3. 数据库连接失败
