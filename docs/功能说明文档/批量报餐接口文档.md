# 批量报餐接口文档

## 概述

批量报餐功能支持部门管理员一次性为多个成员、多个餐次、多个日期进行报餐，大大提高了报餐效率。

## 功能特性

- ✅ **跨天报餐**: 支持今天、明天等多个日期的报餐
- ✅ **跨餐次报餐**: 支持早餐、午餐、晚餐的任意组合
- ✅ **灵活成员选择**: 每个餐次可以选择不同的成员
- ✅ **事务处理**: 确保数据一致性，支持部分成功
- ✅ **详细错误报告**: 提供每个失败订单的具体错误信息
- ✅ **权限控制**: 只能为同部门成员报餐

## 接口列表

### 1. 批量报餐接口

**接口地址**: `POST /api/dining/enhanced/batch-orders`

**功能描述**: 支持一次性提交多个日期、多个餐次的报餐申请，每个餐次可以选择不同的成员

**权限要求**: 部门管理员

**请求参数**:
```json
{
  "orders": [
    {
      "date": "2025-09-06",
      "mealType": "lunch",
      "members": [
        {"userId": "user1-uuid"},
        {"userId": "user2-uuid"}
      ],
      "remark": "今日午餐"
    },
    {
      "date": "2025-09-06", 
      "mealType": "dinner",
      "members": [
        {"userId": "user1-uuid"},
        {"userId": "user3-uuid"}
      ],
      "remark": "今日晚餐"
    },
    {
      "date": "2025-09-07",
      "mealType": "breakfast", 
      "members": [
        {"userId": "user1-uuid"},
        {"userId": "user2-uuid"},
        {"userId": "user3-uuid"}
      ],
      "remark": "明日早餐"
    }
  ]
}
```

**参数说明**:
- `orders`: 订单数组，必填，最多20个订单
- `date`: 用餐日期，格式：YYYY-MM-DD，必填
- `mealType`: 餐次类型，枚举值：`breakfast`、`lunch`、`dinner`，必填
- `members`: 成员列表，必填，每个订单至少1个成员
- `remark`: 备注信息，可选，最多500字符

**响应示例**:
```json
{
  "success": true,
  "message": "批量报餐提交完成",
  "data": {
    "totalOrders": 3,
    "successCount": 3,
    "failedCount": 0,
    "orders": [
      {
        "orderId": "order-uuid-1",
        "date": "2025-09-06",
        "mealType": "lunch",
        "memberCount": 2,
        "totalAmount": 25.00,
        "status": "pending"
      },
      {
        "orderId": "order-uuid-2", 
        "date": "2025-09-06",
        "mealType": "dinner",
        "memberCount": 2,
        "totalAmount": 30.00,
        "status": "pending"
      },
      {
        "orderId": "order-uuid-3",
        "date": "2025-09-07", 
        "mealType": "breakfast",
        "memberCount": 3,
        "totalAmount": 15.00,
        "status": "pending"
      }
    ],
    "errors": []
  }
}
```

### 2. 快速批量报餐接口

**接口地址**: `POST /api/dining/enhanced/quick-batch-orders`

**功能描述**: 为固定的成员列表快速报多个餐次，适用于为同一批人报多个餐次

**权限要求**: 部门管理员

**请求参数**:
```json
{
  "members": [
    {"userId": "user1-uuid"},
    {"userId": "user2-uuid"},
    {"userId": "user3-uuid"}
  ],
  "meals": [
    {
      "date": "2025-09-06",
      "mealType": "lunch"
    },
    {
      "date": "2025-09-06", 
      "mealType": "dinner"
    },
    {
      "date": "2025-09-07",
      "mealType": "breakfast"
    },
    {
      "date": "2025-09-07",
      "mealType": "lunch"
    }
  ],
  "remark": "团队批量报餐"
}
```

**参数说明**:
- `members`: 成员列表，必填，最多50个成员
- `meals`: 餐次列表，必填，最多10个餐次
- `remark`: 备注信息，可选，最多500字符

**响应示例**:
```json
{
  "success": true,
  "message": "快速批量报餐提交完成",
  "data": {
    "totalOrders": 4,
    "successCount": 4,
    "failedCount": 0,
    "orders": [
      {
        "orderId": "order-uuid-1",
        "date": "2025-09-06",
        "mealType": "lunch",
        "memberCount": 3,
        "totalAmount": 37.50,
        "status": "pending"
      },
      {
        "orderId": "order-uuid-2", 
        "date": "2025-09-06",
        "mealType": "dinner",
        "memberCount": 3,
        "totalAmount": 45.00,
        "status": "pending"
      },
      {
        "orderId": "order-uuid-3",
        "date": "2025-09-07", 
        "mealType": "breakfast",
        "memberCount": 3,
        "totalAmount": 22.50,
        "status": "pending"
      },
      {
        "orderId": "order-uuid-4",
        "date": "2025-09-07", 
        "mealType": "lunch",
        "memberCount": 3,
        "totalAmount": 37.50,
        "status": "pending"
      }
    ],
    "errors": []
  }
}
```

## 错误处理

### 部分成功场景

当部分订单成功、部分失败时，响应格式：

```json
{
  "success": true,
  "message": "批量报餐提交完成",
  "data": {
    "totalOrders": 3,
    "successCount": 2,
    "failedCount": 1,
    "orders": [
      {
        "orderId": "order-uuid-1",
        "date": "2025-09-06",
        "mealType": "lunch",
        "memberCount": 2,
        "totalAmount": 25.00,
        "status": "pending"
      },
      {
        "orderId": "order-uuid-2", 
        "date": "2025-09-06",
        "mealType": "dinner",
        "memberCount": 2,
        "totalAmount": 30.00,
        "status": "pending"
      }
    ],
    "errors": [
      {
        "orderIndex": 3,
        "date": "2025-09-07",
        "mealType": "breakfast",
        "error": "订单 3: 菜单尚未发布"
      }
    ]
  }
}
```

### 常见错误类型

| 错误类型 | 错误信息 | 解决方案 |
|---------|---------|---------|
| 参数验证失败 | `订单 1: 缺少必要参数` | 检查请求参数格式 |
| 日期格式错误 | `订单 1: 日期格式不正确` | 使用 YYYY-MM-DD 格式 |
| 餐次类型错误 | `订单 1: 餐次类型不正确` | 使用 breakfast/lunch/dinner |
| 过去日期报餐 | `订单 1: 不能为过去的日期报餐` | 选择今天或未来的日期 |
| 菜单未发布 | `订单 1: 菜单尚未发布` | 等待菜单发布或联系管理员 |
| 用户不存在 | `订单 1: 部分用户不存在或状态异常` | 检查用户ID是否正确 |
| 跨部门报餐 | `订单 1: 用户 张三 不属于本部门` | 只能为同部门成员报餐 |
| 重复报餐 | `订单 1: 用户 李四 已经报餐` | 检查是否已报过该餐次 |

## 使用场景示例

### 场景1: 部门管理员为团队报餐

```javascript
// 今天午餐、晚餐 + 明天早餐
const batchOrder = {
  orders: [
    {
      date: "2025-09-06",
      mealType: "lunch", 
      members: [
        {"userId": "user1-uuid"}, 
        {"userId": "user2-uuid"}
      ],
      remark: "今日午餐"
    },
    {
      date: "2025-09-06",
      mealType: "dinner",
      members: [
        {"userId": "user1-uuid"}, 
        {"userId": "user3-uuid"}
      ],
      remark: "今日晚餐"
    },
    {
      date: "2025-09-07", 
      mealType: "breakfast",
      members: [
        {"userId": "user1-uuid"}, 
        {"userId": "user2-uuid"}, 
        {"userId": "user3-uuid"}
      ],
      remark: "明日早餐"
    }
  ]
};
```

### 场景2: 快速为固定团队报多餐

```javascript
// 为固定团队报今天和明天的所有餐次
const quickBatch = {
  members: [
    {"userId": "user1-uuid"}, 
    {"userId": "user2-uuid"}
  ],
  meals: [
    {date: "2025-09-06", mealType: "lunch"},
    {date: "2025-09-06", mealType: "dinner"}, 
    {date: "2025-09-07", mealType: "breakfast"},
    {date: "2025-09-07", mealType: "lunch"}
  ],
  remark: "团队批量报餐"
};
```

### 场景3: 复杂报餐需求

```javascript
// 不同餐次选择不同成员
const complexBatch = {
  orders: [
    // 今天午餐：A组
    {
      date: "2025-09-06",
      mealType: "lunch",
      members: [
        {"userId": "user1-uuid"},
        {"userId": "user2-uuid"}
      ],
      remark: "A组今日午餐"
    },
    // 今天晚餐：B组
    {
      date: "2025-09-06",
      mealType: "dinner",
      members: [
        {"userId": "user3-uuid"},
        {"userId": "user4-uuid"}
      ],
      remark: "B组今日晚餐"
    },
    // 明天早餐：全员
    {
      date: "2025-09-07",
      mealType: "breakfast",
      members: [
        {"userId": "user1-uuid"},
        {"userId": "user2-uuid"},
        {"userId": "user3-uuid"},
        {"userId": "user4-uuid"}
      ],
      remark: "全员明日早餐"
    }
  ]
};
```

## 技术实现

### 数据库事务

- 使用数据库事务确保数据一致性
- 如果任何订单失败，整个批次会回滚
- 支持部分成功场景

### 权限控制

- 只有部门管理员可以调用此接口
- 只能为同部门成员报餐
- 验证用户状态和权限

### 业务规则

1. **日期验证**: 不能为过去的日期报餐
2. **菜单检查**: 确保对应日期和餐次的菜单已发布
3. **重复检查**: 避免重复报餐
4. **成员验证**: 确保所有成员存在且属于同一部门
5. **金额计算**: 自动计算每个订单的总金额

### 性能优化

- 批量处理减少数据库连接次数
- 使用连接池管理数据库连接
- 异步处理提高响应速度

## 注意事项

1. **数量限制**: 
   - 批量报餐：最多20个订单
   - 快速批量：最多50个成员，10个餐次

2. **时间限制**: 不能为过去的日期报餐

3. **权限限制**: 只能为同部门成员报餐

4. **菜单依赖**: 需要对应日期和餐次的菜单已发布

5. **重复检查**: 系统会自动检查重复报餐

6. **错误处理**: 建议前端根据错误信息进行相应处理

## 测试建议

1. **正常流程测试**: 测试各种正常的批量报餐场景
2. **边界测试**: 测试最大数量限制
3. **错误测试**: 测试各种错误情况
4. **权限测试**: 测试跨部门报餐的权限控制
5. **并发测试**: 测试多用户同时批量报餐

## 更新日志

- **v1.0.0** (2025-09-06): 初始版本，支持基础批量报餐功能
- 支持跨天、跨餐次报餐
- 支持灵活成员选择
- 支持快速批量报餐
- 完整的错误处理和事务支持
