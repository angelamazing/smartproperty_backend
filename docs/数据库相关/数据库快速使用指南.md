# 数据库快速使用指南

## 🚀 快速开始

### 1. 初始化数据库

```bash
# 完整初始化 (推荐)
node scripts/initDatabase-complete.js init

# 原有脚本初始化
node scripts/initDatabase.js init
```

### 2. 验证数据库

```bash
# 验证数据库结构
node scripts/initDatabase-complete.js verify
```

### 3. 重置数据库 (谨慎使用)

```bash
# 重置所有数据
node scripts/initDatabase-complete.js reset

# 仅清理数据
node scripts/initDatabase-complete.js clean
```

## 📊 数据库结构概览

### 核心表 (5个)
- `users` - 用户信息
- `departments` - 部门管理
- `user_tokens` - 登录凭证
- `verification_codes` - 验证码
- `system_configs` - 系统配置

### 业务表 (6个)
- `menus` - 菜单管理
- `dining_orders` - 报餐记录
- `special_reservations` - 特殊预约
- `venues` - 场地信息
- `reservations` - 场地预约
- `dining_tables` - 餐桌管理

### 扩展表 (4个)
- `dining_verifications` - 用餐验证
- `system_announcements` - 系统公告
- `activity_logs` - 操作日志
- `file_uploads` - 文件管理

## 🔧 脚本对比

### 新版脚本 (initDatabase-complete.js)
✅ **推荐使用**
- 15个完整表结构
- 丰富的示例数据
- 完善的索引设计
- 详细的字段注释
- 数据验证功能
- 支持重置和清理

### 原版脚本 (initDatabase.js)
⚠️ **仅兼容性保留**
- 基础表结构
- 简单示例数据
- 基本功能实现

## 💾 示例数据说明

### 部门数据
- 技术部 (TECH)
- 人事部 (HR)  
- 财务部 (FINANCE)

### 场地数据
- 羽毛球场A (BD001)
- 乒乓球台1号 (TT001)
- 篮球场 (BB001)

### 餐桌数据
- A区01号桌 (A001)
- A区02号桌 (A002)
- B区01号桌 (B001)

### 系统配置
- 系统名称
- 报餐提前天数
- 预约最大时长
- 二维码过期时间

## 🛠️ 故障排除

### 常见问题

1. **数据库连接失败**
   ```bash
   # 检查配置
   cat config/database.js
   # 检查MySQL服务
   systemctl status mysql
   ```

2. **表已存在错误**
   ```bash
   # 重置数据库
   node scripts/initDatabase-complete.js reset
   ```

3. **外键约束错误** ✅ **已修复**
   ```bash
   # 如果遇到循环依赖错误，直接重新初始化即可
   node scripts/initDatabase-complete.js reset
   # 或者清理后重新初始化
   node scripts/initDatabase-complete.js clean
   node scripts/initDatabase-complete.js init
   ```
   
   **修复说明**: 已解决用户表和部门表之间的循环依赖问题，脚本会自动处理外键约束。

4. **权限不足**
   ```bash
   # 确保数据库用户有CREATE权限
   GRANT ALL PRIVILEGES ON *.* TO 'root'@'%';
   ```

### 日志查看

```bash
# 查看操作日志
tail -f logs/combined.log

# 查看错误日志  
tail -f logs/error.log
```

## 📋 维护建议

### 定期维护
- 清理过期Token (user_tokens表)
- 清理过期验证码 (verification_codes表)
- 归档操作日志 (activity_logs表)

### 性能监控
- 监控慢查询
- 检查索引使用情况
- 分析表空间占用

### 备份策略
- 每日自动备份
- 重要操作前手动备份
- 定期验证备份完整性

## 🚨 注意事项

1. **生产环境**: 使用`init`而非`reset`
2. **数据安全**: `reset`和`clean`会删除所有数据
3. **外键关系**: 删除数据时注意关联关系
4. **索引优化**: 大量数据时考虑索引调优
5. **字符集**: 统一使用utf8mb4编码

## 📞 技术支持

如有问题，请查看：
- `数据库结构说明.md` - 详细结构文档
- `scripts/database-design.md` - 设计思路
- 项目日志文件 - 错误信息

---

**快速参考**: 日常使用`init`初始化，问题排查用`verify`验证，紧急情况用`reset`重置。
