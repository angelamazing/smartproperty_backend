# 智慧物业管理系统 - 数据库结构说明

## 概述

本文档详细说明智慧物业管理系统的完整数据库结构设计，包含15个核心表，覆盖用户管理、报餐预约、场地管理、用餐验证等全部业务功能。

## 数据库设计原则

1. **规范化设计**: 遵循第三范式，减少数据冗余
2. **性能优化**: 合理设置索引，优化查询性能
3. **扩展性**: 预留扩展字段，支持业务发展
4. **数据完整性**: 使用外键约束保证数据一致性
5. **安全性**: 敏感数据适当处理，操作日志完整

## 表结构详解

### 1. 核心用户管理

#### users (用户表)
存储所有用户的基本信息，支持微信和手机号登录

**核心字段**:
- `_id`: 用户唯一标识 (UUID)
- `openid/unionid`: 微信登录标识
- `phoneNumber`: 手机号登录标识
- `role`: 用户角色 (user/dept_admin/sys_admin/verifier)
- `department/departmentId`: 部门信息
- `isTestUser/isAdminTest/isSysAdminTest`: 测试用户标识

**业务关系**:
- 与departments表关联 (departmentId)
- 被所有业务表引用作为操作人

#### departments (部门表)
标准化的部门信息管理

**核心字段**:
- `name/code`: 部门名称和编码
- `parentId`: 支持部门层级结构
- `managerId`: 部门负责人

#### user_tokens (用户令牌表)
JWT Token管理，支持多端登录

**核心字段**:
- `token`: JWT令牌
- `expireTime`: 过期时间
- `deviceInfo`: 设备信息 (JSON)
- `isTestToken`: 测试令牌标识

#### verification_codes (验证码表)
短信验证码管理，防止滥用

**核心字段**:
- `phoneNumber/code`: 手机号和验证码
- `type`: 验证码类型 (login/register/reset)
- `expireTime`: 过期时间
- `ipAddress`: 请求IP (安全审计)

### 2. 报餐管理系统

#### menus (菜单表)
每日菜单发布管理

**核心字段**:
- `publishDate/mealType`: 日期和餐次
- `dishes`: 菜品信息 (JSON)
- `nutritionInfo`: 营养信息 (JSON)
- `capacity/currentOrders`: 容量控制

**业务规则**:
- 每天每餐次只能有一个菜单 (唯一约束)
- 支持容量限制和超额控制

#### dining_orders (报餐记录表)
日常报餐订单管理

**核心字段**:
- `menuId`: 关联菜单
- `registrantId`: 报餐人
- `memberIds/memberNames`: 报餐成员 (JSON)
- `diningDate/mealType`: 用餐时间
- `status`: 订单状态 (pending/confirmed/completed/cancelled)

**业务规则**:
- 支持部门批量报餐
- 完整的状态流转
- 金额计算和确认

#### special_reservations (特殊预约表)
特殊预约申请和审核

**核心字段**:
- `applicantId`: 申请人
- `date/mealTime`: 预约时间
- `peopleCount`: 预约人数
- `selectedDishes`: 选择菜品 (JSON)
- `status`: 审核状态
- `auditorId/auditTime`: 审核信息

**业务规则**:
- 支持完整的审核流程
- 特殊要求和菜品定制
- 审核意见记录

### 3. 场地预约系统

#### venues (场地表)
场地基本信息管理

**核心字段**:
- `name/code`: 场地名称和编码
- `type`: 场地类型 (badminton/pingpong/basketball/meeting)
- `capacity`: 容量限制
- `openTime/closeTime`: 开放时间
- `facilities`: 设施信息 (JSON)

#### reservations (场地预约表)
场地预约订单管理

**核心字段**:
- `venueId`: 场地ID
- `reservationDate`: 预约日期
- `startTime/endTime`: 时间段
- `participants`: 参与人员 (JSON)
- `purpose`: 使用目的

**业务规则**:
- 时间冲突检测 (唯一约束)
- 支持审批流程
- 参与人员管理

### 4. 用餐验证系统

#### dining_tables (餐桌表)
餐桌信息和状态管理

**核心字段**:
- `tableName/tableNumber`: 餐桌标识
- `maxCapacity/currentPeople`: 容量管理
- `qrCode/verificationCode`: 验证方式
- `status`: 餐桌状态

#### dining_verifications (用餐验证记录表)
用餐验证操作记录

**核心字段**:
- `userId/tableId`: 用户和餐桌
- `verificationMethod`: 验证方式 (qr_code/verification_code/manual)
- `orderId`: 关联订单
- `verifierId`: 验证员

**业务规则**:
- 多种验证方式支持
- 完整的验证记录
- 关联报餐订单

### 5. 系统管理

#### system_announcements (系统公告表)
系统公告和通知管理

**核心字段**:
- `title/content`: 公告内容
- `type/priority`: 类型和优先级
- `targetAudience`: 目标受众
- `publishTime/expireTime`: 发布和过期时间

#### activity_logs (活动日志表)
系统操作审计日志

**核心字段**:
- `userId/action/module`: 操作信息
- `resourceType/resourceId`: 操作资源
- `details`: 详细信息 (JSON)
- `ipAddress/userAgent`: 环境信息

#### file_uploads (文件上传表)
文件上传管理

**核心字段**:
- `fileName/filePath`: 文件信息
- `fileSize/mimeType`: 文件属性
- `uploaderId`: 上传者
- `category`: 文件分类

#### system_configs (系统配置表)
系统参数配置

**核心字段**:
- `configKey/configValue`: 配置键值
- `dataType`: 数据类型
- `isPublic/isEditable`: 访问控制

## 索引设计

### 主要索引策略

1. **主键索引**: 所有表使用UUID作为主键
2. **唯一索引**: 防止重复数据 (如用户openid、场地时间冲突)
3. **查询索引**: 基于常用查询字段建立复合索引
4. **外键索引**: 保证关联查询性能
5. **时间索引**: 支持时间范围查询

### 关键复合索引

- `idx_venue_time`: (venueId, reservationDate, startTime, endTime) - 场地时间冲突检测
- `idx_dining_date_meal`: (diningDate, mealType) - 报餐查询优化
- `idx_user_dept_role`: (department, role) - 用户权限查询
- `idx_log_time_user`: (createTime, userId) - 日志查询优化

## 数据关系图

```
departments (1:N) users (1:N) dining_orders
departments (1:N) special_reservations
users (1:N) user_tokens
users (1:N) reservations
users (1:N) dining_verifications
users (1:N) menus
venues (1:N) reservations
dining_tables (1:N) dining_verifications
menus (1:N) dining_orders
```

## 示例数据

初始化脚本包含以下示例数据:

- **部门**: 技术部、人事部、财务部
- **场地**: 羽毛球场、乒乓球台、篮球场
- **餐桌**: A区、B区各类餐桌
- **系统配置**: 基础业务参数

## 使用建议

### 1. 性能优化
- 定期分析慢查询，优化索引
- 大表考虑分区策略
- 适当使用读写分离

### 2. 数据维护
- 定期清理过期Token和验证码
- 归档历史日志数据
- 备份重要业务数据

### 3. 扩展建议
- 预留扩展字段满足业务发展
- 考虑缓存策略减少数据库压力
- 实现数据库连接池优化

### 4. 安全考虑
- 敏感数据加密存储
- 定期更新密码策略
- 监控异常操作日志

## 常见问题

### Q: 为什么使用UUID作为主键？
A: UUID避免主键冲突，便于分布式部署，增强安全性。

### Q: JSON字段的查询性能如何？
A: MySQL 5.7+对JSON有良好支持，适合存储结构化的扩展数据。

### Q: 如何处理数据库迁移？
A: 使用版本化的迁移脚本，确保数据结构变更的可控性。

### Q: 外键约束是否影响性能？
A: 适度的外键约束保证数据一致性，性能影响可接受。

---

**维护说明**: 本文档随数据库结构变更及时更新，确保与实际结构一致。
