# èœå•å¯¼å…¥é—®é¢˜è§£å†³æ–¹æ¡ˆ

## ğŸ“‹ é—®é¢˜æ€»ç»“

### 1. å‰ç«¯getTokenæœªå®šä¹‰é”™è¯¯
**é—®é¢˜**: `ä¸‹è½½æ¨¡æ¿å¤±è´¥: ReferenceError: getToken is not defined`

**åŸå› **: å‰ç«¯ä»£ç ä¸­ç¼ºå°‘`getToken`å‡½æ•°å®šä¹‰

**è§£å†³æ–¹æ¡ˆ**: 
- åˆ›å»ºäº†`/public/js/api-utils.js`æ–‡ä»¶ï¼Œæä¾›å®Œæ•´çš„APIå·¥å…·ç±»
- åŒ…å«`getToken`ã€`downloadFile`ã€`menuImportApi`ç­‰å‡½æ•°
- åˆ›å»ºäº†`/public/menu-import.html`é¡µé¢ï¼Œæä¾›å®Œæ•´çš„èœå•å¯¼å…¥ç•Œé¢

### 2. å¯¼å…¥å†å²APIé”™è¯¯
**é—®é¢˜**: `Incorrect arguments to mysqld_stmt_execute`

**åŸå› **: MySQL2ä¸æ”¯æŒå‚æ•°ç»‘å®š`LIMIT ? OFFSET ?`è¯­æ³•

**è§£å†³æ–¹æ¡ˆ**:
- ä¿®æ”¹SQLæŸ¥è¯¢ï¼Œå°†`pageSize`å’Œ`offset`ç›´æ¥åµŒå…¥SQLå­—ç¬¦ä¸²
- ä½¿ç”¨`JSON_EXTRACT(details, '$')`æ­£ç¡®æå–JSONå­—æ®µ
- ä¿®å¤detailså­—æ®µè§£æé€»è¾‘ï¼ˆå¯¹è±¡è€Œéå­—ç¬¦ä¸²ï¼‰

### 3. èœå•å¯¼å…¥å¤±è´¥é—®é¢˜
**é—®é¢˜**: æ‰¹é‡å¯¼å…¥éƒ¨åˆ†æˆåŠŸï¼Œ3ä¸ªæˆåŠŸï¼Œ3ä¸ªå¤±è´¥

**å¤±è´¥åŸå› **: `Duplicate entry 'breakfast' for key 'menus.uk_date_meal'`

**åˆ†æç»“æœ**:
- 2025-09-23çš„èœå•æˆåŠŸå¯¼å…¥ï¼ˆ3ä¸ªï¼‰
- 2025-09-24çš„èœå•å› é‡å¤è€Œå¤±è´¥ï¼ˆ3ä¸ªï¼‰
- æ•°æ®åº“ä¸­å·²å­˜åœ¨ç›¸åŒæ—¥æœŸå’Œé¤æ¬¡çš„èœå•è®°å½•

## ğŸ”§ è§£å†³æ–¹æ¡ˆ

### 1. å‰ç«¯ä¿®å¤
```javascript
// /public/js/api-utils.js
function getToken() {
  return localStorage.getItem('token');
}

// èœå•å¯¼å…¥API
const menuImportApi = {
  downloadTemplate: () => downloadFile('/admin/menu/import/template', `èœå•å¯¼å…¥æ¨¡æ¿_${new Date().toISOString().split('T')[0]}.xlsx`),
  uploadAndParseExcel: (file) => uploadFile('/admin/menu/import/parse', file, 'excel'),
  previewImportData: (data) => post('/admin/menu/import/preview', data),
  batchImportMenus: (data) => post('/admin/menu/import/execute', data),
  getImportHistory: (params = {}) => get('/admin/menu/import/history', params)
};
```

### 2. åç«¯APIä¿®å¤
```javascript
// ä¿®å¤SQLæŸ¥è¯¢
const [historyRows] = await req.db.execute(`
  SELECT
    _id,
    userId,
    action,
    resourceType,
    resourceId,
    JSON_EXTRACT(details, '$') as details,
    ipAddress,
    createTime
  FROM activity_logs
  WHERE userId = ? AND action = ?
  ORDER BY createTime DESC
  LIMIT ${parseInt(pageSize)} OFFSET ${offset}
`, [adminId, 'batch_import_menu']);

// ä¿®å¤detailsè§£æ
details = row.details || {}; // ä¸éœ€è¦JSON.parse
```

### 3. é‡å¤èœå•å¤„ç†
**é€‰é¡¹1: å¯ç”¨è¦†ç›–é€‰é¡¹**
```javascript
const response = await window.api.menuImportApi.batchImportMenus({
  menuData: currentParseData,
  options: {
    overwrite: true,  // å¯ç”¨è¦†ç›–
    allowPastDates: false,
    description: 'Webç•Œé¢å¯¼å…¥'
  }
});
```

**é€‰é¡¹2: åˆ é™¤é‡å¤èœå•**
- ä½¿ç”¨`/scripts/fix-duplicate-menus.js`è„šæœ¬
- æŒ‰é¤æ¬¡åˆ†ç»„ï¼Œä¿ç•™æœ€æ–°çš„èœå•è®°å½•

## ğŸ¯ åŠŸèƒ½ç‰¹æ€§

### âœ… å·²å®ç°åŠŸèƒ½
1. **Excelæ¨¡æ¿ä¸‹è½½** - æ”¯æŒæ ‡å‡†æ ¼å¼æ¨¡æ¿
2. **æ–‡ä»¶ä¸Šä¼ è§£æ** - æ”¯æŒ.xlsxå’Œ.xlsæ ¼å¼
3. **æ•°æ®é¢„è§ˆ** - å¯¼å…¥å‰é¢„è§ˆæ•°æ®
4. **æ‰¹é‡å¯¼å…¥** - æ”¯æŒä¸€å‘¨èœå•æ‰¹é‡å¯¼å…¥
5. **å¯¼å…¥å†å²** - å®Œæ•´çš„å¯¼å…¥è®°å½•å’Œç»Ÿè®¡
6. **é”™è¯¯å¤„ç†** - è¯¦ç»†çš„é”™è¯¯ä¿¡æ¯å’Œè§£å†³å»ºè®®
7. **å‰ç«¯ç•Œé¢** - å®Œæ•´çš„Webæ“ä½œç•Œé¢

### ğŸ”„ æ”¯æŒçš„ä½¿ç”¨åœºæ™¯
1. **å®Œæ•´ä¸€å‘¨èœå•** - 7å¤©Ã—3é¤æ¬¡=21ä¸ªèœå•
2. **å·¥ä½œæ—¥èœå•** - 5å¤©Ã—3é¤æ¬¡=15ä¸ªèœå•
3. **å•é¤æ¬¡å¯¼å…¥** - åªå¯¼å…¥æ—©é¤ã€ä¸­é¤æˆ–æ™šé¤
4. **ä»»æ„æ—¥æœŸ** - ä¸è¦æ±‚è¿ç»­æ—¥æœŸ
5. **è¦†ç›–å¯¼å…¥** - æ›¿æ¢ç°æœ‰èœå•

## ğŸ“Š æµ‹è¯•ç»“æœ

### å¯¼å…¥å†å²APIæµ‹è¯•
```json
{
  "success": true,
  "message": "è·å–å¯¼å…¥å†å²æˆåŠŸ",
  "data": {
    "list": [
      {
        "id": "585d5a54-2cc3-4eac-94b0-d66c49505c17",
        "importTime": "2025-09-16T19:05:12.000Z",
        "summary": {
          "totalMenus": 6,
          "failedCount": 3,
          "successCount": 3
        },
        "filename": "Excelå¯¼å…¥",
        "status": "failed",
        "ipAddress": "127.0.0.1"
      }
    ]
  }
}
```

### æ‰¹é‡å¯¼å…¥ç»“æœ
```json
{
  "success": true,
  "message": "æ‰¹é‡å¯¼å…¥éƒ¨åˆ†æˆåŠŸï¼ŒæˆåŠŸ 3 ä¸ªï¼Œå¤±è´¥ 3 ä¸ª",
  "data": {
    "summary": {
      "totalMenus": 6,
      "successCount": 3,
      "failedCount": 3
    },
    "success": [...],
    "failed": [...]
  }
}
```

## ğŸš€ ä½¿ç”¨æ–¹æ³•

### 1. è®¿é—®Webç•Œé¢
```
http://localhost:3000/menu-import.html
```

### 2. ä½¿ç”¨API
```javascript
// ä¸‹è½½æ¨¡æ¿
await window.api.menuImportApi.downloadTemplate();

// ä¸Šä¼ è§£æ
const result = await window.api.menuImportApi.uploadAndParseExcel(file);

// æ‰§è¡Œå¯¼å…¥
const importResult = await window.api.menuImportApi.batchImportMenus({
  menuData: parseData,
  options: { overwrite: true }
});

// æŸ¥çœ‹å†å²
const history = await window.api.menuImportApi.getImportHistory();
```

## ğŸ“ æ³¨æ„äº‹é¡¹

1. **é‡å¤èœå•**: å¯¼å…¥å‰æ£€æŸ¥æ˜¯å¦æœ‰é‡å¤çš„æ—¥æœŸå’Œé¤æ¬¡
2. **æ–‡ä»¶æ ¼å¼**: ç¡®ä¿Excelæ–‡ä»¶æ ¼å¼æ­£ç¡®
3. **æƒé™è¦æ±‚**: éœ€è¦ç®¡ç†å‘˜æƒé™
4. **æ•°æ®éªŒè¯**: ç³»ç»Ÿä¼šè‡ªåŠ¨éªŒè¯èœå“å’Œåˆ†ç±»æ˜¯å¦å­˜åœ¨
5. **é”™è¯¯å¤„ç†**: æŸ¥çœ‹è¯¦ç»†çš„é”™è¯¯ä¿¡æ¯è¿›è¡Œé—®é¢˜æ’æŸ¥

## ğŸ” æ•…éšœæ’é™¤

### å¸¸è§é—®é¢˜
1. **getTokenæœªå®šä¹‰** â†’ ç¡®ä¿åŠ è½½äº†`/js/api-utils.js`
2. **å¯¼å…¥å¤±è´¥** â†’ æ£€æŸ¥æ˜¯å¦æœ‰é‡å¤èœå•ï¼Œå¯ç”¨è¦†ç›–é€‰é¡¹
3. **è§£æå¤±è´¥** â†’ æ£€æŸ¥Excelæ–‡ä»¶æ ¼å¼å’Œå†…å®¹
4. **æƒé™é”™è¯¯** â†’ ç¡®ä¿ä½¿ç”¨ç®¡ç†å‘˜è´¦å·ç™»å½•

### è°ƒè¯•å·¥å…·
- `/scripts/analyze-import-failures.js` - åˆ†æå¯¼å…¥å¤±è´¥åŸå› 
- `/scripts/fix-duplicate-menus.js` - ä¿®å¤é‡å¤èœå•
- `/scripts/debug-import-history.js` - è°ƒè¯•å¯¼å…¥å†å²æ•°æ®
