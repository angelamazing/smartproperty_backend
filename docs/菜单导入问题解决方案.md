# 菜单导入问题解决方案

## 📋 问题总结

### 1. 前端getToken未定义错误
**问题**: `下载模板失败: ReferenceError: getToken is not defined`

**原因**: 前端代码中缺少`getToken`函数定义

**解决方案**: 
- 创建了`/public/js/api-utils.js`文件，提供完整的API工具类
- 包含`getToken`、`downloadFile`、`menuImportApi`等函数
- 创建了`/public/menu-import.html`页面，提供完整的菜单导入界面

### 2. 导入历史API错误
**问题**: `Incorrect arguments to mysqld_stmt_execute`

**原因**: MySQL2不支持参数绑定`LIMIT ? OFFSET ?`语法

**解决方案**:
- 修改SQL查询，将`pageSize`和`offset`直接嵌入SQL字符串
- 使用`JSON_EXTRACT(details, '$')`正确提取JSON字段
- 修复details字段解析逻辑（对象而非字符串）

### 3. 菜单导入失败问题
**问题**: 批量导入部分成功，3个成功，3个失败

**失败原因**: `Duplicate entry 'breakfast' for key 'menus.uk_date_meal'`

**分析结果**:
- 2025-09-23的菜单成功导入（3个）
- 2025-09-24的菜单因重复而失败（3个）
- 数据库中已存在相同日期和餐次的菜单记录

## 🔧 解决方案

### 1. 前端修复
```javascript
// /public/js/api-utils.js
function getToken() {
  return localStorage.getItem('token');
}

// 菜单导入API
const menuImportApi = {
  downloadTemplate: () => downloadFile('/admin/menu/import/template', `菜单导入模板_${new Date().toISOString().split('T')[0]}.xlsx`),
  uploadAndParseExcel: (file) => uploadFile('/admin/menu/import/parse', file, 'excel'),
  previewImportData: (data) => post('/admin/menu/import/preview', data),
  batchImportMenus: (data) => post('/admin/menu/import/execute', data),
  getImportHistory: (params = {}) => get('/admin/menu/import/history', params)
};
```

### 2. 后端API修复
```javascript
// 修复SQL查询
const [historyRows] = await req.db.execute(`
  SELECT
    _id,
    userId,
    action,
    resourceType,
    resourceId,
    JSON_EXTRACT(details, '$') as details,
    ipAddress,
    createTime
  FROM activity_logs
  WHERE userId = ? AND action = ?
  ORDER BY createTime DESC
  LIMIT ${parseInt(pageSize)} OFFSET ${offset}
`, [adminId, 'batch_import_menu']);

// 修复details解析
details = row.details || {}; // 不需要JSON.parse
```

### 3. 重复菜单处理
**选项1: 启用覆盖选项**
```javascript
const response = await window.api.menuImportApi.batchImportMenus({
  menuData: currentParseData,
  options: {
    overwrite: true,  // 启用覆盖
    allowPastDates: false,
    description: 'Web界面导入'
  }
});
```

**选项2: 删除重复菜单**
- 使用`/scripts/fix-duplicate-menus.js`脚本
- 按餐次分组，保留最新的菜单记录

## 🎯 功能特性

### ✅ 已实现功能
1. **Excel模板下载** - 支持标准格式模板
2. **文件上传解析** - 支持.xlsx和.xls格式
3. **数据预览** - 导入前预览数据
4. **批量导入** - 支持一周菜单批量导入
5. **导入历史** - 完整的导入记录和统计
6. **错误处理** - 详细的错误信息和解决建议
7. **前端界面** - 完整的Web操作界面

### 🔄 支持的使用场景
1. **完整一周菜单** - 7天×3餐次=21个菜单
2. **工作日菜单** - 5天×3餐次=15个菜单
3. **单餐次导入** - 只导入早餐、中餐或晚餐
4. **任意日期** - 不要求连续日期
5. **覆盖导入** - 替换现有菜单

## 📊 测试结果

### 导入历史API测试
```json
{
  "success": true,
  "message": "获取导入历史成功",
  "data": {
    "list": [
      {
        "id": "585d5a54-2cc3-4eac-94b0-d66c49505c17",
        "importTime": "2025-09-16T19:05:12.000Z",
        "summary": {
          "totalMenus": 6,
          "failedCount": 3,
          "successCount": 3
        },
        "filename": "Excel导入",
        "status": "failed",
        "ipAddress": "127.0.0.1"
      }
    ]
  }
}
```

### 批量导入结果
```json
{
  "success": true,
  "message": "批量导入部分成功，成功 3 个，失败 3 个",
  "data": {
    "summary": {
      "totalMenus": 6,
      "successCount": 3,
      "failedCount": 3
    },
    "success": [...],
    "failed": [...]
  }
}
```

## 🚀 使用方法

### 1. 访问Web界面
```
http://localhost:3000/menu-import.html
```

### 2. 使用API
```javascript
// 下载模板
await window.api.menuImportApi.downloadTemplate();

// 上传解析
const result = await window.api.menuImportApi.uploadAndParseExcel(file);

// 执行导入
const importResult = await window.api.menuImportApi.batchImportMenus({
  menuData: parseData,
  options: { overwrite: true }
});

// 查看历史
const history = await window.api.menuImportApi.getImportHistory();
```

## 📝 注意事项

1. **重复菜单**: 导入前检查是否有重复的日期和餐次
2. **文件格式**: 确保Excel文件格式正确
3. **权限要求**: 需要管理员权限
4. **数据验证**: 系统会自动验证菜品和分类是否存在
5. **错误处理**: 查看详细的错误信息进行问题排查

## 🔍 故障排除

### 常见问题
1. **getToken未定义** → 确保加载了`/js/api-utils.js`
2. **导入失败** → 检查是否有重复菜单，启用覆盖选项
3. **解析失败** → 检查Excel文件格式和内容
4. **权限错误** → 确保使用管理员账号登录

### 调试工具
- `/scripts/analyze-import-failures.js` - 分析导入失败原因
- `/scripts/fix-duplicate-menus.js` - 修复重复菜单
- `/scripts/debug-import-history.js` - 调试导入历史数据
