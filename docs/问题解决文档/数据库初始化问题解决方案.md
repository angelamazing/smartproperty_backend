# æ•°æ®åº“åˆå§‹åŒ–é—®é¢˜è§£å†³æ–¹æ¡ˆ

## ğŸš¨ é—®é¢˜æè¿°

é‡åˆ°é”™è¯¯ï¼š`This command is not supported in the prepared statement protocol yet`

è¿™ä¸ªé”™è¯¯æ˜¯å› ä¸ºæŸäº›SQLå‘½ä»¤ï¼ˆå¦‚`CREATE DATABASE`ã€`USE`ã€`SHOW TABLES`ç­‰ï¼‰ä¸èƒ½åœ¨MySQLçš„prepared statementä¸­æ‰§è¡Œã€‚

## âœ… è§£å†³æ–¹æ¡ˆ

### æ–¹æ¡ˆ1ï¼šä½¿ç”¨ç®€åŒ–åˆå§‹åŒ–è„šæœ¬ï¼ˆæ¨èï¼‰

```bash
# ä½¿ç”¨ä¿®å¤åçš„ç®€åŒ–è„šæœ¬
npm run init-db-simple
```

è¿™ä¸ªè„šæœ¬ï¼š
- âœ… ä½¿ç”¨ `connection.query()` ä»£æ›¿ `connection.execute()`
- âœ… æ­£ç¡®å¤„ç†æ•°æ®åº“åˆ›å»ºå’Œè¿æ¥
- âœ… åˆ›å»ºæ ¸å¿ƒè¡¨ç»“æ„ï¼ˆusers, user_tokens, verification_codesï¼‰
- âœ… åŒ…å«æµ‹è¯•ç”¨æˆ·å­—æ®µï¼ˆisTestUser, isAdminTest, isSysAdminTestï¼‰

### æ–¹æ¡ˆ2ï¼šä½¿ç”¨åŸæœ‰è„šæœ¬

```bash
# å¦‚æœåŸæœ‰è„šæœ¬æ²¡é—®é¢˜ï¼Œå¯ä»¥ç»§ç»­ä½¿ç”¨
npm run init-db
```

### æ–¹æ¡ˆ3ï¼šæ‰‹åŠ¨æ•°æ®åº“æ“ä½œ

å¦‚æœè„šæœ¬ä»æœ‰é—®é¢˜ï¼Œå¯ä»¥æ‰‹åŠ¨æ‰§è¡Œï¼š

```sql
-- 1. è¿æ¥MySQL
mysql -h mysql-demo-mysql.ns-gpaauglf.svc -u root -p54bxhv99

-- 2. åˆ›å»ºæ•°æ®åº“
CREATE DATABASE IF NOT EXISTS smart_property CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci;

-- 3. ä½¿ç”¨æ•°æ®åº“
USE smart_property;

-- 4. åˆ›å»ºç”¨æˆ·è¡¨ï¼ˆåŒ…å«æµ‹è¯•ç”¨æˆ·å­—æ®µï¼‰
CREATE TABLE IF NOT EXISTS users (
  _id VARCHAR(36) PRIMARY KEY,
  openid VARCHAR(100) UNIQUE,
  unionid VARCHAR(100),
  nickName VARCHAR(100) NOT NULL,
  avatarUrl TEXT,
  phoneNumber VARCHAR(11) UNIQUE,
  email VARCHAR(100),
  gender TINYINT DEFAULT 0,
  country VARCHAR(50),
  province VARCHAR(50),
  city VARCHAR(50),
  language VARCHAR(20) DEFAULT 'zh_CN',
  department VARCHAR(100),
  role ENUM('user', 'dept_admin', 'sys_admin', 'verifier') DEFAULT 'user',
  status ENUM('active', 'inactive') DEFAULT 'active',
  createTime TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  updateTime TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  lastLoginTime TIMESTAMP NULL,
  isTestUser BOOLEAN DEFAULT FALSE,
  isAdminTest BOOLEAN DEFAULT FALSE,
  isSysAdminTest BOOLEAN DEFAULT FALSE,
  
  INDEX idx_openid (openid),
  INDEX idx_phone (phoneNumber),
  INDEX idx_role (role),
  INDEX idx_test_users (isTestUser, isAdminTest, isSysAdminTest)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;

-- 5. éªŒè¯è¡¨åˆ›å»º
SHOW TABLES;
DESCRIBE users;
```

## ğŸ”„ å®Œæ•´åˆå§‹åŒ–æµç¨‹

### æ­¥éª¤1ï¼šåŸºç¡€ç»“æ„åˆå§‹åŒ–
```bash
npm run init-db-simple
```

### æ­¥éª¤2ï¼šéªŒè¯åŸºç¡€ç»“æ„
```bash
# æ£€æŸ¥æœåŠ¡æ˜¯å¦èƒ½å¯åŠ¨
npm run dev
```

### æ­¥éª¤3ï¼šæµ‹è¯•æ ¸å¿ƒåŠŸèƒ½
```bash
# æµ‹è¯•æµ‹è¯•ç™»å½•æ¥å£
npm run test-interfaces
```

### æ­¥éª¤4ï¼šå¯é€‰çš„å®Œæ•´åˆå§‹åŒ–
```bash
# å¦‚æœéœ€è¦å®Œæ•´çš„è¡¨ç»“æ„å’Œç¤ºä¾‹æ•°æ®
npm run init-db-complete
```

## ğŸ› ï¸ æ•…éšœæ’æŸ¥

### æ£€æŸ¥æ•°æ®åº“è¿æ¥
```bash
# æµ‹è¯•æ•°æ®åº“è¿æ¥
mysql -h mysql-demo-mysql.ns-gpaauglf.svc -u root -p54bxhv99 -e "SELECT 1"
```

### æ£€æŸ¥é…ç½®æ–‡ä»¶
```bash
# æŸ¥çœ‹æ•°æ®åº“é…ç½®
cat config/database.js
```

### æŸ¥çœ‹è¯¦ç»†é”™è¯¯ä¿¡æ¯
```bash
# æŸ¥çœ‹æ—¥å¿—
tail -f logs/error.log
tail -f logs/combined.log
```

## ğŸ“ ä¿®å¤å†…å®¹è¯´æ˜

### ä¸»è¦ä¿®æ”¹ç‚¹

1. **åˆ›å»ºæ•°æ®åº“å‡½æ•°**ï¼š
   - æ”¹ç”¨ `connection.query()` æ‰§è¡ŒDDLè¯­å¥
   - åˆ†ç¦»æ•°æ®åº“åˆ›å»ºå’Œè¿æ¥æ­¥éª¤

2. **è¡¨ç»“æ„åˆ›å»º**ï¼š
   - ç¡®ä¿åŒ…å«æ‰€æœ‰æµ‹è¯•ç”¨æˆ·å­—æ®µ
   - ä½¿ç”¨æ­£ç¡®çš„ç´¢å¼•è®¾ç½®

3. **éªŒè¯å‡½æ•°**ï¼š
   - æ”¹ç”¨ `connection.query()` æ‰§è¡ŒæŸ¥è¯¢è¯­å¥
   - æ·»åŠ å­—æ®µå­˜åœ¨æ€§æ£€æŸ¥

### æ–°å¢è„šæœ¬åŠŸèƒ½

- `initDatabase-simple.js`ï¼šä¸“é—¨è§£å†³prepared statementé—®é¢˜
- æ›´å®‰å…¨çš„é”™è¯¯å¤„ç†
- è¯¦ç»†çš„éªŒè¯æ­¥éª¤

## ğŸ¯ æ¨èä½¿ç”¨é¡ºåº

1. **å¿«é€Ÿè§£å†³**ï¼š`npm run init-db-simple`
2. **éªŒè¯åŠŸèƒ½**ï¼šå¯åŠ¨æœåŠ¡å¹¶æµ‹è¯•æ¥å£
3. **å®Œæ•´åŠŸèƒ½**ï¼šå¦‚éœ€è¦ï¼Œå†è¿è¡Œå®Œæ•´åˆå§‹åŒ–

## ğŸš€ éªŒè¯æˆåŠŸæ ‡å¿—

åˆå§‹åŒ–æˆåŠŸåï¼Œåº”è¯¥çœ‹åˆ°ï¼š

```
âœ… æ•°æ®åº“ smart_property åˆ›å»ºæˆåŠŸ
âœ… ç”¨æˆ·è¡¨åˆ›å»ºæˆåŠŸ
âœ… ç”¨æˆ·ä»¤ç‰Œè¡¨åˆ›å»ºæˆåŠŸ
âœ… éªŒè¯ç è¡¨åˆ›å»ºæˆåŠŸ
âœ… ç”¨æˆ·è¡¨å­—æ®µæ£€æŸ¥:
   - isTestUser: âœ… å­˜åœ¨
   - isAdminTest: âœ… å­˜åœ¨
   - isSysAdminTest: âœ… å­˜åœ¨
âœ… æ•°æ®åº“åˆå§‹åŒ–å®Œæˆï¼
```

ç„¶åæµ‹è¯•æ¥å£ï¼š
```bash
curl -X POST http://localhost:3000/api/auth/test-login-admin
```

åº”è¯¥è¿”å›æˆåŠŸå“åº”è€Œä¸æ˜¯æ•°æ®åº“å­—æ®µé”™è¯¯ã€‚

---

**æ€»ç»“**ï¼šä½¿ç”¨ `npm run init-db-simple` å¯ä»¥å¿«é€Ÿè§£å†³prepared statementé—®é¢˜ï¼Œç¡®ä¿æµ‹è¯•æ¥å£æ­£å¸¸å·¥ä½œã€‚
