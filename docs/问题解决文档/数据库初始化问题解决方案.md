# 数据库初始化问题解决方案

## 🚨 问题描述

遇到错误：`This command is not supported in the prepared statement protocol yet`

这个错误是因为某些SQL命令（如`CREATE DATABASE`、`USE`、`SHOW TABLES`等）不能在MySQL的prepared statement中执行。

## ✅ 解决方案

### 方案1：使用简化初始化脚本（推荐）

```bash
# 使用修复后的简化脚本
npm run init-db-simple
```

这个脚本：
- ✅ 使用 `connection.query()` 代替 `connection.execute()`
- ✅ 正确处理数据库创建和连接
- ✅ 创建核心表结构（users, user_tokens, verification_codes）
- ✅ 包含测试用户字段（isTestUser, isAdminTest, isSysAdminTest）

### 方案2：使用原有脚本

```bash
# 如果原有脚本没问题，可以继续使用
npm run init-db
```

### 方案3：手动数据库操作

如果脚本仍有问题，可以手动执行：

```sql
-- 1. 连接MySQL
mysql -h mysql-demo-mysql.ns-gpaauglf.svc -u root -p54bxhv99

-- 2. 创建数据库
CREATE DATABASE IF NOT EXISTS smart_property CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci;

-- 3. 使用数据库
USE smart_property;

-- 4. 创建用户表（包含测试用户字段）
CREATE TABLE IF NOT EXISTS users (
  _id VARCHAR(36) PRIMARY KEY,
  openid VARCHAR(100) UNIQUE,
  unionid VARCHAR(100),
  nickName VARCHAR(100) NOT NULL,
  avatarUrl TEXT,
  phoneNumber VARCHAR(11) UNIQUE,
  email VARCHAR(100),
  gender TINYINT DEFAULT 0,
  country VARCHAR(50),
  province VARCHAR(50),
  city VARCHAR(50),
  language VARCHAR(20) DEFAULT 'zh_CN',
  department VARCHAR(100),
  role ENUM('user', 'dept_admin', 'sys_admin', 'verifier') DEFAULT 'user',
  status ENUM('active', 'inactive') DEFAULT 'active',
  createTime TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  updateTime TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  lastLoginTime TIMESTAMP NULL,
  isTestUser BOOLEAN DEFAULT FALSE,
  isAdminTest BOOLEAN DEFAULT FALSE,
  isSysAdminTest BOOLEAN DEFAULT FALSE,
  
  INDEX idx_openid (openid),
  INDEX idx_phone (phoneNumber),
  INDEX idx_role (role),
  INDEX idx_test_users (isTestUser, isAdminTest, isSysAdminTest)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;

-- 5. 验证表创建
SHOW TABLES;
DESCRIBE users;
```

## 🔄 完整初始化流程

### 步骤1：基础结构初始化
```bash
npm run init-db-simple
```

### 步骤2：验证基础结构
```bash
# 检查服务是否能启动
npm run dev
```

### 步骤3：测试核心功能
```bash
# 测试测试登录接口
npm run test-interfaces
```

### 步骤4：可选的完整初始化
```bash
# 如果需要完整的表结构和示例数据
npm run init-db-complete
```

## 🛠️ 故障排查

### 检查数据库连接
```bash
# 测试数据库连接
mysql -h mysql-demo-mysql.ns-gpaauglf.svc -u root -p54bxhv99 -e "SELECT 1"
```

### 检查配置文件
```bash
# 查看数据库配置
cat config/database.js
```

### 查看详细错误信息
```bash
# 查看日志
tail -f logs/error.log
tail -f logs/combined.log
```

## 📝 修复内容说明

### 主要修改点

1. **创建数据库函数**：
   - 改用 `connection.query()` 执行DDL语句
   - 分离数据库创建和连接步骤

2. **表结构创建**：
   - 确保包含所有测试用户字段
   - 使用正确的索引设置

3. **验证函数**：
   - 改用 `connection.query()` 执行查询语句
   - 添加字段存在性检查

### 新增脚本功能

- `initDatabase-simple.js`：专门解决prepared statement问题
- 更安全的错误处理
- 详细的验证步骤

## 🎯 推荐使用顺序

1. **快速解决**：`npm run init-db-simple`
2. **验证功能**：启动服务并测试接口
3. **完整功能**：如需要，再运行完整初始化

## 🚀 验证成功标志

初始化成功后，应该看到：

```
✅ 数据库 smart_property 创建成功
✅ 用户表创建成功
✅ 用户令牌表创建成功
✅ 验证码表创建成功
✅ 用户表字段检查:
   - isTestUser: ✅ 存在
   - isAdminTest: ✅ 存在
   - isSysAdminTest: ✅ 存在
✅ 数据库初始化完成！
```

然后测试接口：
```bash
curl -X POST http://localhost:3000/api/auth/test-login-admin
```

应该返回成功响应而不是数据库字段错误。

---

**总结**：使用 `npm run init-db-simple` 可以快速解决prepared statement问题，确保测试接口正常工作。
