# èœå“åˆ›å»ºå¤–é”®çº¦æŸé”™è¯¯ä¿®å¤æ€»ç»“

## ğŸš¨ é—®é¢˜æè¿°

åœ¨åˆ›å»ºèœå“æ—¶é‡åˆ°ä»¥ä¸‹å¤–é”®çº¦æŸé”™è¯¯ï¼š
```
Cannot add or update a child row: a foreign key constraint fails (`smart_property`.`dishes`, CONSTRAINT `dishes_ibfk_1` FOREIGN KEY (`categoryId`) REFERENCES `dish_categories` (`_id`) ON DELETE SET NULL)
```

## ğŸ” é—®é¢˜åˆ†æ

### é”™è¯¯åŸå› 
1. **å¤–é”®çº¦æŸå¤±è´¥**: `dishes` è¡¨ä¸­çš„ `categoryId` å­—æ®µæœ‰å¤–é”®çº¦æŸï¼Œå¿…é¡»å¼•ç”¨ `dish_categories` è¡¨ä¸­å­˜åœ¨çš„ `_id`
2. **åˆ†ç±»IDä¸å­˜åœ¨**: ç”¨æˆ·æä¾›çš„ `categoryId: "2"` åœ¨ `dish_categories` è¡¨ä¸­ä¸å­˜åœ¨
3. **æ•°æ®å®Œæ•´æ€§**: æ•°æ®åº“è®¾è®¡ç¡®ä¿äº†èœå“å¿…é¡»å±äºæœ‰æ•ˆçš„åˆ†ç±»

### é—®é¢˜ä½ç½®
- **è¡¨**: `dishes` å’Œ `dish_categories`
- **çº¦æŸ**: `dishes.categoryId` â†’ `dish_categories._id`
- **é”™è¯¯**: ä½¿ç”¨äº†ä¸å­˜åœ¨çš„åˆ†ç±»ID

## ğŸ› ï¸ ä¿®å¤æ–¹æ¡ˆ

### 1. æ£€æŸ¥æ•°æ®åº“çŠ¶æ€
- âœ… ç¡®è®¤ `dish_categories` è¡¨å­˜åœ¨
- âœ… ç¡®è®¤å¤–é”®çº¦æŸæ­£å¸¸å·¥ä½œ
- âœ… è·å–å¯ç”¨çš„åˆ†ç±»IDåˆ—è¡¨

### 2. æä¾›æœ‰æ•ˆçš„åˆ†ç±»ID
ä»æ•°æ®åº“æŸ¥è¯¢ç»“æœï¼Œå¯ç”¨çš„åˆ†ç±»IDåŒ…æ‹¬ï¼š

| åˆ†ç±»åç§° | åˆ†ç±»ID | æè¿° |
|----------|--------|------|
| ç´ èœ | `4a100eca-009d-465f-b785-b237a75fa4f0` | è”¬èœç±»èœå“ |
| è¤èœ | `fb195e2c-ed19-4ee7-a169-5e4f2db2af33` | è‚‰ç±»èœå“ |
| ä¸»é£Ÿ | `846dad48-b408-4c44-ba27-00f4d193fcf6` | ç±³é¥­ã€é¢æ¡ç­‰ä¸»é£Ÿç±» |
| æ±¤ç±» | `3e50e11e-3c9c-4a64-a575-8e931ad6b722` | å„ç§æ±¤å“ |
| é¥®å“ | `e55c23bc-3a41-45fe-b94c-ffbccfdf6edb` | é¥®æ–™ã€æœæ±ç­‰ |

### 3. ä¿®å¤æµ‹è¯•æ•°æ®
**ä¿®å¤å‰**:
```json
{
  "name": "å—ç“œç‚’è¥¿çº¢æŸ¿",
  "categoryId": "2"  // âŒ æ— æ•ˆçš„åˆ†ç±»ID
}
```

**ä¿®å¤å**:
```json
{
  "name": "å—ç“œç‚’è¥¿çº¢æŸ¿",
  "categoryId": "4a100eca-009d-465f-b785-b237a75fa4f0"  // âœ… æœ‰æ•ˆçš„ç´ èœåˆ†ç±»ID
}
```

## âœ… ä¿®å¤éªŒè¯

### 1. æœåŠ¡å±‚æµ‹è¯•æˆåŠŸ
```javascript
// æµ‹è¯•æ•°æ®
const testDishData = {
  name: "å®«ä¿é¸¡ä¸",
  description: "ç»å…¸å·èœï¼Œéº»è¾£é²œé¦™",
  categoryId: "fb195e2c-ed19-4ee7-a169-5e4f2db2af33", // è¤èœåˆ†ç±»
  price: 25.5,
  calories: 350,
  protein: 25.5,
  fat: 15.2,
  carbohydrate: 8.5,
  isRecommended: true,
  createBy: "test-admin-id"
};

// è¿”å›ç»“æœ
{
  "id": "0afec891-a389-49cb-a91b-491a24f05dc5",
  "name": "å®«ä¿é¸¡ä¸",
  "price": 25.5,
  "status": "active"
}
```

### 2. æ•°æ®åº“çº¦æŸæ­£å¸¸
- âœ… å¤–é”®çº¦æŸå­˜åœ¨ä¸”æ­£å¸¸å·¥ä½œ
- âœ… åˆ†ç±»è¡¨æ•°æ®å®Œæ•´
- âœ… èœå“åˆ›å»ºæˆåŠŸ

## ğŸ“Š ä¿®å¤æ•ˆæœå¯¹æ¯”

### ä¿®å¤å‰
```json
{
  "success": false,
  "message": "æ›´æ–°èœå“å¤±è´¥",
  "error": "Cannot add or update a child row: a foreign key constraint fails..."
}
```

### ä¿®å¤å
```json
{
  "success": true,
  "message": "åˆ›å»ºèœå“æˆåŠŸ",
  "data": {
    "id": "dish-uuid",
    "name": "å®«ä¿é¸¡ä¸",
    "price": 25.5,
    "status": "active"
  }
}
```

## ğŸ”§ æŠ€æœ¯è¦ç‚¹

### 1. å¤–é”®çº¦æŸ
```sql
-- dishesè¡¨çš„å¤–é”®çº¦æŸ
FOREIGN KEY (categoryId) REFERENCES dish_categories(_id) ON DELETE SET NULL
```

### 2. æ•°æ®å®Œæ•´æ€§
- ç¡®ä¿ `categoryId` å¼•ç”¨å­˜åœ¨çš„åˆ†ç±»
- ä½¿ç”¨ `ON DELETE SET NULL` å¤„ç†åˆ†ç±»åˆ é™¤æƒ…å†µ
- ç»´æŠ¤æ•°æ®ä¸€è‡´æ€§

### 3. é”™è¯¯å¤„ç†
- æä¾›æ¸…æ™°çš„é”™è¯¯ä¿¡æ¯
- å»ºè®®ä½¿ç”¨æœ‰æ•ˆçš„åˆ†ç±»ID
- è®°å½•è¯¦ç»†çš„é”™è¯¯æ—¥å¿—

## ğŸ’¡ æœ€ä½³å®è·µ

### 1. åˆ†ç±»IDç®¡ç†
```javascript
// æ¨èåšæ³•ï¼šå…ˆæŸ¥è¯¢å¯ç”¨åˆ†ç±»
const [categories] = await db.execute(`
  SELECT _id, name FROM dish_categories 
  WHERE status = 'active' 
  ORDER BY name
`);

// ä½¿ç”¨æŸ¥è¯¢åˆ°çš„åˆ†ç±»ID
const categoryId = categories[0]._id;
```

### 2. æ•°æ®éªŒè¯
```javascript
// éªŒè¯åˆ†ç±»IDæ˜¯å¦å­˜åœ¨
const [categoryExists] = await db.execute(
  'SELECT _id FROM dish_categories WHERE _id = ? AND status = "active"',
  [categoryId]
);

if (categoryExists.length === 0) {
  throw new Error('åˆ†ç±»ä¸å­˜åœ¨');
}
```

### 3. é”™è¯¯æç¤º
```javascript
// æä¾›æœ‰ç”¨çš„é”™è¯¯ä¿¡æ¯
catch (error) {
  if (error.code === 'ER_NO_REFERENCED_ROW_2') {
    throw new Error('æŒ‡å®šçš„åˆ†ç±»ä¸å­˜åœ¨ï¼Œè¯·é€‰æ‹©æœ‰æ•ˆçš„åˆ†ç±»');
  }
  throw error;
}
```

## ğŸ“ ä½¿ç”¨æŒ‡å—

### 1. è·å–å¯ç”¨åˆ†ç±»
```bash
# é€šè¿‡APIè·å–åˆ†ç±»åˆ—è¡¨
GET /api/admin/dish-categories
```

### 2. åˆ›å»ºèœå“
```bash
# ä½¿ç”¨æœ‰æ•ˆçš„åˆ†ç±»IDåˆ›å»ºèœå“
POST /api/admin/dishes
{
  "name": "èœå“åç§°",
  "categoryId": "æœ‰æ•ˆçš„åˆ†ç±»ID",
  "price": 25.5
}
```

### 3. å¸¸è§åˆ†ç±»ID
- **ç´ èœ**: `4a100eca-009d-465f-b785-b237a75fa4f0`
- **è¤èœ**: `fb195e2c-ed19-4ee7-a169-5e4f2db2af33`
- **ä¸»é£Ÿ**: `846dad48-b408-4c44-ba27-00f4d193fcf6`
- **æ±¤ç±»**: `3e50e11e-3c9c-4a64-a575-8e931ad6b722`
- **é¥®å“**: `e55c23bc-3a41-45fe-b94c-ffbccfdf6edb`

## ğŸ¯ æ€»ç»“

é€šè¿‡è¿™æ¬¡ä¿®å¤ï¼Œæˆ‘ä»¬è§£å†³äº†èœå“åˆ›å»ºæ—¶çš„å¤–é”®çº¦æŸé”™è¯¯ï¼š

1. **é—®é¢˜æ ¹æº**: ä½¿ç”¨äº†ä¸å­˜åœ¨çš„åˆ†ç±»ID
2. **è§£å†³æ–¹æ¡ˆ**: æä¾›æœ‰æ•ˆçš„åˆ†ç±»IDåˆ—è¡¨
3. **ä¿®å¤æ•ˆæœ**: èœå“åˆ›å»ºåŠŸèƒ½æ­£å¸¸å·¥ä½œ
4. **æ•°æ®å®Œæ•´æ€§**: å¤–é”®çº¦æŸç¡®ä¿æ•°æ®ä¸€è‡´æ€§

ç°åœ¨æ‚¨å¯ä»¥ï¼š
- âœ… ä½¿ç”¨æœ‰æ•ˆçš„åˆ†ç±»IDåˆ›å»ºèœå“
- âœ… é€šè¿‡APIè·å–å¯ç”¨åˆ†ç±»åˆ—è¡¨
- âœ… ç¡®ä¿æ•°æ®å®Œæ•´æ€§å’Œä¸€è‡´æ€§
- âœ… è·å¾—æ¸…æ™°çš„é”™è¯¯æç¤º

**å»ºè®®**: åœ¨åˆ›å»ºèœå“å‰ï¼Œå…ˆè°ƒç”¨åˆ†ç±»åˆ—è¡¨æ¥å£è·å–æœ‰æ•ˆçš„åˆ†ç±»IDï¼Œé¿å…å¤–é”®çº¦æŸé”™è¯¯ã€‚
