# 数据库崩溃问题解决方案

## 问题描述

应用程序启动时崩溃，错误信息：
```
{
    "success": false,
    "message": "部门管理员测试登录失败",
    "error": "Table 'smart_property.users' doesn't exist"
}
```

## 问题根因

数据库中缺少基础的 `users` 表，导致应用程序在尝试查询用户信息时失败。

## 解决步骤

### 1. 诊断问题
- ✅ 确认应用程序崩溃原因：缺少 `users` 表
- ✅ 检查数据库连接配置：正常
- ✅ 确认错误日志信息：Table 'smart_property.users' doesn't exist

### 2. 数据库初始化
运行完整数据库初始化脚本：
```bash
node scripts/initDatabase-complete.js init
```

**创建的表包括：**
- ✅ system_configs (系统配置表)
- ✅ verification_codes (验证码表)
- ✅ dining_tables (餐桌表)
- ✅ departments (部门表)
- ✅ users (用户表) ⭐ **关键表**
- ✅ user_tokens (用户令牌表)
- ✅ menus (菜单表)
- ✅ dining_orders (报餐记录表)
- ✅ special_reservations (特殊预约表)
- ✅ venues (场地表)
- ✅ reservations (场地预约表)
- ✅ dining_verifications (用餐验证记录表)
- ✅ system_announcements (系统公告表)
- ✅ activity_logs (活动日志表)
- ✅ file_uploads (文件上传表)

**插入的示例数据：**
- ✅ 部门: 3 条 (技术部、人事部、财务部)
- ✅ 场地: 3 条 (羽毛球场A、乒乓球台1号、篮球场)
- ✅ 餐桌: 3 条 (A区01号桌、A区02号桌、B区01号桌)
- ✅ 配置: 4 条 (系统配置项)

### 3. 创建测试管理员用户
运行用户创建脚本：
```bash
node scripts/create-test-admin.js
```

**创建的测试用户：**
- ✅ 部门管理员测试 (手机号: 13800000001, 角色: dept_admin)
- ✅ 系统管理员测试 (手机号: 13800000002, 角色: sys_admin)

### 4. 启动服务器
```bash
npm run dev
```

服务器状态：✅ 正常运行在端口 3000

### 5. 验证修复结果

**健康检查：**
```bash
curl http://localhost:3000/health
```
响应：
```json
{
  "success": true,
  "message": "服务运行正常",
  "timestamp": "2025-08-27T10:02:20.589Z",
  "database": "已连接"
}
```

**部门管理员登录测试：**
```bash
curl -X POST http://localhost:3000/api/auth/test-login \
  -H "Content-Type: application/json" \
  -d '{"phoneNumber": "13800000001", "role": "dept_admin"}'
```
响应：✅ 登录成功，返回有效Token

**系统管理员登录测试：**
```bash
curl -X POST http://localhost:3000/api/auth/test-login \
  -H "Content-Type: application/json" \
  -d '{"phoneNumber": "13800000002", "role": "sys_admin"}'
```
响应：✅ 登录成功，返回有效Token

## 修复结果

🎉 **问题已完全解决！**

- ✅ 数据库表结构完整
- ✅ 示例数据已插入
- ✅ 测试管理员用户已创建
- ✅ 服务器正常运行
- ✅ 部门管理员登录功能正常
- ✅ 系统管理员登录功能正常

## 测试凭据

### 部门管理员
- 手机号：`13800000001`
- 角色：`dept_admin`
- 测试登录API：`POST /api/auth/test-login`

### 系统管理员  
- 手机号：`13800000002`
- 角色：`sys_admin`
- 测试登录API：`POST /api/auth/test-login`

## 预防措施

1. **定期数据库备份**：确保数据库结构和数据的完整性
2. **环境一致性检查**：部署前验证数据库表结构是否完整
3. **健康检查监控**：实施应用程序和数据库的健康状态监控
4. **初始化脚本维护**：保持数据库初始化脚本的更新和测试

## 相关文件

- `/scripts/initDatabase-complete.js` - 完整数据库初始化脚本
- `/scripts/create-test-admin.js` - 测试管理员用户创建脚本
- `/config/database.js` - 数据库配置文件
- `/server.js` - 主服务器文件

---

**解决时间：** 2025-08-27 10:03:00  
**解决状态：** ✅ 完成  
**测试状态：** ✅ 通过
